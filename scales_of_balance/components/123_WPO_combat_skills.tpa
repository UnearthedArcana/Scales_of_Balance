
//__________________________________________________________________________________
//__________________________________________________________________________________
//
//						WPO - BROAD CATEGORIES + COMBAT SKILLS
//__________________________________________________________________________________
//__________________________________________________________________________________

/*
- set up prof stats................/
- group weapon profs.............../
- set kit profs to match.........../
- set creature profs.............../
- set up wspecial/wspatck........../
- set up profs/profsmax/weapprof.../
- add skill rank spells............/
- add feat abilities.............../
- add .tra refs..................../
-  add strings to spells.........../
- set up feat group dialogues....../
- ...add WT choice if WtP........../
- set up prof detection............/
- change prof strings............../
- addstuff to cs000................/
- rewrite Bladesinger focus dlg....
- have prof-by-dlg cast cs000......
*/

/*
 ***** left to do:
 /- fix dialogues (probably the scripts are broken)
 /- dialogue innates need names
 /- add ability to cancel postures...?
 /- icons for each posture (and for cancel posture?)
 /- put exceptional conditions (special kits etc.) into dlg scripts
 /- add bonus stuff to cs000
 /- change shield bash
 /- implement grappling
 /- modify class/kit descriptions
 /- add LABELs
 /- add more kits to special handling
 /- stop dialogues from crashing the game
 /- fix magic abilities not giving spells
 /- fix smoke bomb giving grease jar
 /- fix tracking no icon
 /- fix quickstride no icon
 /- fix flaming weapon no icon
 /- apply skills (in stats 104-110, 115-134) to non-joinables
 /- ...and, in fact, to joinables! (just let them change out their profs)
 /- fix cancel postures no name/icon
 /- fix not getting postures
 /- profs tome not removing old profs
 /- also, it disappears when the NPC joins?
 /- if get 2 stars at once, only one dialogue abil? need to rearrange this, like Dodge/Backstab/etc.
 /- make sure NPC_EE can undo anything applied here
 /- ***** stat 134 doesn't seen to work in BG2EE... the pips just disappear afterCharGen! :( :( :( 
 - NPC_EE catch-up dialprof doesn't work
 - cs000 isn't working (fully?) after NPC_EE class-change
 - make nd5_nukt remove the CSP prof book, and undo all cs000 effects, and all op187 effect spells

 ***** maybe find a way to make sure multiclasses don't have cs001 applied twice?
 like, make one version for fighter CLABs, and another for thief CLABs, and put op318 exempting fighter/thieves into the thief version
 have to be careful with triple-classes, but it can probably work.

 - log stat bytes used in a 2da table (or something like that)
 - ...maybe in next release? consult w/ others about best way to do this
 - prob should overwrite swash/archer/assassin descriptions

*/

/*

effects of specialization: 
 - 2: +2 thac0, +1 damage
 - 3: +3 thac0, +3 damage
 - 4: +3 thac0, +3 damage, +.5 APR

effects of attack speed feat:
 - 1: weapon speed bonus
 - 2: +.5 APR -1 thac0 (!)
 - 3: + 1 APR -2 thac0 (!)
 - 4: +1.5 APR -3 thac0 (!)

*/


DEFINE_ACTION_FUNCTION combat_skills_system BEGIN


//copy marker file___________________________________________________________________
//
COPY ~scales_of_balance/lib/markers/d5_marker.d5~ ~override/d5__combat_skills.d5~
//__________________________________________________________________________________


/*
//update stat bits table_____________________________________________________________
//
ACTION_IF !(FILE_EXISTS_IN_GAME ~statbits.2da~) BEGIN
  COPY ~%MOD_FOLDER%/misc/statbits.2da~ ~override~
END

OUTER_SPRINT my_prefix ~d5~

COPY_EXISTING ~statbits.2da~ ~override~
  COUNT_2DA_COLS cols
  READ_2DA_ENTRIES_NOW rows cols
  FOR (row = 1; row < rows; ++row)
    FOR (col = 1; col < cols; ++col)
      READ_2DA_ENTRY_FORMER rows row 0 stat
      READ_2DA_ENTRY_FORMER rows 0 col bit
      READ_2DA_ENTRY_FORMER rows row col this_bit
      PATCH_IF (stat = ) AND (bit = ) BEGIN
        PATCH_IF (this_bit = 0) BEGIN
          SET_2DA_ENTRY row col cols ~%my_prefix%~
        END
        PATCH_IF !(this_bit = 0) BEGIN
          SPRINT this_bit_new ~%this_bit%~^~_%my_prefix%~
          SET_2DA_ENTRY row col cols ~%this_bit_new%~
        END
      END
    END
  END
BUT_ONLY
//__________________________________________________________________________________
*/

//check player settings______________________________________________________________
//
INCLUDE ~scales_of_balance/ini/combat_skills.ini~

//CHECK IF THIEVES CAN USE WANDS_____________________________________________________
//
COPY_EXISTING - ~wand07.itm~ ~override~
  READ_BYTE 0x20 thief_use
//  PATCH_IF (thief_use BAND 0b01000000 = 0b00000000) BEGIN
  PATCH_IF (thief_use BOR 0b10111111 = 0b10111111) BEGIN
    SET thief_use_wands = 1
  END
  ELSE BEGIN
    SET thief_use_wands = 0
  END
BUT_ONLY

//CHECK IF THERE ARE PSIONICS________________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5__psionics.d5~) BEGIN
  OUTER_SET there_is_psionics = 1
END
ELSE BEGIN
  OUTER_SET there_is_psionics = 0
END
//__________________________________________________________________________________


//prep splprot.2da___________________________________________________________________
//
APPEND ~splprot.2da~ ~D5_KIT_IS%TAB%152%TAB%-1%TAB%1~ UNLESS ~D5_KIT_IS~
APPEND ~splprot.2da~ ~D5_KIT_NOT%TAB%152%TAB%-1%TAB%5~ UNLESS ~D5_KIT_NOT~
APPEND ~splprot.2da~ ~D5_115_FEATS%TAB%115%TAB%-1%TAB%8~ UNLESS ~D5_115_FEATS~
//APPEND ~splprot.2da~ ~D5_115_NFEATS%TAB%115%TAB%-1%TAB%9~ UNLESS ~D5_115_NFEATS~

COPY_EXISTING ~splprot.2da~ ~override~
  COUNT_2DA_COLS cols
  READ_2DA_ENTRIES_NOW rows cols
  FOR (row = 1; row < rows; ++row) BEGIN
    READ_2DA_ENTRY_FORMER rows row 0 ~stat~
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_KIT_IS~) BEGIN
	  SET kit_is_row = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_KIT_NOT~) BEGIN
	  SET kit_not_row = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_115_FEATS~) BEGIN
	  SET 115_feats_row = %row%
	END
  END
BUT_ONLY

// check exact bit-equality of proficiencies... 
// there will be false positives, but only in higher values
// 206 should prevent duplicate application of skills

APPEND ~splprot.2da~ ~STAT_104_BEQ%TAB%104%TAB%-1%TAB%7~ UNLESS ~STAT_104_BEQ~
APPEND ~splprot.2da~ ~STAT_105_BEQ%TAB%105%TAB%-1%TAB%7~ UNLESS ~STAT_105_BEQ~
APPEND ~splprot.2da~ ~STAT_106_BEQ%TAB%106%TAB%-1%TAB%7~ UNLESS ~STAT_106_BEQ~
APPEND ~splprot.2da~ ~STAT_107_BEQ%TAB%107%TAB%-1%TAB%7~ UNLESS ~STAT_107_BEQ~
APPEND ~splprot.2da~ ~STAT_108_BEQ%TAB%108%TAB%-1%TAB%7~ UNLESS ~STAT_108_BEQ~
APPEND ~splprot.2da~ ~STAT_109_BEQ%TAB%109%TAB%-1%TAB%7~ UNLESS ~STAT_109_BEQ~
APPEND ~splprot.2da~ ~STAT_110_BEQ%TAB%110%TAB%-1%TAB%7~ UNLESS ~STAT_110_BEQ~
APPEND ~splprot.2da~ ~STAT_111_BEQ%TAB%111%TAB%-1%TAB%7~ UNLESS ~STAT_111_BEQ~
APPEND ~splprot.2da~ ~STAT_112_BEQ%TAB%112%TAB%-1%TAB%7~ UNLESS ~STAT_112_BEQ~
APPEND ~splprot.2da~ ~STAT_113_BEQ%TAB%113%TAB%-1%TAB%7~ UNLESS ~STAT_113_BEQ~
APPEND ~splprot.2da~ ~STAT_114_BEQ%TAB%114%TAB%-1%TAB%7~ UNLESS ~STAT_114_BEQ~
APPEND ~splprot.2da~ ~STAT_115_BEQ%TAB%115%TAB%-1%TAB%7~ UNLESS ~STAT_115_BEQ~
APPEND ~splprot.2da~ ~STAT_124_BEQ%TAB%124%TAB%-1%TAB%7~ UNLESS ~STAT_124_BEQ~
APPEND ~splprot.2da~ ~STAT_127_BEQ%TAB%127%TAB%-1%TAB%7~ UNLESS ~STAT_127_BEQ~
APPEND ~splprot.2da~ ~STAT_134_BEQ%TAB%134%TAB%-1%TAB%7~ UNLESS ~STAT_134_BEQ~

COPY_EXISTING ~splprot.2da~ ~override~
  COUNT_2DA_COLS cols
  READ_2DA_ENTRIES_NOW rows cols
  FOR (row = 1; row < rows; ++row) BEGIN
    READ_2DA_ENTRY_FORMER rows row 0 ~stat~
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~STAT_104_BEQ~) BEGIN
      SET prof_104_beq = %row%
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~STAT_105_BEQ~) BEGIN
      SET prof_105_beq = %row%
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~STAT_106_BEQ~) BEGIN
      SET prof_106_beq = %row%
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~STAT_107_BEQ~) BEGIN
      SET prof_107_beq = %row%
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~STAT_108_BEQ~) BEGIN
      SET prof_108_beq = %row%
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~STAT_109_BEQ~) BEGIN
      SET prof_109_beq = %row%
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~STAT_110_BEQ~) BEGIN
      SET prof_110_beq = %row%
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~STAT_111_BEQ~) BEGIN
      SET prof_111_beq = %row%
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~STAT_112_BEQ~) BEGIN
      SET prof_112_beq = %row%
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~STAT_113_BEQ~) BEGIN
      SET prof_113_beq = %row%
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~STAT_114_BEQ~) BEGIN
      SET prof_114_beq = %row%
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~STAT_115_BEQ~) BEGIN
      SET prof_115_beq = %row%
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~STAT_124_BEQ~) BEGIN
      SET prof_124_beq = %row%
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~STAT_127_BEQ~) BEGIN
      SET prof_127_beq = %row%
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~STAT_134_BEQ~) BEGIN
      SET prof_134_beq = %row%
    END
  END
BUT_ONLY


//check for various kits_____________________________________________________________
//
COPY_EXISTING ~kit.ids~ ~override~
  COUNT_2DA_COLS cols
  READ_2DA_ENTRIES_NOW rows cols
  FOR (row = 1; row < rows; ++row) BEGIN
    READ_2DA_ENTRY_FORMER rows row 0 ~code~
    READ_2DA_ENTRY_FORMER rows row 1 ~kit~
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~D5RBARB~) BEGIN
      SET d5_rbarb_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~D5MARKS~) BEGIN
      SET d5_marksman_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~D5SLING~) BEGIN
      SET d5_slinger_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~D5SNIPE~) BEGIN
      SET d5_sniper_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~D5EARCH~) BEGIN
      SET elven_archer_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~NMRNBSLN~) BEGIN
      SET dr_bowslinger_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~D5CORSA~) BEGIN
      SET d5_corsair_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~D5SHADD~) BEGIN
      SET d5_shadowdancer_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~D5SWASH~) BEGIN
      SET d5_swash_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~IK_BATTLERAGER~) BEGIN
      SET ik_battlerager_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~c0tbm~) BEGIN
      SET c0tbm_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~UB_SH~) BEGIN
      SET ub_sh_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~A7_MARKSMAN~) BEGIN
      SET a7_marksman_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~A7_BOWKNIGHT~) BEGIN
      SET a7_bowknight_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~A7_SHARPSHOOTER~) BEGIN
      SET a7_sharpshooter_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~CDArcSyl~) BEGIN
      SET cdarcsyl_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~c0aa~) BEGIN
      SET c0aa_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~C0ADVENT~) BEGIN
      SET c0advent_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~USAF00~) BEGIN
      SET usaf00_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~USAP00~) BEGIN
      SET usap00_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~USAT00~) BEGIN
      SET usat00_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~D2WARHOUND~) BEGIN
      SET d2warhound_code = %code%
    END
    PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~D2KENSAIZERKER~) BEGIN
      SET d2kensaizerker_code = %code%
    END
  END  
BUT_ONLY

//__________________________________________________________________________________



//__________________________________________________________________________________
//
//								WEAPON CATEGORIES
//__________________________________________________________________________________

/* 
need to finalize what the categories will be

 - 89 = staff
 - 90 = bastard sword + longsword
 - 91 = short sword
 - 92 = axe
 - 93 = greatsword
 - 94 = katana
 - 95 = scimitar
 - 96 = dagger + dart
 - 97 = war hammer
 - 98 = spear + halberd
 - 99 = club + mace
 - 100 = flail
 - 101 = sling
 - 102 = bows
 - 103 = xbow
 - 104 = rapid attack
 - 105 = dodge
 - 106 = backstab
 - 107 = set snares
 - 108 = ranged thac0
 - 109 = hurled thac0 * 
 - 111 = 2HW
 - 112 = SnS
 - 113 = SWS
 - 114 = DW
 - 115 = postures
 - 124 = physical feats **
 - 127 = misc skills *
 - 110 = magical skills *
 
* need to remove any 233 effects applying this stat
** need to remove any 233 effects applying this and maybe also modify scripts

*/

// deal with FnP op181 effects_______________________________________________________
//
OUTER_SET lsword_found = 0
OUTER_SET bsword_found = 0
OUTER_SET dagger_found = 0
OUTER_SET dart_found = 0
OUTER_SET spear_found = 0
OUTER_SET halberd_found = 0
OUTER_SET mace_found = 0
OUTER_SET club_found = 0
COPY_EXISTING_REGEXP GLOB ~.*\.itm~ ~override~
  PATCH_IF ((lsword_found + bsword_found + dagger_found + dart_found + spear_found + halberd_found + mace_found + club_found) < 8) BEGIN
    READ_BYTE 0x31 prof
    READ_BYTE 0x1b spell_weapon 
    PATCH_IF ((~%spell_weapon%~ BOR ~0b11111110~) = ~0b11111110~) BEGIN // if undispellable flag not set
      PATCH_IF (prof = 90) BEGIN
        READ_SHORT 0x1c lsword_type
        SET lsword_found = 1
      END
      PATCH_IF (prof = 89) BEGIN
        READ_SHORT 0x1c bsword_type
        SET bsword_found = 1
      END
      PATCH_IF (prof = 96) BEGIN
        READ_SHORT 0x1c dagger_type
        SET dagger_found = 1
      END
      PATCH_IF (prof = 106) BEGIN
        READ_SHORT 0x1c dart_type
        SET dart_found = 1
      END
      PATCH_IF (prof = 98) BEGIN
        READ_SHORT 0x1c spear_type
        SET spear_found = 1
      END
      PATCH_IF (prof = 99) BEGIN
        READ_SHORT 0x1c halberd_type
        SET halberd_found = 1
      END
      PATCH_IF (prof = 101) BEGIN
        READ_SHORT 0x1c mace_type
        SET mace_found = 1
      END
      PATCH_IF (prof = 115) BEGIN
        READ_SHORT 0x1c club_type
        SET club_found = 1
      END
    END
  END
BUT_ONLY
//___________________________________________________________________________________

// change item profs_________________________________________________________________
//
COPY_EXISTING_REGEXP GLOB ~.*\.itm~ ~override~
  PATCH_IF (SOURCE_SIZE > 0x71) BEGIN
    READ_BYTE 0x31 prof
    READ_BYTE 0x1b spell_weapon 
    PATCH_IF ((~%spell_weapon%~ BOR ~0b11111110~) = ~0b11111110~) BEGIN // if undispellable flag not set
      PATCH_IF (prof = 89) BEGIN
        WRITE_BYTE 0x31 90
		PATCH_IF FILE_EXISTS_IN_GAME ~d5__fnp_usability.d5~ BEGIN
		  WRITE_SHORT 0x1c lsword_type
		END
      END
	  PATCH_IF (prof = 102) BEGIN
	    WRITE_BYTE 0x31 89
	  END
	  PATCH_IF (prof = 106) BEGIN
	    WRITE_BYTE 0x31 96
		PATCH_IF FILE_EXISTS_IN_GAME ~d5__fnp_usability.d5~ BEGIN
		  WRITE_SHORT 0x1c dagger_type
		END
	  END
	  PATCH_IF (prof = 99) BEGIN
	    WRITE_BYTE 0x31 98
		PATCH_IF FILE_EXISTS_IN_GAME ~d5__fnp_usability.d5~ BEGIN
		  WRITE_SHORT 0x1c spear_type
		END
	  END
	  PATCH_IF (prof = 115) BEGIN
	    WRITE_BYTE 0x31 99
		PATCH_IF FILE_EXISTS_IN_GAME ~d5__fnp_usability.d5~ BEGIN
		  WRITE_SHORT 0x1c mace_type
		END
	  END
	  PATCH_IF (prof = 101) BEGIN
	    WRITE_BYTE 0x31 99
		PATCH_IF FILE_EXISTS_IN_GAME ~d5__fnp_usability.d5~ BEGIN
		  WRITE_SHORT 0x1c mace_type
		END
	  END
/* leave morning stars as they were already being treated...?
	  PATCH_IF (prof = 100) BEGIN
		PATCH_IF (anim = 21325) BEGIN // morning star
	      WRITE_BYTE 0x31 93
		  PATCH_IF FILE_EXISTS_IN_GAME ~d5__fnp_usability.d5~ BEGIN
		    WRITE_SHORT 0x1c mace_type
		  END
		END
	  END
*/
	  PATCH_IF (prof = 104) BEGIN
	    WRITE_BYTE 0x31 102
	  END
	  PATCH_IF (prof = 105) BEGIN
	    WRITE_BYTE 0x31 102
	  END
	  PATCH_IF (prof = 107) BEGIN
	    WRITE_BYTE 0x31 101
	  END
    END
  END
BUT_ONLY

OUTER_FOR (u = 1; u < 300; ++u) BEGIN
  ACTION_IF (FILE_EXISTS_IN_GAME ~d5_u%u%.spl~) BEGIN
    COPY_EXISTING ~d5_u%u%.spl~ override
      SPRINT no_use ~_~
      GET_OFFSET_ARRAY ab_array SPL_V10_HEADERS
      PHP_EACH ab_array AS int => ab_off BEGIN
        GET_OFFSET_ARRAY2 fx_array ab_off SPL_V10_HEAD_EFFECTS
        PHP_EACH fx_array AS int => fx_off BEGIN
          READ_SHORT fx_off fx_type
          PATCH_IF (fx_type = 181) BEGIN
			READ_LONG (fx_off + 0x04) exclude_type
			SPRINT no_use ~%no_use%_~^~%exclude_type%~
		  END
		END
	  END
	  PATCH_IF (~%no_use%~ STRING_CONTAINS_REGEXP ~%bsword_type%~ = 1) BEGIN
	    LPF DELETE_EFFECT INT_VAR match_opcode = 181 match_parameter1 = %lsword_type% END
	  END
	  PATCH_IF (~%no_use%~ STRING_CONTAINS_REGEXP ~%dart_type%~ = 1) BEGIN
	    LPF DELETE_EFFECT INT_VAR match_opcode = 181 match_parameter1 = %dagger_type% END
	  END
	  PATCH_IF (~%no_use%~ STRING_CONTAINS_REGEXP ~%halberd_type%~ = 1) BEGIN
	    LPF DELETE_EFFECT INT_VAR match_opcode = 181 match_parameter1 = %spear_type% END
	  END
	  PATCH_IF (~%no_use%~ STRING_CONTAINS_REGEXP ~%club_type%~ = 1) BEGIN
	    LPF DELETE_EFFECT INT_VAR match_opcode = 181 match_parameter1 = %mace_type% END
	  END
	BUT_ONLY
  END
END
//___________________________________________________________________________________

//merge bastard sword > long sword___________________________________________________
//
COPY_EXISTING ~weapprof.2da~ ~override~
	COUNT_2DA_COLS cols
	FOR (col = 4; col < cols; col += 1) BEGIN
	    READ_2DA_ENTRY 8 col cols bastard
	    READ_2DA_ENTRY 9 col cols longsword
	    PATCH_IF (VARIABLE_IS_SET %bastard%) AND (VARIABLE_IS_SET %longsword%) BEGIN
	      PATCH_IF (%bastard% >= %longsword%) BEGIN
	    	  SET_2DA_ENTRY 9 col cols %bastard%
		  END
		END
//	    SET_2DA_ENTRY 9 col cols 0
//	    SET_2DA_ENTRY 12 col cols 0
	END
BUT_ONLY
//__________________________________________________________________________________

//move quarterstaff > 89_____________________________________________________________
//
COPY_EXISTING ~weapprof.2da~ ~override~
	COUNT_2DA_COLS cols
	FOR (col = 4; col < cols; col += 1) BEGIN
	    READ_2DA_ENTRY 8 col cols bastard
	    READ_2DA_ENTRY 22 col cols staff
	    PATCH_IF (VARIABLE_IS_SET %bastard%) AND (VARIABLE_IS_SET %staff%) BEGIN
	      SET_2DA_ENTRY 8 col cols %staff%
	      SET_2DA_ENTRY 22 col cols 0
		END
	END
BUT_ONLY
//__________________________________________________________________________________

//merge darts > daggers_____________________________________________________________
//
COPY_EXISTING ~weapprof.2da~ ~override~
	COUNT_2DA_COLS cols
	FOR (col = 4; col < cols; col += 1) BEGIN
	    READ_2DA_ENTRY 15 col cols dagger
	    READ_2DA_ENTRY 26 col cols darts
	    PATCH_IF (VARIABLE_IS_SET %bastard%) AND (VARIABLE_IS_SET %staff%) BEGIN
	      PATCH_IF (%darts% >= %dagger%) BEGIN
	    	SET_2DA_ENTRY 15 col cols %darts%
		  END
	      SET_2DA_ENTRY 26 col cols 0
		END
	END
BUT_ONLY
//__________________________________________________________________________________

//merge halberds > spears____________________________________________________________
//
COPY_EXISTING ~weapprof.2da~ ~override~
	COUNT_2DA_COLS cols
	FOR (col = 4; col < cols; col += 1) BEGIN
	    READ_2DA_ENTRY 18 col cols spear
	    READ_2DA_ENTRY 19 col cols halberd
	    PATCH_IF (%halberd% >= %spear%) BEGIN
	    	SET_2DA_ENTRY 18 col cols %halberd%
		END
	    SET_2DA_ENTRY 19 col cols 0
	END
BUT_ONLY
//__________________________________________________________________________________

//move club + mace > 99______________________________________________________________
//
COPY_EXISTING ~weapprof.2da~ ~override~
	COUNT_2DA_COLS cols
	FOR (col = 4; col < cols; col += 1) BEGIN
	    READ_2DA_ENTRY 17 col cols club
	    READ_2DA_ENTRY 19 col cols halberd
	    READ_2DA_ENTRY 21 col cols mace
	    PATCH_IF (%club% >= %mace%) BEGIN
	    	SET_2DA_ENTRY 19 col cols %club%
		END
	    PATCH_IF (%mace% >= %club%) BEGIN
	    	SET_2DA_ENTRY 19 col cols %mace%
		END
/* keep this in case decide to include morning stars
	    READ_2DA_ENTRY 17 col cols club
	    READ_2DA_ENTRY 20 col cols flail
	    READ_2DA_ENTRY 21 col cols mace
	    PATCH_IF (%flail% >= %mace%) BEGIN
	      PATCH_IF (%flail% >= %club%) BEGIN
	    	SET_2DA_ENTRY 12 col cols %flail%
	      END
	      PATCH_IF (%club% >= %flail%) BEGIN
	    	SET_2DA_ENTRY 12 col cols %club%
	      END
		END
	    PATCH_IF (%mace% >= %hammer%) BEGIN
	      PATCH_IF (%mace% >= %club%) BEGIN
	    	SET_2DA_ENTRY 12 col cols %mace%
	      END
	      PATCH_IF (%club% >= %mace%) BEGIN
	    	SET_2DA_ENTRY 12 col cols %club%
	      END
		END
*/
	    SET_2DA_ENTRY 17 col cols 0
	    SET_2DA_ENTRY 21 col cols 0
	END
BUT_ONLY
//__________________________________________________________________________________

//move longbow + shortbow > 102______________________________________________________
//
COPY_EXISTING ~weapprof.2da~ ~override~
	COUNT_2DA_COLS cols
	FOR (col = 4; col < cols; col += 1) BEGIN
	    READ_2DA_ENTRY 22 col cols staff
	    READ_2DA_ENTRY 24 col cols longbow
	    READ_2DA_ENTRY 25 col cols shortbow
	    PATCH_IF (%longbow% >= %shortbow%) BEGIN
	    	SET_2DA_ENTRY 22 col cols %longbow%
		END
	    PATCH_IF (%shortbow% >= %longbow%) BEGIN
	    	SET_2DA_ENTRY 22 col cols %shortbow%
		END
	    SET_2DA_ENTRY 24 col cols 0
	    SET_2DA_ENTRY 25 col cols 0
	END
BUT_ONLY
//__________________________________________________________________________________

//move sling > 101___________________________________________________________________
//
COPY_EXISTING ~weapprof.2da~ ~override~
	COUNT_2DA_COLS cols
	FOR (col = 4; col < cols; col += 1) BEGIN
	    READ_2DA_ENTRY 21 col cols mace
	    READ_2DA_ENTRY 27 col cols sling
	    PATCH_IF (VARIABLE_IS_SET %mace%) AND (VARIABLE_IS_SET %sling%) BEGIN
	      SET_2DA_ENTRY 21 col cols %sling%
	      SET_2DA_ENTRY 27 col cols 0
		END
	END
BUT_ONLY
//__________________________________________________________________________________

//handle creatures___________________________________________________________________
//
COPY_EXISTING_REGEXP GLOB ~^.+\.cre$~ ~override~
  LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 233 match_parameter2 = 89 parameter2 = 90 END

  LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 233 match_parameter2 = 102 parameter2 = 89 END

  LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 233 match_parameter2 = 106 parameter2 = 96 END
  LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 233 match_parameter2 = 99 parameter2 = 98 END

  LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 233 match_parameter2 = 101 parameter2 = 99 END

  LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 233 match_parameter2 = 115 parameter2 = 99 END
  LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 233 match_parameter2 = 104 parameter2 = 102 END
  LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 233 match_parameter2 = 105 parameter2 = 102 END

  LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 233 match_parameter2 = 107 parameter2 = 101 END
IF_EXISTS BUT_ONLY
//__________________________________________________________________________________
	


// there. now there are 4 free proficiencies to use for skills. plus 108, and 134.
// then steal 110, 124, and 127 from DS and we have 9 proficiencies for combat skills

//free up stat 109___________________________________________________________________
//
COPY_EXISTING_REGEXP GLOB ~^.+\.spl$~ ~override~
  GET_OFFSET_ARRAY ab_array SPL_V10_HEADERS
  SET remove_this = 0
  PHP_EACH ab_array AS int => ab_off BEGIN
	GET_OFFSET_ARRAY2 fx_array ab_off SPL_V10_HEAD_EFFECTS
	PHP_EACH fx_array AS int => fx_off BEGIN
	  READ_SHORT fx_off fx_type
	  READ_SHORT (fx_off + 0x08) fx_prof
	  PATCH_IF (fx_type = 233) AND (fx_prof = 109) BEGIN
	    SET remove_this = 1
	  END
	END
  END
  PATCH_IF (remove_this = 1) BEGIN
    LPF DELETE_EFFECT INT_VAR match_opcode = 233 match_parameter2 = (109 + (0x10000 * 1)) END
    LPF DELETE_EFFECT INT_VAR match_opcode = 233 match_parameter2 = 109 END
  END
BUT_ONLY

COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
  GET_OFFSET_ARRAY ab_array ITM_V10_HEADERS
  PHP_EACH ab_array AS int => ab_off BEGIN
	GET_OFFSET_ARRAY2 fx_array ab_off ITM_V10_HEAD_EFFECTS
	PHP_EACH fx_array AS int => fx_off BEGIN
	  READ_SHORT fx_off fx_type
	  READ_SHORT (fx_off + 0x08) fx_prof
	  PATCH_IF (fx_type = 233) AND (fx_prof = 109) BEGIN
	    SET remove_this = 1
	  END
	END
  END
  PATCH_IF (remove_this = 1) BEGIN
    LPF DELETE_EFFECT INT_VAR match_opcode = 233 match_parameter2 = (109 + (0x10000 * 1)) END
    LPF DELETE_EFFECT INT_VAR match_opcode = 233 match_parameter2 = 109 END
  END
BUT_ONLY

//__________________________________________________________________________________

//free up stat 110___________________________________________________________________
//
COPY_EXISTING_REGEXP GLOB ~^.+\.spl$~ ~override~
  GET_OFFSET_ARRAY ab_array SPL_V10_HEADERS
  SET remove_this = 0
  PHP_EACH ab_array AS int => ab_off BEGIN
	GET_OFFSET_ARRAY2 fx_array ab_off SPL_V10_HEAD_EFFECTS
	PHP_EACH fx_array AS int => fx_off BEGIN
	  READ_SHORT fx_off fx_type
	  READ_SHORT (fx_off + 0x08) fx_prof
	  PATCH_IF (fx_type = 233) AND (fx_prof = 110) BEGIN
	    SET remove_this = 1
	  END
	END
  END
  PATCH_IF (remove_this = 1) BEGIN
    LPF DELETE_EFFECT INT_VAR match_opcode = 233 match_parameter2 = (110 + (0x10000 * 1)) END
    LPF DELETE_EFFECT INT_VAR match_opcode = 233 match_parameter2 = 110 END
  END
BUT_ONLY

COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
  GET_OFFSET_ARRAY ab_array ITM_V10_HEADERS
  PHP_EACH ab_array AS int => ab_off BEGIN
	GET_OFFSET_ARRAY2 fx_array ab_off ITM_V10_HEAD_EFFECTS
	PHP_EACH fx_array AS int => fx_off BEGIN
	  READ_SHORT fx_off fx_type
	  READ_SHORT (fx_off + 0x08) fx_prof
	  PATCH_IF (fx_type = 233) AND (fx_prof = 110) BEGIN
	    SET remove_this = 1
	  END
	END
  END
  PATCH_IF (remove_this = 1) BEGIN
    LPF DELETE_EFFECT INT_VAR match_opcode = 233 match_parameter2 = (110 + (0x10000 * 1)) END
    LPF DELETE_EFFECT INT_VAR match_opcode = 233 match_parameter2 = 110 END
  END
BUT_ONLY

//__________________________________________________________________________________

//free up stat 124___________________________________________________________________
//
LAF d5_resolve_state STR_VAR new_state_id = ~CLERIC_REGENERATION~ RET new_state_ind END
OUTER_SET regeneration_state = %new_state_ind%

COPY_EXISTING_REGEXP GLOB ~^.+\.spl$~ ~override~
  GET_OFFSET_ARRAY ab_array SPL_V10_HEADERS
  SET remove_this = 0
  PHP_EACH ab_array AS int => ab_off BEGIN
	GET_OFFSET_ARRAY2 fx_array ab_off SPL_V10_HEAD_EFFECTS
	PHP_EACH fx_array AS int => fx_off BEGIN
	  READ_SHORT fx_off fx_type
	  READ_SHORT (fx_off + 0x08) fx_prof
	  PATCH_IF (fx_type = 233) AND (fx_prof = 124) BEGIN
	    SET remove_this = 1
	  END
	END
  END
  PATCH_IF (remove_this = 1) BEGIN
//    LPF DELETE_EFFECT INT_VAR match_opcode = 233 match_parameter2 = (124 + (0x10000 * 1)) END
//    LPF DELETE_EFFECT INT_VAR match_opcode = 233 match_parameter2 = 124 END
    LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 233 match_parameter2 = (124 + (0x10000 * 1)) opcode = 328 parameter2 = %regeneration_state% special = 1 END
    LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 233 match_parameter2 = 124 opcode = 328 parameter2 = %regeneration_state% special = 1 END
  END
BUT_ONLY

COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
  GET_OFFSET_ARRAY ab_array ITM_V10_HEADERS
  PHP_EACH ab_array AS int => ab_off BEGIN
	GET_OFFSET_ARRAY2 fx_array ab_off ITM_V10_HEAD_EFFECTS
	PHP_EACH fx_array AS int => fx_off BEGIN
	  READ_SHORT fx_off fx_type
	  READ_SHORT (fx_off + 0x08) fx_prof
	  PATCH_IF (fx_type = 233) AND (fx_prof = 124) BEGIN
	    SET remove_this = 1
	  END
	END
  END
  PATCH_IF (remove_this = 1) BEGIN
//    LPF DELETE_EFFECT INT_VAR match_opcode = 233 match_parameter2 = (124 + (0x10000 * 1)) END
//    LPF DELETE_EFFECT INT_VAR match_opcode = 233 match_parameter2 = 124 END
    LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 233 match_parameter2 = (124 + (0x10000 * 1)) opcode = 328 parameter2 = %regeneration_state% special = 1 END
    LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 233 match_parameter2 = 124 opcode = 328 parameter2 = %regeneration_state% special = 1 END
  END
BUT_ONLY

// also remove from scripts

OUTER_SPRINT reg_params "[-0-9]+ [-0-9]+ 124"
COPY_EXISTING_REGEXP ".+\.bcs" "override"
  PATCH_IF (INDEX_BUFFER("^TR[%WNL%]1645[23] %reg_params%") >= 0) BEGIN  // CheckStat() and CheckStatGT()
    DECOMPILE_AND_PATCH BEGIN
      REPLACE_TEXTUALLY ~CheckStat(Myself,1,CLERIC_REGENERATION)~ ~CheckSpellState(Myself,CLERIC_REGENERATION)~
      REPLACE_TEXTUALLY ~CheckStatGT(Myself,0,CLERIC_REGENERATION)~ ~CheckSpellState(Myself,CLERIC_REGENERATION)~
    END
  END
BUT_ONLY

//__________________________________________________________________________________

//free up stat 127___________________________________________________________________
//
COPY_EXISTING_REGEXP GLOB ~^.+\.spl$~ ~override~
  GET_OFFSET_ARRAY ab_array SPL_V10_HEADERS
  SET remove_this = 0
  PHP_EACH ab_array AS int => ab_off BEGIN
	GET_OFFSET_ARRAY2 fx_array ab_off SPL_V10_HEAD_EFFECTS
	PHP_EACH fx_array AS int => fx_off BEGIN
	  READ_SHORT fx_off fx_type
	  READ_SHORT (fx_off + 0x08) fx_prof
	  PATCH_IF (fx_type = 233) AND (fx_prof = 127) BEGIN
	    SET remove_this = 1
	  END
	END
  END
  PATCH_IF (remove_this = 1) BEGIN
    LPF DELETE_EFFECT INT_VAR match_opcode = 233 match_parameter2 = (127 + (0x10000 * 1)) END
    LPF DELETE_EFFECT INT_VAR match_opcode = 233 match_parameter2 = 127 END
  END
BUT_ONLY

COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
  GET_OFFSET_ARRAY ab_array ITM_V10_HEADERS
  PHP_EACH ab_array AS int => ab_off BEGIN
	GET_OFFSET_ARRAY2 fx_array ab_off ITM_V10_HEAD_EFFECTS
	PHP_EACH fx_array AS int => fx_off BEGIN
	  READ_SHORT fx_off fx_type
	  READ_SHORT (fx_off + 0x08) fx_prof
	  PATCH_IF (fx_type = 233) AND (fx_prof = 127) BEGIN
	    SET remove_this = 1
	  END
	END
  END
  PATCH_IF (remove_this = 1) BEGIN
    LPF DELETE_EFFECT INT_VAR match_opcode = 233 match_parameter2 = (127 + (0x10000 * 1)) END
    LPF DELETE_EFFECT INT_VAR match_opcode = 233 match_parameter2 = 127 END
  END
BUT_ONLY
//__________________________________________________________________________________



//__________________________________________________________________________________
//
//								SET UP 2DA FILES
//__________________________________________________________________________________


//COPY ~%MOD_FOLDER%/csp/backstab.2da~ ~override~
COPY_EXISTING ~backstab.2da~ ~override~
  COUNT_2DA_COLS cols
  COUNT_2DA_ROWS cols rows
  FOR (row = 0; row < rows; ++row) BEGIN
    FOR (col = 1; col < cols; ++col) BEGIN
      SET_2DA_ENTRY row col cols 1
    END
  END
IF_EXISTS BUT_ONLY

COPY ~%MOD_FOLDER%/csp/wspecial.2da~ ~override~

COPY ~%MOD_FOLDER%/csp/wspatck.2da~ ~override~

COPY ~%MOD_FOLDER%/csp/profs.2da~ ~override~

COPY ~%MOD_FOLDER%/csp/profsmax.2da~ ~override~

// LOTSof stuff to do in weapprof.2da________________________________________________
//
// get everyone on the 4-point system
COPY_EXISTING ~weapprof.2da~ ~override~
  COUNT_2DA_COLS cols
  REPLACE_TEXTUALLY ~[ %TAB%]ID[ %TAB%]~ ~ D5TYPE ID ~
  REPLACE_TEXTUALLY ~[ %TAB%]5 ~ ~ 4 ~
  REPLACE_TEXTUALLY ~[ %TAB%]4 ~ ~ 3 ~
//  REPLACE_TEXTUALLY ~[ %TAB%]3 ~ ~ 4 ~
  REPLACE_TEXTUALLY ~[ %TAB%]2 ~ ~ 3 ~
  REPLACE_TEXTUALLY ~[ %TAB%]1 ~ ~ 2 ~
  FOR (row = 3; row < 11; ++row) BEGIN
    FOR (col = 4; col < cols; ++col) BEGIN
      SET_2DA_ENTRY_LATER ~#weapprof~ row col 0
    END
  END
  FOR (row = 7; row < 30; ++row) BEGIN
    READ_2DA_ENTRY row 1 5 stat
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~102~) BEGIN
      READ_2DA_ENTRY row 2 5 staff_weapon_name
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~107~) BEGIN
      READ_2DA_ENTRY row 2 5 sling_weapon_name
    END
  END
// mages
  SET_2DA_ENTRY_LATER ~#weapprof~ 18 4 1
  SET_2DA_ENTRY_LATER ~#weapprof~ 20 4 1
  SET_2DA_ENTRY_LATER ~#weapprof~ 25 4 1
  SET_2DA_ENTRY_LATER ~#weapprof~ 26 4 1
  SET_2DA_ENTRY_LATER ~#weapprof~ 30 4 1
// no need to set individual kits, because the class maxes are the kit maxes
// ***** wait. shit. is that right? no. why does the WPO have mage kits commented out?
// formatting fixes
  SET_2DA_ENTRY_LATER ~#weapprof~ 4 1 1
  SET_2DA_ENTRY_LATER ~#weapprof~ 5 1 2
  SET_2DA_ENTRY_LATER ~#weapprof~ 6 1 3
  SET_2DA_ENTRY_LATER ~#weapprof~ 8 1 5
  SET_2DA_ENTRIES_NOW ~#weapprof~ 1
  REPLACE_TEXTUALLY ~D5TYPE ~ ~%TAB%%TAB%%TAB%%TAB%%TAB%%TAB%~

// arrange the rows to reflect the CS system
COPY_EXISTING ~weapprof.2da~ ~override~
//  COUNT_2DA_COLS cols
  COUNT_2DA_ROWS 5 rows
  FOR (row = 7; row < rows; ++row) BEGIN
    READ_2DA_ENTRY row 1 5 stat
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~115~) BEGIN
      SET remove_row = row
    END
  END
  REMOVE_2DA_ROW remove_row 5
  INSERT_2DA_ROW 32 3 ~CLUB                     115                      25009                    25033                    0 ~
  INSERT_2DA_ROW 28 3 ~EXTRA1                   109                      4294967296               4294967296               0 ~
  INSERT_2DA_ROW 28 3 ~EXTRA0                   108                      4294967296               4294967296               0 ~
BUT_ONLY

APPEND ~weapprof.2da~ ~EXTRA1                   110                      4294967296               4294967296               0 ~

// fill out the three new rows with 0
COPY_EXISTING ~weapprof.2da~ ~override~
  COUNT_2DA_COLS cols
  COUNT_2DA_ROWS 5 rows
  FOR (row = 3; row < rows; ++row) BEGIN
    READ_2DA_ENTRY row 1 5 stat
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~108~) OR (~%stat%~ STRING_EQUAL_CASE ~109~) OR (~%stat%~ STRING_EQUAL_CASE ~110~) OR (~%stat%~ STRING_EQUAL_CASE ~115~) BEGIN
      FOR (ind = 1; ind < (cols - 4); ++ind) BEGIN
        SET_2DA_ENTRY row 4 5 ~0                        0~
      END
    END
  END

ACTION_DEFINE_ASSOCIATIVE_ARRAY kits_classes BEGIN
  MAGE => 1
  FIGHTER => 2
  CLERIC => 3
  THIEF => 4
  BARD => 5
  PALADIN => 6
  DRUID => 11
  RANGER => 12
  FIGHTER_MAGE => 7
  FIGHTER_CLERIC => 8
  FIGHTER_THIEF => 9
  FIGHTER_MAGE_THIEF => 10
  MAGE_THIEF => 13
  CLERIC_MAGE => 14
  CLERIC_THIEF => 15
  FIGHTER_DRUID => 16
  FIGHTER_MAGE_CLERIC => 17
  CLERIC_RANGER => 18
  SORCERER => 19
  MONK => 20
  SHAMAN => 21
END

COPY_EXISTING ~kitlist.2da~ ~override~
  COUNT_2DA_ROWS 9 rows
  FOR (row = 1; row < rows; ++row) BEGIN
    READ_2DA_ENTRY row 1 9 kitname
    READ_2DA_ENTRY row 8 9 classnum
    SPRINT $kits_classes(~%kitname%~)~%classnum%~
  END
BUT_ONLY

// rename row headers and apply class defaults for new skills
COPY_EXISTING ~weapprof.2da~ ~override~
  COUNT_2DA_COLS cols
  COUNT_2DA_ROWS 5 rows
  FOR (row = 7; row < rows; ++row) BEGIN
    READ_2DA_ENTRY row 1 5 stat
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~89~) BEGIN
      SET_2DA_ENTRY row 0 5 ~QUARTERSTAFF~
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~95~) BEGIN
      SET_2DA_ENTRY row 0 5 ~SCIMITAR                ~
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~99~) BEGIN
      SET_2DA_ENTRY row 0 5 ~CLUBMACE~
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~100~) BEGIN
      SET_2DA_ENTRY row 0 5 ~FLAIL           ~
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~101~) BEGIN
      SET_2DA_ENTRY row 0 5 ~SLING~
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~102~) BEGIN
      SET_2DA_ENTRY row 0 5 ~BOWS        ~
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~103~) BEGIN
      SET_2DA_ENTRY row 0 5 ~CROSSBOW~
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~104~) BEGIN
      SET_2DA_ENTRY row 0 5 ~ATTACKSPEED~
      SET speed_row = (row + 2)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~105~) BEGIN
      SET_2DA_ENTRY row 0 5 ~DODGE   ~
      SET dodge_row = (row + 2)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~106~) BEGIN
      SET_2DA_ENTRY row 0 5 ~BACKSTAB~
      SET backstab_row = (row + 2)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~107~) BEGIN
      SET_2DA_ENTRY row 0 5 ~SNARES~
      SET snares_row = (row + 2)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~108~) BEGIN
      SET_2DA_ENTRY row 0 5 ~ACCURACY~
      SET ranged_row = (row + 2)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~109~) BEGIN
      SET_2DA_ENTRY row 0 5 ~HURLING~
      SET hurling_row = (row + 2)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~110~) BEGIN
      SET_2DA_ENTRY row 0 5 ~MAGICSKILLS~
      SET magic_row = (row + 2)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~115~) BEGIN
      SET_2DA_ENTRY row 0 5 ~POSTURES~
      SET postures_row = (row + 2)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~124~) BEGIN
      SET_2DA_ENTRY row 0 5 ~HEALTH~
      SET health_row = (row + 2)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~127~) BEGIN
      SET_2DA_ENTRY row 0 5 ~MISCSKILLS~
      SET misc_row = (row + 2)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~134~) BEGIN
      SET_2DA_ENTRY row 0 5 ~POOPSHIT~
      SET poop_row = (row + 2)
    END
  END
  READ_2DA_ENTRIES_NOW ~r2en_csp~ (cols - 1)
  FOR (col = 3; col < (cols - 1); col += 1) BEGIN
    READ_2DA_ENTRY_FORMER ~r2en_csp~ 0 col kitname
    PHP_EACH kits_classes AS kit => class BEGIN
      PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~%kitname%~) BEGIN
        PATCH_IF (%class% = 1) BEGIN										//	mage
          SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    0
          SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    0
          SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 0
          SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  1
          SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 0
          SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     2
          SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
        END
        PATCH_IF (%class% = 2) BEGIN										//	fighter
          SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    4
          SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 0
          SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  2
          SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 4
          SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   6
          SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     4
          SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
        END
        PATCH_IF (%class% = 3) BEGIN										//	cleric
          SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 0
          SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  2
          SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 0
          SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     2
          SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
        END
        PATCH_IF (%class% = 4) BEGIN										//	thief
          SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 4
          SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   4
          SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  2
          SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 2
          SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     7
          SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    7
        END
        PATCH_IF (%class% = 5) BEGIN										//	bard
          SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 0
          SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  2
          SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 2
          SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   4
          SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     4
          SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
        END
        PATCH_IF (%class% = 6) BEGIN										//	paladin
          SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    4
          SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 0
          SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  2
          SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 4
          SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   4
          SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     4
          SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
        END
        PATCH_IF (%class% = 11) BEGIN										//	druid
          SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 0
          SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  2
          SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 0
          SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     2
          SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
        END
        PATCH_IF (%class% = 12) BEGIN										//	ranger
          SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    4
          SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 1
          SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  2
          SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 4
          SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   4
          SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     4
          SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
        END
        PATCH_IF (%class% = 7) BEGIN										//	f/m
          SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    4
          SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 0
          SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  2
          SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 4
          SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   4
          SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     4
          SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
        END
        PATCH_IF (%class% = 8) BEGIN										//	f/c
          SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    4
          SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 0
          SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  2
          SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 4
          SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   4
          SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     2
          SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
        END
        PATCH_IF (%class% = 9) BEGIN										//	f/t
          SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    4
          SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 4
          SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  2
          SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 4
          SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   4
          SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     7
          SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    7
        END
        PATCH_IF (%class% = 10) BEGIN										//	f/m/t
          SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    4
          SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 4
          SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  2
          SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 4
          SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   4
          SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     4
          SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
        END
        PATCH_IF (%class% = 13) BEGIN										//	m/t
          SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 4
          SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   4
          SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  2
          SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 2
          SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     4
          SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
        END
        PATCH_IF (%class% = 14) BEGIN										//	c/m
          SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 0
          SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  2
          SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 0
          SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     2
          SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
        END
        PATCH_IF (%class% = 15) BEGIN										//	c/t
          SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 4
          SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   4
          SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  2
          SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 2
          SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     6
          SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
        END
        PATCH_IF (%class% = 16) BEGIN										//	f/d
          SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    4
          SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 0
          SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  2
          SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 4
          SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   4
          SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     4
          SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
        END
        PATCH_IF (%class% = 17) BEGIN										//	f/m/c
          SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    4
          SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 0
          SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  2
          SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 4
          SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   4
          SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     4
          SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
        END
        PATCH_IF (%class% = 18) BEGIN										//	c/r
          SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    4
          SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 0
          SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  2
          SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 4
          SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   4
          SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     4
          SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
        END
        PATCH_IF (%class% = 19) BEGIN										//	sorcerer
          SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    0
          SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    0
          SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 0
          SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  1
          SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 0
          SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     2
          SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
        END
        PATCH_IF (%class% = 20) BEGIN										//	monk
          SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    0
          SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 0
          SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  2
          SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 4
          SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   4
          SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     2
          SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
        END
        PATCH_IF (%class% = 21) BEGIN										//	shaman
          SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    2
          SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 0
          SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   2
          SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  2
          SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 0
          SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   0
          SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     2
          SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
        END
      END
    END
  END
  SET_2DA_ENTRIES_NOW ~s2el_csp~ 1
  SET_2DA_ENTRY 0 0 5 ~                      ID~
BUT_ONLY

// go back over and apply exceptions to the default values
COPY_EXISTING ~weapprof.2da~ ~override~
  COUNT_2DA_COLS cols
  READ_2DA_ENTRIES_NOW ~r2en_csp~ (cols - 1)
  FOR (row = 7; row < rows; ++row) BEGIN
    READ_2DA_ENTRY row 1 5 stat
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~104~) BEGIN
      SET speed_row = (row + 2)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~105~) BEGIN
      SET dodge_row = (row + 2)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~106~) BEGIN
      SET backstab_row = (row + 2)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~107~) BEGIN
      SET snares_row = (row + 2)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~108~) BEGIN
      SET ranged_row = (row + 2)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~109~) BEGIN
      SET hurling_row = (row + 2)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~110~) BEGIN
      SET magic_row = (row + 2)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~115~) BEGIN
      SET postures_row = (row + 2)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~124~) BEGIN
      SET health_row = (row + 2)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~127~) BEGIN
      SET misc_row = (row + 2)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~134~) BEGIN
      SET poop_row = (row + 2)
    END
  END
  FOR (col = 3; col < (cols - 1); col += 1) BEGIN
    READ_2DA_ENTRY_FORMER ~r2en_csp~ 0 col kitname
// only need to do exceptions
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~BERSERKER~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    0
      SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   0
      SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  0
      SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     0
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~KENSAI~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   0
      SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  0
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~IK_BATTLERAGER~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    0
      SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   0
      SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  0
      SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     0
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~c0tbm~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    0
      SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   0
      SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  0
      SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     0
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~D2KENSAIZERKER~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    0
      SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   0
      SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  0
      SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     0
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~CAVALIER~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   0
      SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  0
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~FERALAN~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   6
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~STALKER~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 2
      SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   0
      SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    4
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~ASSASIN~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 6
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~SWASHBUCKLER~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    3
      SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    6
      SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 0
      PATCH_IF !(FILE_EXISTS_IN_GAME ~d5swash.2da~) BEGIN
        SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   0
      END
      PATCH_IF (FILE_EXISTS_IN_GAME ~d5swash.2da~) BEGIN
        SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   4
      END
      PATCH_IF (FILE_EXISTS_IN_GAME ~d5_rake.2da~) BEGIN
        SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 2
      END
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~D5SWASH~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    3
      SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    6
      SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 4
      SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 3
      SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   0
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~D5_RAKE~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    3
      SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    4
      SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 2
      SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   2
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~SHADOWDANCER~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 2
      SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    5
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~D5SHADD~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 2
      SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    5
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~D5NINJA_T~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~D5NINJA_F~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~BLADE~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    3
      SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    4
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~bladetw~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    3
      SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    4
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~C#WARDOG~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   0
      SET_2DA_ENTRY_LATER ~s2el_csp~ hurling_row (col + 1)  0
      SET_2DA_ENTRY_LATER ~s2el_csp~ postures_row (col + 1) 0
      SET_2DA_ENTRY_LATER ~s2el_csp~ health_row (col + 1)   6
      SET_2DA_ENTRY_LATER ~s2el_csp~ misc_row (col + 1)     0
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~NMRNFRRN~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    4
      SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   1
      SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   4
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~NMRNWLRN~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    4
      SET_2DA_ENTRY_LATER ~s2el_csp~ snares_row (col + 1)   1
      SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   4
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~A!ACROBAT~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    4
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~D5EARCH~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   6
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~D5ARCHF~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   6
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~D5SLING~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   6
      SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 2
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~D5MARKS~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ ranged_row (col + 1)   6
      SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 2
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~D5_BARD~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 2
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~D5_BLADE~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ speed_row (col + 1)    3
      SET_2DA_ENTRY_LATER ~s2el_csp~ dodge_row (col + 1)    4
      SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 2
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~D5_MEISTER~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 2
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~D5_JINXER~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 2
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~D5_ELEGIST~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 2
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~D5_LORESINGER_CT~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 2
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~D5_HERALD~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    4
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~D5_WHISTLER~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
      SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 2
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~D5RANTHIEF~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ magic_row (col + 1)    0
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~D5_PSION~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 2
    END
    PATCH_IF (~%kitname%~ STRING_EQUAL_CASE ~D5_PSION_MENU~) BEGIN
      SET_2DA_ENTRY_LATER ~s2el_csp~ backstab_row (col + 1) 2
    END
  END
  SET_2DA_ENTRIES_NOW ~s2el_csp~ 1
  SET_2DA_ENTRY 0 0 5 ~                ID~
BUT_ONLY



//__________________________________________________________________________________
//
//								IMPROVABLE SKILLS
//__________________________________________________________________________________


//attack speed_______________________________________________________________________
//
COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs104a.spl~		//			weapon speed
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 190 parameter1 = 2 timing = 9 END
//  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 233 parameter1 = (1 << 8) parameter2 = (104 + (0x10000 * 1)) timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs104a~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs104a~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs104b.spl~		//			APR bonus
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 1 parameter1 = 6 parameter2 = 0 timing = 9 END
/* or should this permanently *set* base APR...?
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 1 parameter1 = 7 parameter2 = 1 timing = 1 END
*/
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 278 parameter1 = (0 - 1) parameter2 = 0 timing = 9 END
//  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 233 parameter1 = (2 << 8) parameter2 = (104 + (0x10000 * 1)) timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs104b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs104b~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs104c.spl~		//			APR bonus
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 1 parameter1 = 1 parameter2 = 0 timing = 9 END
/* or should this permanently *set* base APR...?
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 1 parameter1 = 2 parameter2 = 1 timing = 1 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs104b~ END
*/
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 278 parameter1 = (0 - 1) parameter2 = 0 timing = 9 END
//  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 233 parameter1 = (4 << 8) parameter2 = (104 + (0x10000 * 1)) timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs104c~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs104c~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs104b~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs104d.spl~		//			APR bonus
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 1 parameter1 = 7 parameter2 = 0 timing = 9 END
/* or should this permanently *set* base APR...?
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 1 parameter1 = 8 parameter2 = 1 timing = 1 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs104c~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs104b~ END
*/
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 278 parameter1 = (0 - 1) parameter2 = 0 timing = 9 END
//  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 233 parameter1 = (8 << 8) parameter2 = (104 + (0x10000 * 1)) timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs104d~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs104d~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs104c~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs104b~ END

// ***** what are those op233 effects for...? ^^

//dodge______________________________________________________________________________
//
COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs105a.spl~		//			AC bonus
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 0 parameter1 = 1 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs105a~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs105a~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs105b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 0 parameter1 = 2 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs105a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs105b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs105b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs105a~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs105c.spl~	
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 0 parameter1 = 3 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs105a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs105b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs105c~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs105c~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs105b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs105a~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs105d.spl~	
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 0 parameter1 = 4 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs105a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs105b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs105c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs105d~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs105d~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs105c~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs105b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs105a~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs105e.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 0 parameter1 = 5 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs105a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs105b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs105c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs105d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs105e~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs105e~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs105d~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs105c~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs105b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs105a~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs105f.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 0 parameter1 = 6 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs105a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs105b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs105c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs105d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs105e~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs105f~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs105f~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs105e~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs105d~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs105c~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs105b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs105a~ END


//backstab___________________________________________________________________________
//
COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs106a.spl~		//			backstab bonus
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 263 parameter1 = 1 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106a~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106a~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs106b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 263 parameter1 = 2 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106a~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs106c.spl~	
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 263 parameter1 = 3 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106c~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106c~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106a~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs106d.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 263 parameter1 = 4 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106d~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106d~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106c~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106a~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs106e.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 263 parameter1 = 5 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106e~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106e~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106d~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106c~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106a~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs106f.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 263 parameter1 = 6 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106e~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106f~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106f~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106e~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106d~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106c~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106a~ END

/*
COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs106g.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 263 parameter1 = 7 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106e~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106f~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs106g~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106g~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106f~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106e~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106d~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106c~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs106a~ END
*/


//set snares_________________________________________________________________________
//
COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs107a.spl~		//			set snares
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~spcl412~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0x400B parameter2 = 9 timing = 1 STR_VAR resource = ~d5cs107s~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs107a~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs107b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~spcl412~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0x400B parameter2 = 9 timing = 1 STR_VAR resource = ~d5cs107s~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs107b~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs107c.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~spcl412~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0x400B parameter2 = 9 timing = 1 STR_VAR resource = ~d5cs107s~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs107c~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs107d.spl~	
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~spcl412~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0x400B parameter2 = 9 timing = 1 STR_VAR resource = ~d5cs107s~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs107d~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs107e.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~spcl412~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0x400B parameter2 = 9 timing = 1 STR_VAR resource = ~d5cs107s~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs107e~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs107f.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~spcl412~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0x400B parameter2 = 9 timing = 1 STR_VAR resource = ~d5cs107s~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs107f~ END

 CREATE EFF ~d5cs107s~
	WRITE_LONG 0x10 171
	WRITE_LONG 0x14 1
	WRITE_LONG 0x24 1
	WRITE_SHORT 0x2c 100
	WRITE_ASCII 0x30 ~SPCL414~ #8


//ranged thac0_______________________________________________________________________
//
COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs108a.spl~		//			ranged thac0
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 167 parameter1 = 1 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 286 parameter1 = 1 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs108a~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs108a~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs108b.spl~	
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 167 parameter1 = 2 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 286 parameter1 = 2 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs108a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs108b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs108b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs108a~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs108c.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 167 parameter1 = 3 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 286 parameter1 = 3 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs108a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs108b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs108c~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs108c~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs108b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs108a~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs108d.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 167 parameter1 = 4 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 286 parameter1 = 4 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs108a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs108b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs108c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs108d~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs108d~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs108c~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs108b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs108a~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs108e.spl~	
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 167 parameter1 = 5 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 286 parameter1 = 5 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs108a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs108b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs108c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs108d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs108e~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs108e~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs108d~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs108c~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs108b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs108a~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs108f.spl~	
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 167 parameter1 = 6 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 286 parameter1 = 6 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs108a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs108b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs108c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs108d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs108e~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs108f~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs108f~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs108e~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs108d~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs108c~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs108b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs108a~ END



//hurled thac0_______________________________________________________________________
//
COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs109a.spl~		//			hurled thac0
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~D5CZ109A~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~D5CZ109D~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs109a~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs109a~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs109b.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~D5CZ109B~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~D5CZ109E~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs109b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs109b~ END

/*
COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs109c.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~D5CZ109C~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cs109c~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs109c~ END
*/

CREATE EFF ~d5cz109a~
	WRITE_LONG 0x10 167
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c (0 - 2)
	WRITE_LONG 0x20 0
	WRITE_LONG 0x24 2
	WRITE_LONG 0x28 0
	WRITE_SHORT 0x2c 100
	WRITE_LONG 0x90 1
	WRITE_EVALUATED_ASCII 0x94 ~D5CZ109A~ #8
CREATE EFF ~d5cz109b~
	WRITE_LONG 0x10 167
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c (0 - 2)
	WRITE_LONG 0x20 0
	WRITE_LONG 0x24 2
	WRITE_LONG 0x28 0
	WRITE_SHORT 0x2c 100
	WRITE_LONG 0x90 1
	WRITE_EVALUATED_ASCII 0x94 ~D5CZ109B~ #8
CREATE EFF ~d5cz109c~
	WRITE_LONG 0x10 167
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c (0 - 2)
	WRITE_LONG 0x20 0
	WRITE_LONG 0x24 2
	WRITE_LONG 0x28 0
	WRITE_SHORT 0x2c 100
	WRITE_LONG 0x90 1
	WRITE_EVALUATED_ASCII 0x94 ~D5CZ109C~ #8
CREATE EFF ~d5cz109d~
	WRITE_LONG 0x10 1
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c (0 - 6)
	WRITE_LONG 0x20 0
	WRITE_LONG 0x24 2
	WRITE_LONG 0x28 0
	WRITE_SHORT 0x2c 100
	WRITE_LONG 0x90 1
	WRITE_EVALUATED_ASCII 0x94 ~D5CZ109D~ #8
CREATE EFF ~d5cz109e~
	WRITE_LONG 0x10 1
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c (0 - 6)
	WRITE_LONG 0x20 0
	WRITE_LONG 0x24 2
	WRITE_LONG 0x28 0
	WRITE_SHORT 0x2c 100
	WRITE_LONG 0x90 1
	WRITE_EVALUATED_ASCII 0x94 ~D5CZ109E~ #8

COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
  SET thrown_weap = 0
  READ_BYTE 0x31 prof
  PATCH_IF (prof = 92) OR (prof = 96) OR (prof = 97) BEGIN
    GET_OFFSET_ARRAY ab_array ITM_V10_HEADERS
    PHP_EACH ab_array AS int => ab_off BEGIN
      READ_BYTE ab_off ab_type
      READ_SHORT (ab_off + 0x14) ab_thac0
      PATCH_IF (ab_type = 2) BEGIN
        SET thrown_weap = 1
        WRITE_SHORT (ab_off + 0x14) (ab_thac0 + 1)
	  END
	END
  END
  PATCH_IF (thrown_weap = 1) BEGIN
    LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 2 STR_VAR resource = ~d5cz109a~ END
    LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 2 STR_VAR resource = ~d5cz109b~ END
//    LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 2 STR_VAR resource = ~d5cz109c~ END
    LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 2 STR_VAR resource = ~d5cz109d~ END
    LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 2 STR_VAR resource = ~d5cz109e~ END
  END
BUT_ONLY

//__________________________________________________________________________________



//__________________________________________________________________________________
//
//								DIALOGUE SKILLS
//__________________________________________________________________________________


ACTION_FOR_EACH letr IN ~a~ ~b~ ~c~ ~d~ ~e~ ~f~ ~g~ BEGIN

//fighting postures__________________________________________________________________

 COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs115%letr%.spl~		//			
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = EVAL ~d5c115%letr%~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = EVAL ~d5cs115%letr%~ END

//physical feats_____________________________________________________________________

 COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs124%letr%.spl~		//			
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = EVAL ~d5c124%letr%~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = EVAL ~d5cs124%letr%~ END

//miscellaneous skills_______________________________________________________________

 COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs127%letr%.spl~		//			
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = EVAL ~d5c127%letr%~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = EVAL ~d5cs127%letr%~ END

//magical skills_____________________________________________________________________

 COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs110%letr%.spl~		//			
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = EVAL ~d5c110%letr%~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = EVAL ~d5cs110%letr%~ END

END
//__________________________________________________________________________________




//__________________________________________________________________________________
//
//								FIGHTING POSTURES
//__________________________________________________________________________________


//fighting postures__________________________________________________________________
//
// leadership, grapple, parry damage types, missile snaring, fighting dirty, spell evasion
//
// need to make switchable fighting postures actually work!
//
// d5csp1 = leadership
// d5csp2 = grappling
// d5csp3 = precise strike
// d5csp4 = parry slashing
// d5csp5 = parry piercing
// d5csp6 = parry blunt
// d5csp7 = missile snaring
// d5csp8 = fighting dirty
// d5csp9 = spell evasion

/*
make spell_1 with 146 effects, casting 9 206 spells
cast spell_1 when stat 115 is *
apply perm 206 vs spell_1 from... 

EDIT - no, change this to mimic the way MnG bard songs work!
...so, these are just bard songs I guess. :(
*/

OUTER_SET nada = RESOLVE_STR_REF (~ ~)

ACTION_IF !(FILE_EXISTS_IN_GAME ~7eyes.2da~) BEGIN
  COPY ~%MOD_FOLDER%/csp/7eyes.2da~ ~override~
END

COPY ~%MOD_FOLDER%/csp/d5cx115.bam~ ~override~

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cx115.spl~					//		cancel postures
  SAY NAME1 @12197
  SAY UNIDENTIFIED_DESC @12197
  WRITE_ASCII 0x3a ~d5cx115~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5cx115~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 172 timing = 1 STR_VAR resource = ~d5cx115~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csp1a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csp2a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csp3a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csp4a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csp5a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csp6a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csp7a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csp8a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csp9a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp1g~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp2g~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp3g~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp4g~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp5g~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp6g~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp7g~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp8g~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp9g~ END

/*
COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5c115b.spl~					//		206 vs. all postures
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp1b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp2b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp3b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp4b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp5b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp6b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp7b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp8b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp9b~ END
*/

ACTION_FOR_EACH lrn_spl IN ~1~ ~2~ ~3~ ~4~ ~5~ ~6~ ~7~ ~8~ ~9~ BEGIN		//		each 206 / 171
 COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cxp%lrn_spl%b.spl~	
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = EVAL ~d5cxp%lrn_spl%g~ END
//  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = EVAL ~d5cxp%lrn_spl%~ END
 COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cxp%lrn_spl%g.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = EVAL ~d5csp%lrn_spl%~ END
 COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cxp%lrn_spl%l.spl~
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = EVAL ~d5cxp%lrn_spl%b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = EVAL ~d5cxp%lrn_spl%b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 4 duration = 1 STR_VAR resource = ~d5cx115~ /*EVAL ~d5cxp%lrn_spl%g~*/ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~d5csp%lrn_spl%~ END

 CREATE EFF  ~d5csp%lrn_spl%~
	WRITE_LONG 0x10 187
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 1
	WRITE_LONG 0x20 0
	WRITE_LONG 0x24 9
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0xa8 ~D5CSP%lrn_spl%~ #32
	WRITE_LONG 0x90 1
	WRITE_EVALUATED_ASCII 0x94 ~d5csp%lrn_spl%~ #8

END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/csp/d5csp1.bam~ ~override~

COPY_EXISTING ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp1.spl~			//			leadership
  SAY NAME1 @12011
  SAY UNIDENTIFIED_DESC @12012
  WRITE_ASCII 0x3a ~d5csp1~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5csp1~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp1a~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~d5cx115~ END
IF_EXISTS BUT_ONLY

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp1a.spl~					//		leadership effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 0 duration = 126144000 STR_VAR resource = ~d5csp1a~ END

CREATE EFF ~d5csp1a~
	WRITE_LONG 0x10 232
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 0
	WRITE_LONG 0x20 20
	WRITE_LONG 0x24 9
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~d5csp1b~ #8
	WRITE_LONG 0x48 102

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp1b.spl~					//		leadership external
  LPF ALTER_SPELL_HEADER INT_VAR target = 1 PROJECTILE = 158 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 6 opcode = 321 timing = 1 STR_VAR resource = ~d5csp1b~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 6 opcode = 0 parameter1 = 1 parameter2 = 0 timing = 0 duration = 7 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 6 opcode = 278 parameter1 = 1 parameter2 = 0 timing = 0 duration = 7 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 6 opcode = 189 parameter1 = 1 parameter2 = 0 timing = 0 duration = 7 END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/csp/d5csp2.bam~ ~override~

ADD_PROJECTILE ~scales_of_balance/csp/d5csp2.pro~

COPY_EXISTING ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp2.spl~			//			grappling
  SAY NAME1 @12013
  SAY UNIDENTIFIED_DESC @12014
  WRITE_ASCII 0x3a ~d5csp2~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5csp2~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp2a~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~d5cx115~ END
IF_EXISTS BUT_ONLY

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp2a.spl~					//		grappling effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 0 duration = 126144000 STR_VAR resource = ~d5csp2a~ END

CREATE EFF ~d5csp2a~
	WRITE_LONG 0x10 232
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 2
	WRITE_LONG 0x20 7
	WRITE_LONG 0x24 0
	WRITE_LONG 0x28 126144000
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~d5csp2b~ #8

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp2b.spl~					//		grappling effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 1 range = 255 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 9 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp2c~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp2c.spl~					//		grappling effect
  LPF ALTER_SPELL_HEADER INT_VAR type = 1 target = 1 range = 3 projectile = %d5csp2% END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 45 target = 2 timing = 0 duration = 1 savingthrow = 16 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 176 target = 2 parameter2 = 1 timing = 0 duration = 3 savingthrow = 16 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 40 target = 2 timing = 0 duration = 6 savingthrow = 16 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 0 target = 2 parameter1 = (0 - 4) timing = 0 duration = 6 savingthrow = 16 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 278 target = 2 parameter1 = (0 - 4) timing = 0 duration = 6 savingthrow = 16 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 9 parameter1 = 0 parameter2 = 2 timing = 0 duration = 2 savingthrow = 16 STR_VAR resource = ~d5csp2c~ END

/*
CREATE EFF ~d5csp2c~
	WRITE_LONG 0x10 176
	WRITE_LONG 0x14 9
	WRITE_LONG 0x1c 0
	WRITE_LONG 0x20 1
	WRITE_LONG 0x24 0
	WRITE_LONG 0x28 2
	WRITE_SHORT 0x2c 100
*/
CREATE EFF ~d5csp2c~
	WRITE_LONG 0x10 50
	WRITE_LONG 0x14 9
	WRITE_LONG 0x1c 26368
	WRITE_SHORT 0x20 2
	WRITE_BYTE 0x23 20
	WRITE_LONG 0x24 0
	WRITE_LONG 0x28 126144000
	WRITE_SHORT 0x2c 100

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/csp/d5csp3.bam~ ~override~

COPY_EXISTING ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp3.spl~			//			precise strike
  SAY NAME1 @12015
  SAY UNIDENTIFIED_DESC @12016
  WRITE_ASCII 0x3a ~d5csp3~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5csp3~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp3a~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~d5cx115~ END
IF_EXISTS BUT_ONLY

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp3a.spl~					//		precise strike effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 301 target = 1 parameter1 = 1 parameter2 = 0 timing = 0 duration = 126144000 END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/csp/d5csp4.bam~ ~override~

COPY_EXISTING ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp4.spl~			//			parry slashing
  SAY NAME1 @12017
  SAY UNIDENTIFIED_DESC @12018
  WRITE_ASCII 0x3a ~d5csp4~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5csp4~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp4a~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~d5cx115~ END
IF_EXISTS BUT_ONLY

LAF d5_resolve_state STR_VAR new_state_id = ~D5_PARRYSLASH~ RET new_state_ind END
OUTER_SET parry_slashing_state = %new_state_ind%

APPEND ~7eyes.2da~ ~PARRY_SLASH  %parry_slashing_state%         %nada%         12*0x1000000 *           *           *            *            *          *          *          * ~ UNLESS ~PARRY_SLASH~

COPY_EXISTING ~7eyes.2da~ ~override~
  COUNT_2DA_ROWS 1 rows
  FOR (row = 1; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 0 1 tag
	PATCH_IF (~%tag%~ STRING_EQUAL_CASE ~PARRY_SLASH~) BEGIN
	  SET parry_slashing_row = row
	END
  END
BUT_ONLY

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp4a.spl~					//		parry slashing effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 0 duration = 126144000 STR_VAR resource = ~d5csp4a~ END

CREATE EFF  ~d5csp4a~
	WRITE_LONG 0x10 232
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 0
	WRITE_LONG 0x20 20
	WRITE_LONG 0x24 9
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~D5CSP4b~ #8
	WRITE_LONG 0x48 102

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp4b.spl~
  PATCH_IF (IS_AN_INT %parry_slashing_row%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 335 target = 1 parameter1 = %parry_slashing_state% parameter2 = %parry_slashing_row% timing = 0 duration = 5 END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5csp4b~ END
  END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/csp/d5csp5.bam~ ~override~

COPY_EXISTING ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp5.spl~			//			parry piercing
  SAY NAME1 @12019
  SAY UNIDENTIFIED_DESC @12020
  WRITE_ASCII 0x3a ~d5csp5~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5csp5~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp5a~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~d5cx115~ END
IF_EXISTS BUT_ONLY

LAF d5_resolve_state STR_VAR new_state_id = ~D5_PARRYPIERCE~ RET new_state_ind END
OUTER_SET parry_piercing_state = %new_state_ind%

APPEND ~7eyes.2da~ ~PARRY_PIERCE  %parry_piercing_state%         %nada%        12*0x100000  *           *           *            *            *          *          *          * ~ UNLESS ~PARRY_PIERCE~

COPY_EXISTING ~7eyes.2da~ ~override~
  COUNT_2DA_ROWS 1 rows
  FOR (row = 1; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 0 1 tag
	PATCH_IF (~%tag%~ STRING_EQUAL_CASE ~PARRY_PIERCE~) BEGIN
	  SET parry_piercing_row = row
	END
  END
BUT_ONLY

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp5a.spl~					//		parry piercing effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 0 duration = 126144000 STR_VAR resource = ~d5csp5a~ END

CREATE EFF  ~d5csp5a~
	WRITE_LONG 0x10 232
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 0
	WRITE_LONG 0x20 20
	WRITE_LONG 0x24 9
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~d5csp5b~ #8
	WRITE_LONG 0x48 102

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp5b.spl~
  PATCH_IF (IS_AN_INT %parry_piercing_row%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 335 target = 1 parameter1 = %parry_piercing_state% parameter2 = %parry_piercing_row% timing = 0 duration = 5 END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5csp5b~ END
  END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/csp/d5csp6.bam~ ~override~

COPY_EXISTING ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp6.spl~			//			parry blunt
  SAY NAME1 @12021
  SAY UNIDENTIFIED_DESC @12022
  WRITE_ASCII 0x3a ~d5csp6~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5csp6~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp6a~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~d5cx115~ END
IF_EXISTS BUT_ONLY

LAF d5_resolve_state STR_VAR new_state_id = ~D5_PARRYBLUNT~ RET new_state_ind END
OUTER_SET parry_crushing_state = %new_state_ind%

APPEND ~7eyes.2da~ ~PARRY_BLUNT  %parry_crushing_state%         %nada%         12*0        *           *           *            *            *          *          *          * ~ UNLESS ~PARRY_BLUNT~

COPY_EXISTING ~7eyes.2da~ ~override~
  COUNT_2DA_ROWS 1 rows
  FOR (row = 1; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 0 1 tag
	PATCH_IF (~%tag%~ STRING_EQUAL_CASE ~PARRY_BLUNT~) BEGIN
	  SET parry_crushing_row = row
	END
  END
BUT_ONLY

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp6a.spl~					//		parry blunt effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 0 duration = 126144000 STR_VAR resource = ~d5csp6a~ END

CREATE EFF  ~d5csp6a~
	WRITE_LONG 0x10 232
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 0
	WRITE_LONG 0x20 20
	WRITE_LONG 0x24 9
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~D5CSP6b~ #8
	WRITE_LONG 0x48 102

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp6b.spl~
  PATCH_IF (IS_AN_INT %parry_crushing_row%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 335 target = 1 parameter1 = %parry_crushing_state% parameter2 = %parry_crushing_row% timing = 0 duration = 5 END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5csp6b~ END
  END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/csp/d5csp7.bam~ ~override~

COPY_EXISTING ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp7.spl~			//			missile snaring
  SAY NAME1 @12023
  SAY UNIDENTIFIED_DESC @12024
  WRITE_ASCII 0x3a ~d5csp7~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5csp7~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp7a~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~d5cx115~ END
IF_EXISTS BUT_ONLY

LAF d5_resolve_state STR_VAR new_state_id = ~D5_SNAREARROW~ RET new_state_ind END
OUTER_SET missile_snaring_state = %new_state_ind%

APPEND ~7eyes.2da~ ~SNARE_ARROW  %missile_snaring_state%         %nada%        12*0x800000 *           *           *            *            *          *          *          * ~ UNLESS ~SNARE_ARROW~

COPY_EXISTING ~7eyes.2da~ ~override~
  COUNT_2DA_ROWS 1 rows
  FOR (row = 1; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 0 1 tag
	PATCH_IF (~%tag%~ STRING_EQUAL_CASE ~SNARE_ARROW~) BEGIN
	  SET missile_snaring_row = row
	END
  END
BUT_ONLY

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp7a.spl~					//		missile snaring effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 0 duration = 126144000 STR_VAR resource = ~d5csp7a~ END

CREATE EFF  ~d5csp7a~
	WRITE_LONG 0x10 232
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 0
	WRITE_LONG 0x20 20
	WRITE_LONG 0x24 9
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~D5CSP7b~ #8
	WRITE_LONG 0x48 102

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp7b.spl~
  PATCH_IF (IS_AN_INT %missile_snaring_row%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 335 target = 1 parameter1 = %missile_snaring_state% parameter2 = %missile_snaring_row% timing = 0 duration = 5 END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5csp7b~ END
  END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/csp/d5csp8.bam~ ~override~

COPY_EXISTING ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp8.spl~			//			fighting dirty
  SAY NAME1 @12025
  SAY UNIDENTIFIED_DESC @12026
  WRITE_ASCII 0x3a ~d5csp8~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5csp8~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp8a~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~d5cx115~ END
IF_EXISTS BUT_ONLY

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp8a.spl~				//			fighting dirty effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 248 target = 1 timing = 0 duration = 126144000 STR_VAR resource = ~d5csp8b~ END

CREATE EFF  ~d5csp8b~
	WRITE_LONG 0x10 146
	WRITE_LONG 0x14 2
	WRITE_LONG 0x1c 0
	WRITE_LONG 0x20 1
	WRITE_LONG 0x24 1
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~D5CSP8b~ #8

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp8b.spl~				//			fighting dirty effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 1 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 2 parameter1 = 0 parameter2 = 2 timing = 0 duration = 6 probability1 = 33 probability2 = 0 STR_VAR resource = ~d5csp8c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 2 parameter1 = 0 parameter2 = 2 timing = 0 duration = 6 probability1 = 33 probability2 = 0 STR_VAR resource = ~d5csp8d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 283 target = 2 parameter1 = 0 parameter2 = 2 timing = 0 duration = 6 probability1 = 66 probability2 = 34 STR_VAR resource = ~d5csp8e~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 283 target = 2 parameter1 = 0 parameter2 = 2 timing = 0 duration = 6 probability1 = 66 probability2 = 34 STR_VAR resource = ~d5csp8f~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 283 target = 2 parameter1 = 0 parameter2 = 2 timing = 0 duration = 6 probability1 = 100 probability2 = 67 STR_VAR resource = ~d5csp8g~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 283 target = 2 parameter1 = 0 parameter2 = 2 timing = 0 duration = 6 probability1 = 100 probability2 = 67 STR_VAR resource = ~d5csp8h~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 2 parameter1 = (0 - 1) timing = 0 duration = 7 STR_VAR resource = ~d5csp8b~ END

CREATE EFF  ~d5csp8c~
	WRITE_LONG 0x10 74
	WRITE_LONG 0x14 2
	WRITE_LONG 0x1c 0
	WRITE_LONG 0x20 0
	WRITE_LONG 0x24 0
	WRITE_LONG 0x28 6
	WRITE_SHORT 0x2c 100

CREATE EFF  ~d5csp8d~
	WRITE_LONG 0x10 24
	WRITE_LONG 0x14 2
	WRITE_LONG 0x1c 0
	WRITE_LONG 0x20 1
	WRITE_LONG 0x24 0
	WRITE_LONG 0x28 3
	WRITE_SHORT 0x2c 100

CREATE EFF  ~d5csp8e~
	WRITE_LONG 0x10 39
	WRITE_LONG 0x14 2
	WRITE_LONG 0x1c 0
	WRITE_LONG 0x20 1
	WRITE_LONG 0x24 0
	WRITE_LONG 0x28 6
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~D5CSP8b~ #8

CREATE EFF  ~d5csp8f~
	WRITE_LONG 0x10 40
	WRITE_LONG 0x14 2
	WRITE_LONG 0x1c 0
	WRITE_LONG 0x20 0
	WRITE_LONG 0x24 0
	WRITE_LONG 0x28 3
	WRITE_SHORT 0x2c 100

CREATE EFF  ~d5csp8g~
	WRITE_LONG 0x10 44
	WRITE_LONG 0x14 2
	WRITE_LONG 0x1c 6
	WRITE_LONG 0x20 1
	WRITE_LONG 0x24 0
	WRITE_LONG 0x28 6
	WRITE_SHORT 0x2c 100

CREATE EFF  ~d5csp8h~
	WRITE_LONG 0x10 250
	WRITE_LONG 0x14 2
	WRITE_LONG 0x1c (0 - 5)
	WRITE_LONG 0x20 0
	WRITE_LONG 0x24 0
	WRITE_LONG 0x28 6
	WRITE_SHORT 0x2c 100


/* why not just apply a melee hit effect, casting spell_A, which has three effects applying eff_B/C/D...? 

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp8a.spl~				//			fighting dirty effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 233 parameter1 = (4 << 24) parameter2 = (115 + (0x10000 * 1)) timing = 0 duration = 126144000 END

COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
  PATCH_IF (~%SOURCE_SIZE%~ > ~0x71~) BEGIN
	READ_BYTE 0x31 prof
	PATCH_IF (%prof% = 89) || (%prof% = 90) || (%prof% = 91) || (%prof% = 92) || (%prof% = 93) || (%prof% = 94) || (%prof% = 95) || (%prof% = 96) || (%prof% = 97) || (%prof% = 98) || (%prof% = 99) || (%prof% = 100) BEGIN	// any melee weapon
	  LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 248 target = 1 timing = 2 resist_dispel = 0 STR_VAR resource = ~d5csp8b~ END
	END
  END
BUT_ONLY

CREATE EFF  ~d5csp8b~
	WRITE_LONG 0x10 232
	WRITE_LONG 0x14 2
	WRITE_LONG 0x1c 0
	WRITE_LONG 0x20 1
	WRITE_LONG 0x24 1
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~D5CSP8b~ #8

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp8b.spl~					//		fighting dirty hit effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 1 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 9 parameter1 = (4 << 24) parameter2 = %115_feats_row% timing = 1 probability1 = 33 probability2 = 0 STR_VAR resource = ~d5csp8c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 9 parameter1 = (4 << 24) parameter2 = %115_feats_row% timing = 1 probability1 = 66 probability2 = 34 STR_VAR resource = ~d5csp8d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 9 parameter1 = (4 << 24) parameter2 = %115_feats_row% timing = 1 probability1 = 100 probability2 = 67 STR_VAR resource = ~d5csp8e~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp8c.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 1 END
//  [blind]
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 24 target = 2 parameter2 = 1 timing = 0 duration = 2 savingthrow = 2 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 74 target = 2 timing = 0 duration = 6 savingthrow = 2 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 12 STR_VAR resource = ~d5csp8c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 6 STR_VAR resource = ~d5csp8d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 6 STR_VAR resource = ~d5csp8e~ END
COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp8d.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 1 END
//  [knockdown]
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 39 target = 2 parameter2 = 1 timing = 0 duration = 3 savingthrow = 2 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 40 target = 2 timing = 0 duration = 2 savingthrow = 2 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 6 STR_VAR resource = ~d5csp8c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 12 STR_VAR resource = ~d5csp8d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 6 STR_VAR resource = ~d5csp8e~ END
COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp8e.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 1 END
//  [weakness]
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 250 target = 2 parameter1 = (0 - 5) timing = 0 duration = 6 savingthrow = 2 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 24 target = 2 parameter1 = 7 parameter2 = 1 timing = 0 duration = 6 savingthrow = 2 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 6 STR_VAR resource = ~d5csp8c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 6 STR_VAR resource = ~d5csp8d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 12 STR_VAR resource = ~d5csp8e~ END
*/

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/csp/d5csp9.bam~ ~override~

COPY_EXISTING ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp9.spl~			//			spell evasion
  SAY NAME1 @12027
  SAY UNIDENTIFIED_DESC @12028
  WRITE_ASCII 0x3a ~d5csp9~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5csp9~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp9a~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~d5cx115~ END
IF_EXISTS BUT_ONLY

OUTER_SET optional_evade = 1
INCLUDE ~%MOD_FOLDER%/lib/spell_evasion.tpa~

ACTION_PHP_EACH evade_spells AS evadable_spell => val BEGIN
  ACTION_IF (%val% = 1) BEGIN
    LAF add_evade_spell INT_VAR evasion_spellstate = 252 evasion_save = 2 STR_VAR evade_ext = ~spl~ evade_res = EVAL ~%evadable_spell%~ evade_prefix = ~D5EV~ END
  END
END
ACTION_PHP_EACH evade_items AS evadable_item => val BEGIN
  ACTION_IF (%val% = 1) BEGIN
    LAF add_evade_spell INT_VAR evasion_spellstate = 252 evasion_save = 2 STR_VAR evade_ext = ~itm~ evade_res = EVAL ~%evadable_item%~ evade_prefix = ~D5EV~ END
  END
END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp9a.spl~					//		spell evasion effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 328 target = 1 special = 1 parameter2 = 252 timing = 0 duration = 126144000 END

//__________________________________________________________________________________

ACTION_FOR_EACH po_spl IN ~1~ ~2~ ~3~ ~4~ ~5~ ~6~ ~7~ ~8~ ~9~ BEGIN			//		set up posture spells
  COPY_EXISTING ~d5csp%po_spl%.spl~ ~override~
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = ~d5csp1~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = ~d5csp2~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = ~d5csp3~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = ~d5csp4~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = ~d5csp5~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = ~d5csp6~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = ~d5csp7~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = ~d5csp8~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = ~d5csp9~ END
  IF_EXISTS BUT_ONLY
END

//__________________________________________________________________________________



//__________________________________________________________________________________
//
//								PHYSICAL FEATNESS
//__________________________________________________________________________________


//physical fitness___________________________________________________________________
//
// quickstride, health, toughness, intestinal fortitude, unflagging determination
//
// d5csf1 = health
// d5csf2 = toughness
// d5csf3 = resistance
// d5csf4 = quickstride
// d5csf5 = fortitude
// d5csf6 = determination
// d5csf7 = STR training
// d5csf8 = DEX training


ACTION_FOR_EACH app_spl IN ~1~ ~2~ ~3~ ~4~ ~5~ ~6~ ~7~ ~8~ BEGIN			//		each feat

  COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csf%app_spl%l.spl~
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 duration = 0 STR_VAR resource = EVAL ~d5csf%app_spl%~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~d5csf%app_spl%~ END
  IF_EXISTS BUT_ONLY

  CREATE EFF  ~d5csf%app_spl%~
	WRITE_LONG 0x10 187
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 1
	WRITE_LONG 0x20 0
	WRITE_LONG 0x24 9
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0xa8 ~D5CSF%app_spl%~ #32
	WRITE_LONG 0x90 1
	WRITE_EVALUATED_ASCII 0x94 ~d5csf%app_spl%~ #8

END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csf1.spl~				//			health conditioning
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 18 target = 1 parameter1 = 7 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs~ END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csf2.spl~				//			toughness
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 86 target = 1 parameter1 = 10 parameter2 = 0 timing = 0 duration = 126144000 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 87 target = 1 parameter1 = 10 parameter2 = 0 timing = 0 duration = 126144000 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 88 target = 1 parameter1 = 10 parameter2 = 0 timing = 0 duration = 126144000 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 89 target = 1 parameter1 = 10 parameter2 = 0 timing = 0 duration = 126144000 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csf2~ END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csf3.spl~				//			resistance
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 28 target = 1 parameter1 = 10 parameter2 = 0 timing = 0 duration = 126144000 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 29 target = 1 parameter1 = 10 parameter2 = 0 timing = 0 duration = 126144000 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 30 target = 1 parameter1 = 10 parameter2 = 0 timing = 0 duration = 126144000 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 84 target = 1 parameter1 = 10 parameter2 = 0 timing = 0 duration = 126144000 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 85 target = 1 parameter1 = 10 parameter2 = 0 timing = 0 duration = 126144000 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csf3~ END

//__________________________________________________________________________________

LAM d5_quickstride_speed

COPY ~%MOD_FOLDER%/csp/d5strid.bam~ ~override~
COPY ~%MOD_FOLDER%/csp/d5swalk.bam~ ~override~

COPY_EXISTING ~d5csf4l.spl~ ~override~
  LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 146 opcode = 171 parameter2 = 0 STR_VAR /*match_resource = ~d5csf4~*/ resource = ~d5strid~ END
BUT_ONLY

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5strid.spl~) BEGIN
 COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5strid.spl~				//			quickstride
  SAY NAME1 @12195
  SAY UNIDENTIFIED_DESC @12195
  WRITE_ASCII 0x3a ~d5strid~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5strid~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 4 duration = 1 STR_VAR resource = ~d5swalk~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 172 target = 1 timing = 1 duration = 0 STR_VAR resource = ~d5strid~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 176 parameter1 = %d5_quickstride_bonus% parameter2 = 0 timing = 0 duration = 126144000 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (2 << 24) parameter2 = (115 + (0x10000 * 1)) timing = 0 duration = 126144000 END

 COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5swalk.spl~				//			slowstride
  SAY NAME1 @12196
  SAY UNIDENTIFIED_DESC @12196
  WRITE_ASCII 0x3a ~d5swalk~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5swalk~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 4 duration = 1 STR_VAR resource = ~d5strid~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 172 target = 1 timing = 1 duration = 0 STR_VAR resource = ~d5swalk~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5strid~ END
  PATCH_IF (FILE_EXISTS_IN_GAME ~spcl813.spl~) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~spcl813~ END
  END
  PATCH_IF (FILE_EXISTS_IN_GAME ~qdmnk02~) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~qdmnk02~ END
  END
  PATCH_IF (FILE_EXISTS_IN_GAME ~qdmnk03~) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~qdmnk03~ END
  END

 OUTER_SET speed_item_ind = 0
 OUTER_SPRINT $speed_boost_items(~%speed_item_ind%~) ~speed_boost_item~
 COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
  PATCH_IF (%SOURCE_SIZE% > 0x71) BEGIN
	READ_BYTE 0x18 flags
	PATCH_IF (flags BOR 0b11111011 = 0b11111111) BEGIN 	//	droppable flag
  	  SET speed_boost = 0
	  READ_LONG 0x6a effectsoffset ELSE 0
	  READ_SHORT 0x70 effectscount ELSE 0
	  FOR (effcyc = 0; effcyc < effectscount; effcyc = effcyc + 1) BEGIN
		READ_SHORT (effectsoffset + (effcyc * 0x30)) opcode ELSE 0
		READ_SHORT (effectsoffset + (effcyc * 0x30)) + 0x04 param1 ELSE 0
		PATCH_IF (opcode = 126) && (param1 > 0) BEGIN
		  SET speed_boost = 1
		END
	  END
	  PATCH_IF (speed_boost = 1) BEGIN
		SPRINT $speed_boost_items(~%speed_item_ind%~) ~%SOURCE_RES%~
		SET ++speed_item_ind
	  END
	END
  END
 BUT_ONLY
 ACTION_PHP_EACH speed_boost_items AS ind => speed_item BEGIN
  COPY_EXISTING ~%speed_item%.itm~ ~override~
	LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 24) parameter2 = %115_feats_row% timing = 1 STR_VAR resource = EVAL ~d5swalk~ END
	LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 2 STR_VAR resource = ~d5strid~ END
  IF_EXISTS BUT_ONLY
 END
END

//__________________________________________________________________________________

LAF d5_resolve_state STR_VAR new_state_id = ~D5_POISONEVADE~ RET new_state_ind END
OUTER_SET poison_evasion_state = %new_state_ind%

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csf5.spl~				//			intestinal fortitude
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 328 target = 1 parameter2 = %poison_evasion_state% timing = 9 special = 1 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csf5~ END

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5poisev.2da~) BEGIN
<<<<<<<< d5/d5poisev.2da
2DA V1.0 
RES
>>>>>>>> 
 COPY ~d5/d5poisev.2da~ ~override/d5poisev.2da~ 
 COPY_EXISTING_REGEXP GLOB ~^.+\.spl$~ ~override~
  GET_OFFSET_ARRAY ab_array SPL_V10_HEADERS
  PHP_EACH ab_array AS int => ab_off BEGIN
	GET_OFFSET_ARRAY2 fx_array ab_off SPL_V10_HEAD_EFFECTS
	PHP_EACH fx_array AS int => fx_off BEGIN
	  READ_SHORT fx_off fx_type
	  PATCH_IF fx_type = 25 BEGIN 							// poison
		PATCH_IF !(~%SOURCE_RES%~ STRING_EQUAL_CASE ~SPPR722~) && !(~%SOURCE_RES%~ STRING_EQUAL_CASE ~SPWI714~) BEGIN
//		  PATCH_PRINT "%SOURCE_RES% is a poison spell"
		  INNER_ACTION BEGIN
			APPEND ~d5poisev.2da~ ~%SOURCE_RES% 	SPL~ UNLESS ~%SOURCE_RES%~
		  END
		END
	  END
	  PATCH_IF fx_type = 12 BEGIN 							// damage (poison)
    	READ_SHORT fx_off + 0xa damage_type
		PATCH_IF damage_type = 32 BEGIN
		  PATCH_IF !(~%SOURCE_RES%~ STRING_EQUAL_CASE ~SPPR722~) && !(~%SOURCE_RES%~ STRING_EQUAL_CASE ~SPWI714~) BEGIN
//			PATCH_PRINT "%SOURCE_RES% is a poison spell"
			INNER_ACTION BEGIN
			  APPEND ~d5poisev.2da~ ~%SOURCE_RES% 	SPL~ UNLESS ~%SOURCE_RES%~
			END
		  END
		END
	  END
	  PATCH_IF fx_type = 78 BEGIN 							// disease
//		  PATCH_PRINT "%SOURCE_RES% is a disease spell"
		  INNER_ACTION BEGIN
			APPEND ~d5poisev.2da~ ~%SOURCE_RES% 	SPL~ UNLESS ~%SOURCE_RES%~
		  END
	  END
	END
  END
 BUT_ONLY
 COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
  GET_OFFSET_ARRAY ab_array ITM_V10_HEADERS
  PHP_EACH ab_array AS int => ab_off BEGIN
	GET_OFFSET_ARRAY2 fx_array ab_off ITM_V10_HEAD_EFFECTS
	PHP_EACH fx_array AS int => fx_off BEGIN
	  READ_SHORT fx_off fx_type
	  PATCH_IF fx_type = 25 BEGIN 							// poison
//		  PATCH_PRINT "%SOURCE_RES% is a poison item"
		  INNER_ACTION BEGIN
			APPEND ~d5poisev.2da~ ~%SOURCE_RES% 	ITM~ UNLESS ~%SOURCE_RES%~
		  END
	  END
	  PATCH_IF fx_type = 12 BEGIN 							// damage (poison)
    	READ_SHORT fx_off + 0xa damage_type
		PATCH_IF damage_type = 32 BEGIN
//			PATCH_PRINT "%SOURCE_RES% is a poison item"
			INNER_ACTION BEGIN
			  APPEND ~d5poisev.2da~ ~%SOURCE_RES% 	ITM~ UNLESS ~%SOURCE_RES%~
			END
		END
	  END
	  PATCH_IF fx_type = 78 BEGIN 							// disease
//		  PATCH_PRINT "%SOURCE_RES% is a disease item"
		  INNER_ACTION BEGIN
			APPEND ~d5poisev.2da~ ~%SOURCE_RES% 	ITM~ UNLESS ~%SOURCE_RES%~
		  END
	  END
	END
  END
 BUT_ONLY
 COPY_EXISTING ~d5poisev.2da~ ~override~ 
  COUNT_2DA_COLS cols
  COUNT_2DA_ROWS cols rows
  FOR (row = 1; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 0 cols poison_evade_res
	READ_2DA_ENTRY row 1 cols poison_evade_type
	PATCH_IF (~%poison_evade_type%~ STRING_EQUAL_CASE ~spl~) BEGIN 
	 PATCH_IF FILE_EXISTS_IN_GAME ~%poison_evade_res%.spl~ BEGIN
	  INNER_ACTION BEGIN
		LAF add_evade_spell INT_VAR evasion_spellstate = %poison_evasion_state% evasion_save = 1 STR_VAR evade_ext = ~spl~ evade_condition = ~spellstate~ evade_res = EVAL ~%poison_evade_res%~ evade_prefix = ~D5VP~ END
	  END
	 END
	END
	PATCH_IF (~%poison_evade_type%~ STRING_EQUAL_CASE ~itm~) BEGIN 
	 PATCH_IF FILE_EXISTS_IN_GAME ~%poison_evade_res%.itm~ BEGIN
	  INNER_ACTION BEGIN
		LAF add_evade_spell INT_VAR evasion_spellstate = %poison_evasion_state% evasion_save = 1 STR_VAR evade_ext = ~itm~ evade_condition = ~spellstate~ evade_res = EVAL ~%poison_evade_res%~ evade_prefix = ~D5VP~ END
	  END
	 END
	END
  END
 BUT_ONLY
END	// end if not already present

//__________________________________________________________________________________

// determination: 39 Sleep, 217 PW Sleep, 109 Paralysis, 175 Hold, 24 Fear, 45 Stun, 210 PW Stun
LAF d5_resolve_state STR_VAR new_state_id = ~D5_STUNEVADE~ RET new_state_ind END
OUTER_SET stun_evasion_state = %new_state_ind%

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csf6.spl~				//			unflagging determination
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 328 target = 1 parameter2 = %stun_evasion_state% timing = 9 special = 1 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csf6~ END

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5stunev.2da~) BEGIN
 <<<<<<<< d5/d5stunev.2da
2DA V1.0 
RES
 >>>>>>>> 
 COPY ~d5/d5stunev.2da~ ~override/d5stunev.2da~ 
END
COPY_EXISTING_REGEXP GLOB ~^.+\.spl$~ ~override~
  GET_OFFSET_ARRAY ab_array SPL_V10_HEADERS
  PHP_EACH ab_array AS int => ab_off BEGIN
	GET_OFFSET_ARRAY2 fx_array ab_off SPL_V10_HEAD_EFFECTS
	PHP_EACH fx_array AS int => fx_off BEGIN
	  READ_SHORT fx_off fx_type
	  PATCH_IF (fx_type = 217) || (fx_type = 24) || (fx_type = 175) || (fx_type = 39) || (fx_type = 109) || (fx_type = 210) || (fx_type = 45) BEGIN
//		  PATCH_PRINT "%SOURCE_RES%.spl is subject to Determination"
		  INNER_ACTION BEGIN
			APPEND ~d5stunev.2da~ ~%SOURCE_RES% 	SPL~ UNLESS ~%SOURCE_RES%~
		  END
	  END
	END
  END
BUT_ONLY
COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
  GET_OFFSET_ARRAY ab_array ITM_V10_HEADERS
  PHP_EACH ab_array AS int => ab_off BEGIN
	GET_OFFSET_ARRAY2 fx_array ab_off ITM_V10_HEAD_EFFECTS
	PHP_EACH fx_array AS int => fx_off BEGIN
	  READ_SHORT fx_off fx_type
	  PATCH_IF (fx_type = 217) || (fx_type = 24) || (fx_type = 175) || (fx_type = 39) || (fx_type = 109) || (fx_type = 210) || (fx_type = 45) BEGIN
//		  PATCH_PRINT "%SOURCE_RES%.itm is subject to Determination"
		  INNER_ACTION BEGIN
			APPEND ~d5stunev.2da~ ~%SOURCE_RES% 	ITM~ UNLESS ~%SOURCE_RES%~
		  END
	  END
	END
  END
BUT_ONLY
COPY_EXISTING ~d5stunev.2da~ ~override~ 
  COUNT_2DA_COLS cols
  COUNT_2DA_ROWS cols rows
  FOR (row = 1; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 0 cols stun_evade_res
	READ_2DA_ENTRY row 1 cols poison_evade_type
	PATCH_IF (~%stun_evade_type%~ STRING_EQUAL_CASE ~spl~) BEGIN 
	 PATCH_IF FILE_EXISTS_IN_GAME ~%stun_evade_res%.spl~ BEGIN
	  INNER_ACTION BEGIN
		LAF add_evade_spell INT_VAR evasion_spellstate = %stun_evasion_state% evasion_save = 16 STR_VAR evade_ext = ~spl~ evade_condition = ~spellstate~ evade_res = EVAL ~%stun_evade_res%~ evade_prefix = ~D5VS~ END
	  END
	 END
	END
	PATCH_IF (~%stun_evade_type%~ STRING_EQUAL_CASE ~itm~) BEGIN 
	 PATCH_IF FILE_EXISTS_IN_GAME ~%stun_evade_res%.itm~ BEGIN
	  INNER_ACTION BEGIN
		LAF add_evade_spell INT_VAR evasion_spellstate = %stun_evasion_state% evasion_save = 16 STR_VAR evade_ext = ~itm~ evade_condition = ~spellstate~ evade_res = EVAL ~%stun_evade_res%~ evade_prefix = ~D5VS~ END
	  END
	 END
	END
  END
BUT_ONLY

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csf7.spl~				//			strength training
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 44 target = 1 parameter1 = 1 parameter2 = 0 timing = 1 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 139 target = 1 parameter1 = 11335 parameter2 = 0 timing = 1 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csf7~ END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csf8.spl~				//			agility training
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 15 target = 1 parameter1 = 1 parameter2 = 0 timing = 1 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 139 target = 1 parameter1 = 11336 parameter2 = 0 timing = 1 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csf8~ END

//__________________________________________________________________________________



//__________________________________________________________________________________
//
//								MISCELLANEOUS SKILLS
//__________________________________________________________________________________


//miscellaneous skills_______________________________________________________________
//
// extra prof, tracking, flaming weapon, smoke bomb/grease jar, slippery mind, escape artist, luck, psi wild talent
//
// d5csm1 = lore
// d5csm2 = tracking
// d5csm3 = flaming weapon
// d5csm4 = grease jar/smoke bomb
// d5csm5 = escape artist
// d5csm6 = slippery mind
// d5csm7 = luck
// d5csm8 = wild talent


ACTION_FOR_EACH feat_spl IN ~1~ ~2~ ~3~ ~4~ ~5~ ~6~ ~7~ ~8~ BEGIN		//		each feat

  COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csm%feat_spl%l.spl~
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 duration = 0 STR_VAR resource = EVAL ~d5csm%feat_spl%~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~d5csm%feat_spl%~ END
  IF_EXISTS BUT_ONLY

  CREATE EFF  ~d5csm%feat_spl%~
	WRITE_LONG 0x10 187
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 1
	WRITE_LONG 0x20 0
	WRITE_LONG 0x24 9
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0xa8 ~d5csm%feat_spl%~ #32
	WRITE_LONG 0x90 1
	WRITE_EVALUATED_ASCII 0x94 ~d5csm%feat_spl%~ #8

END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csm1.spl~				//			lore bonus
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 21 target = 1 parameter1 = 25 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csm1~ END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/csp/d5track.bam~ ~override~

COPY_EXISTING ~d5csm2l.spl~ ~override~
  LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 146 opcode = 171 parameter2 = 0 STR_VAR /*match_resource = ~d5csm2~*/ resource = ~spcl922~ END

ACTION_IF !(FILE_EXISTS_IN_GAME ~spcl922.spl~) BEGIN					//			tracking
  COPY ~%MOD_FOLDER%/csp/spcl922.spl~ ~override~
    SAY NAME1 @12053
    SAY UNIDENTIFIED_DESC @12054
    WRITE_ASCII 0x3a ~d5track~ #8
    LPF ALTER_SPELL_HEADER STR_VAR icon = ~d5track~ END
END
ACTION_IF (FILE_EXISTS_IN_GAME ~spcl922.spl~) BEGIN
  COPY_EXISTING ~spcl922.spl~ ~override~
    SAY NAME1 @12053
    SAY UNIDENTIFIED_DESC @12054
    WRITE_ASCII 0x3a ~d5track~ #8
    LPF ALTER_SPELL_HEADER STR_VAR icon = ~d5track~ END
END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/csp/d5csm3.bam~ ~override~

COPY_EXISTING ~d5csm3l.spl~ ~override~
  LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 146 opcode = 171 parameter2 = 0 /*STR_VAR match_resource = ~d5csm3~*/ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csm3.spl~				//			flaming  weapon
  SAY NAME1 @12055
  SAY UNIDENTIFIED_DESC @12056
  WRITE_ASCII 0x3a ~d5csm3~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 STR_VAR icon = ~d5csm3~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 248 target = 1 timing = 0 duration = 120 STR_VAR resource = ~d5csm3b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csm3b~ END

CREATE EFF  ~d5csm3b~
	WRITE_LONG 0x10 12
	WRITE_LONG 0x14 2
	WRITE_LONG 0x1c 1
	WRITE_SHORT 0x20 0
	WRITE_SHORT 0x22 8
	WRITE_LONG 0x24 1
	WRITE_SHORT 0x2c 100
	WRITE_LONG 0x38 2
	WRITE_LONG 0x3c 2

//__________________________________________________________________________________

COPY_EXISTING ~d5csm4l.spl~ ~override~
  LPF CLONE_EFFECT INT_VAR silent = 1 match_opcode = 146 opcode = 171 parameter2 = 0 STR_VAR /*match_resource = ~d5csm4~*/ resource = ~d5csm4b~ END
  LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 146 opcode = 171 parameter2 = 0 STR_VAR /*match_resource = ~d5csm4~*/ resource = ~d5csm4a~ END

COPY ~%MOD_FOLDER%/csp/d5csm4a.bam~ ~override~
COPY ~%MOD_FOLDER%/csp/d5csm4b.bam~ ~override~

COPY_EXISTING ~spwi101.spl~ ~override/d5csm4a.spl~  					//			grease jar
  SAY NAME1 @12191
  SAY UNIDENTIFIED_DESC @12192
  WRITE_ASCII 0x3a ~d5csm4a~ #8
  LPF ALTER_SPELL_HEADER STR_VAR icon = ~d5csm4a~ END
  LPM spell_to_innate

COPY_EXISTING ~spwi213.spl~ ~override/d5csm4b.spl~  			 		//			smoke bomb
  SAY NAME1 @12193
  SAY UNIDENTIFIED_DESC @12194
  WRITE_ASCII 0x3a ~d5csm4b~ #8
  LPF ALTER_SPELL_HEADER STR_VAR icon = ~d5csm4b~ END
  LPM spell_to_innate

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csm5.spl~				//			escape  artist
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 232 target = 1 parameter1 = 0 parameter2 = 5 timing = 9 STR_VAR resource = ~d5csm5b~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csm5~ END

COPY_EXISTING ~sppr308.spl~ ~override/d5csm5b.spl~ 
  LPF ALTER_SPELL_HEADER INT_VAR target = 1 projectile = 1 END
  LPF ALTER_EFFECT INT_VAR silent = 1 match_probability1 = 100 probability1 = 50 END
// apply the contingency again...
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 4 duration = 6 STR_VAR resource = ~d5csm5~ END

/* ...or, set it up as a repeating contingency?
CREATE EFF  ~d5csm5a~
	WRITE_LONG 0x10 232
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 0
	WRITE_LONG 0x20 20
	WRITE_LONG 0x24 9
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~D5CSP6b~ #8
	WRITE_LONG 0x48 102
*/

//__________________________________________________________________________________

// slippery mind: 5 Charm, 128 Confusion, 76 Feeblemind, 213 Maze
LAF d5_resolve_state STR_VAR new_state_id = ~D5_CHARMEVADE~ RET new_state_ind END
OUTER_SET charm_evasion_state = %new_state_ind%

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csm6.spl~				//			slippery mind
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 328 target = 1 parameter2 = %charm_evasion_state% timing = 9 special = 1 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csm6~ END

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5chrmev.2da~) BEGIN
 <<<<<<<< d5/d5chrmev.2da
2DA V1.0 
RES
 >>>>>>>> 
 COPY ~d5/d5chrmev.2da~ ~override/d5chrmev.2da~ 
END
COPY_EXISTING_REGEXP GLOB ~^.+\.spl$~ ~override~
  GET_OFFSET_ARRAY ab_array SPL_V10_HEADERS
  PHP_EACH ab_array AS int => ab_off BEGIN
	GET_OFFSET_ARRAY2 fx_array ab_off SPL_V10_HEAD_EFFECTS
	PHP_EACH fx_array AS int => fx_off BEGIN
	  READ_SHORT fx_off fx_type
	  PATCH_IF (fx_type = 5) || (fx_type = 128) || (fx_type = 76) || (fx_type = 213) BEGIN
//		  PATCH_PRINT "%SOURCE_RES%.spl subject to Slippery Mind"
		  INNER_ACTION BEGIN
			APPEND ~d5chrmev.2da~ ~%SOURCE_RES% 	SPL~ UNLESS ~%SOURCE_RES%~
		  END
	  END
	END
  END
BUT_ONLY
COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
  GET_OFFSET_ARRAY ab_array ITM_V10_HEADERS
  PHP_EACH ab_array AS int => ab_off BEGIN
	GET_OFFSET_ARRAY2 fx_array ab_off ITM_V10_HEAD_EFFECTS
	PHP_EACH fx_array AS int => fx_off BEGIN
	  READ_SHORT fx_off fx_type
	  PATCH_IF (fx_type = 5) || (fx_type = 128) || (fx_type = 76) || (fx_type = 213) BEGIN
//		  PATCH_PRINT "%SOURCE_RES%.itm subject to Slippery Mind"
		  INNER_ACTION BEGIN
			APPEND ~d5chrmev.2da~ ~%SOURCE_RES% 	ITM~ UNLESS ~%SOURCE_RES%~
		  END
	  END
	END
  END
BUT_ONLY
COPY_EXISTING ~d5chrmev.2da~ ~override~ 
  COUNT_2DA_COLS cols
  COUNT_2DA_ROWS cols rows
  FOR (row = 1; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 0 cols charm_evade_res
	READ_2DA_ENTRY row 1 cols charm_evade_type
	PATCH_IF (~%charm_evade_type%~ STRING_EQUAL_CASE ~spl~) BEGIN 
	 PATCH_IF FILE_EXISTS_IN_GAME ~%charm_evade_res%.spl~ BEGIN
	  INNER_ACTION BEGIN
		LAF add_evade_spell INT_VAR evasion_spellstate = %charm_evasion_state% evasion_save = 1 STR_VAR evade_ext = ~spl~ evade_condition = ~spellstate~ evade_res = EVAL ~%charm_evade_res%~ evade_prefix = ~D5VC~ END
	  END
	 END
	END
	PATCH_IF (~%charm_evade_type%~ STRING_EQUAL_CASE ~spl~) BEGIN 
	 PATCH_IF FILE_EXISTS_IN_GAME ~%charm_evade_res%.itm~ BEGIN
	  INNER_ACTION BEGIN
		LAF add_evade_spell INT_VAR evasion_spellstate = %charm_evasion_state% evasion_save = 1 STR_VAR evade_ext = ~itm~ evade_condition = ~spellstate~ evade_res = EVAL ~%charm_evade_res%~ evade_prefix = ~D5VC~ END
	  END
	 END
	END
  END
BUT_ONLY

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csm7.spl~				//			luck bonus
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 22 target = 1 parameter1 = 1 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 142 target = 1 parameter1 = 0 parameter2 = 32 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csm7~ END

//__________________________________________________________________________________

ACTION_IF (FILE_EXISTS_IN_GAME ~d5pswt0.spl~) BEGIN
  COPY_EXISTING ~d5pswt0.spl~ ~override/d5csm8.spl~						//			wild talent
	LPF ALTER_SPELL_HEADER STR_VAR icon = ~d5pswt0~ END
	PATCH_IF !(MOD_IS_INSTALLED ~will_to_power.tp2~ ~900~) BEGIN
	  LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 146 probability1 = 93 probability2 = 0 STR_VAR match_resource = ~d5pswt1~ END
	  LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 146 probability1 = 96 probability2 = 89 STR_VAR match_resource = ~d5pswt2~ END
	  LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 146 probability1 = 100 probability2 = 94 STR_VAR match_resource = ~d5pswt3~ END
	END
END

//__________________________________________________________________________________



//__________________________________________________________________________________
//
//								MAGICAL SKILLS
//__________________________________________________________________________________


//magical skills_____________________________________________________________________
//
// UMD, plus innate versions of various spells
// ...reflected image, color spray, blur, glitterdust, shadowstep, ...
// 
// need to make a semi-spont-style ability pool with these spells
// maybe actually make a function for this in the semi_spont library
//
// use the actual prof value for spell slots
//
// d5csi1 = UMD				= 
// d5csi2 = Color Spray		= spwi105
// d5csi3 = Reflected Image	= spwi120
// d5csi4 = Blur			= spwi201
// d5csi5 = Knock			= spwi207
// d5csi6 = Luck			= spwi209
// d5csi7 = Glitterdust		= spwi224
// d5csi8 = Sanctuary		= sppr109
// d5csi9 = Shadowstep		= spsd02

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csi1l.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 duration = 0 STR_VAR resource = EVAL ~d5csi1~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~d5csi1~ END

CREATE EFF  ~d5csi1~
	WRITE_LONG 0x10 187
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 1
	WRITE_LONG 0x20 0
	WRITE_LONG 0x24 9
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0xa8 ~D5CSI1~ #32
	WRITE_LONG 0x90 1
	WRITE_EVALUATED_ASCII 0x94 ~d5csi1~ #8

// ***** Refinements' version maybe isn't working? Update it to this code

//COPY ~%MOD_FOLDER%/csp/d5csi1.bam~ ~override~

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csi1.spl~					//			UMD
  WRITE_ASCII 0x3a ~d5csi1~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 STR_VAR icon = ~d5csi1~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5_numd~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 4 duration = 2 STR_VAR resource = ~d5_numd~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5_numd~ END

ACTION_IF (thief_use_wands = 0) BEGIN

  COPY_EXISTING ~wand11.itm~ ~weidu_external/%MOD_FOLDER%/temp~

  OUTER_SET spec_ids = IDS_OF_SYMBOL (~specific~ ~D5_NO_UMD~)
  ACTION_IF (spec_ids = 0 - 1) BEGIN  
    LAF d5_resolve_specific STR_VAR new_specific_id = ~D5_NO_UMD~ RET new_specific_ind END
    OUTER_SET no_umd_specific = %new_specific_ind%
  END
  ACTION_IF (spec_ids > 0) BEGIN
    OUTER_SET no_umd_specific = %spec_ids%
  END

  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5_numd.spl~) BEGIN
   COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5_numd.spl~				//			UMD
    LPF ALTER_SPELL_HEADER INT_VAR target = 1 END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 9 STR_VAR resource = ~d5numdlv~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 9 STR_VAR resource = ~d5_numd~ END
  END

  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5_numd.eff~) BEGIN
   CREATE EFF  ~d5_numd~
	WRITE_LONG 0x10 72
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c %no_umd_specific%
	WRITE_LONG 0x20 4
	WRITE_LONG 0x24 9
	WRITE_SHORT 0x2c 100
  END

// make an .eff to set D5NOUMD local variable
  CREATE EFF ~d5numdlv~
	WRITE_LONG 0x10 309
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 1
	WRITE_LONG 0x20 0
	WRITE_LONG 0x24 9
	WRITE_LONG 0x28 0
	WRITE_SHORT 0x2c 100
	WRITE_ASCII 0x30 ~D5NOUMD~ #8

  OUTER_SET scroll_count = 0
  OUTER_SPRINT $use_scrolls(~%scroll_count%~) ~scroll~
  COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
   READ_BYTE     0x2f current ELSE 0
   READ_BYTE     0x2b current2 ELSE 0
   READ_LONG 0x64 headoffset  ELSE 0
   READ_SHORT 0x68 headcount  ELSE 0
   READ_LONG 0x6a effectsoffset  ELSE 0
   haslearn = 0
   hascast = 0
//	  PATCH_IF (headcount = 2) BEGIN
    FOR (headcyc = 0; headcyc < headcount ; headcyc = headcyc + 1) BEGIN
      thishead = 0
      READ_SHORT (headoffset + (headcyc * 0x38) + 0x1e) effcount  ELSE 0
      READ_SHORT (headoffset + (headcyc * 0x38) + 0x20) effectsindex  ELSE 0
      FOR (effcyc = 0; effcyc < effcount; effcyc = effcyc + 1) BEGIN
        READ_SHORT (effectsoffset + (effectsindex + effcyc)* 0x30) opcode ELSE 0
        PATCH_IF (opcode = 0x93) AND (thishead = 0) BEGIN
          READ_ASCII (effectsoffset + 0x14 + (effectsindex + effcyc)* 0x30) resref_learn  ELSE 0
          INNER_PATCH_FILE ~%resref_learn%.spl~ BEGIN
            READ_SHORT 0x1c type
          END
          PATCH_IF (type = 1) BEGIN // spell scroll
            thishead = 1
            haslearn = 1
          END
        END // PATCH_IF... (opcode = learn spell)
        PATCH_IF ((opcode = 0x92) OR (opcode = 0x94)) AND (thishead = 0) BEGIN
          READ_ASCII (effectsoffset + 0x14 + (effectsindex + effcyc)* 0x30) resref_cast  ELSE 0
          INNER_PATCH_FILE ~%resref_cast%.spl~ BEGIN
            READ_SHORT 0x1c type
          END
          PATCH_IF (type = 1) OR (type = 2) BEGIN // spell scroll
            thishead = 1
            hascast = 1
          END
        END // PATCH_IF (opcode = cast spell)
      END // FOR... effect_cycle
    END // FOR... header cycle
//  END // PATCH_IF... have exactly 2 headers
   PATCH_IF (haslearn = 1) AND (hascast = 1) /*AND (~%resref_cast%~ STRING_EQUAL_CASE ~%resref_learn%~) */BEGIN
	SPRINT $use_scrolls(~%scroll_count%~) ~%SOURCE_RES%~
	SET ++scroll_count
   END
  BUT_ONLY
  ACTION_PHP_EACH use_scrolls AS num => scroll BEGIN
   ACTION_IF FILE_EXISTS_IN_GAME ~%scroll%.itm~ BEGIN
//	PRINT ~%scroll% is a wizard scroll~
	COPY_EXISTING ~%scroll%.itm~ ~override~
	  WRITE_BYTE 0x1f (THIS BAND 0b11111101)
	  WRITE_BYTE 0x20 (THIS BAND 0b10111101)
	  PATCH_IF !(FILE_EXISTS_IN_GAME ~d5__umd.d5~) BEGIN
		LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 319 target = 1 parameter2 = 6 parameter1 = %no_umd_specific% timing = 2 END
	  END
	BUT_ONLY
   END
  END
  COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
   READ_SHORT	0x1c item_type
   PATCH_IF (item_type = 35) BEGIN
	READ_BYTE 0x20 thief_use
	PATCH_IF (%thief_use% BAND 0b01000000) = 0b01000000 BEGIN
	  WRITE_BYTE 0x1f (THIS BAND 0b11111101)
	  WRITE_BYTE 0x20 (THIS BAND 0b10111101)
	  PATCH_IF !(FILE_EXISTS_IN_GAME ~d5__umd.d5~) BEGIN
		LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 319 target = 1 parameter2 = 6 parameter1 = %no_umd_specific% timing = 2 END
	  END
	END
   END
  BUT_ONLY

  ACTION_IF (GAME_INCLUDES ~sod~) BEGIN
    COPY_EXISTING dplayer2.bcs override
	  DECOMPILE_AND_PATCH BEGIN
	    REPLACE_TEXTUALLY ~THEN[%WNL%%LNL%%MNL%%TAB% ]+RESPONSE[%TAB% ]+#100[%WNL%%LNL%%MNL%%TAB% ]+ChangeSpecifics(Myself,\(1\|NORMAL\))~
    ~
  !Specifics(Myself,D5_NO_UMD)
  Switch("D5NOUMD","locals")
THEN
  RESPONSE #0
    ChangeSpecifics(Myself,NORMAL)
    SetGlobal("bd_joined","locals",0)
    SetGlobal("bd_npc_camp","locals",0)
  RESPONSE #1
    ChangeSpecifics(Myself,D5_NO_UMD)~
	 END
    BUT_ONLY
  END

  COPY_EXISTING ~weidu_external/%MOD_FOLDER%/temp/wand11.itm~ ~override~
 
  COPY ~%MOD_FOLDER%/lib/markers/d5_marker.d5~ ~override/d5__umd.d5~

END
//	end use scrolls/wands

//__________________________________________________________________________________



//learn illusion spells______________________________________________________________
//
ACTION_DEFINE_ASSOCIATIVE_ARRAY semi_innate_spells BEGIN
  d5csi2 => spwi105
  d5csi3 => spwi120
  d5csi4 => spwi201
  d5csi5 => spwi207
  d5csi6 => spwi209
  d5csi7 => spwi224
  d5csi8 => sppr109
  d5csi9 => spsd02
END

INCLUDE ~%MOD_FOLDER%/lib/semi_spontaneous.tpa~

LAF semi_innate_casting INT_VAR semi_innate_stat = 110 semi_innate_shift = 24 STR_VAR semi_innate_prefix = ~d5ci~ semi_innate_array = ~semi_innate_spells~ END

ACTION_FOR_EACH mag_spl IN ~2~ ~3~ ~4~ ~5~ ~6~ ~7~ ~8~ ~9~ BEGIN			//		set up magic skills

  COPY_EXISTING ~d5csi%mag_spl%l.spl~ ~override~
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cix1a~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~d5csi%mag_spl%~ END
  IF_EXISTS BUT_ONLY

  CREATE EFF  ~d5csi%mag_spl%~
	WRITE_LONG 0x10 187
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 1
	WRITE_LONG 0x20 0
	WRITE_LONG 0x24 9
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0xa8 ~D5CSI%mag_spl%~ #32
	WRITE_LONG 0x90 1
	WRITE_EVALUATED_ASCII 0x94 ~d5csi%mag_spl%~ #8

END

//__________________________________________________________________________________



//__________________________________________________________________________________
//
//								SKILL DIALOGUES
//__________________________________________________________________________________



ACTION_FOR_EACH stat IN ~115~ ~124~ ~127~ ~110~ BEGIN

 ACTION_FOR_EACH let IN ~a~ ~b~ ~c~ ~d~ ~e~ ~f~ ~g~ BEGIN

  COPY_EXISTING ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5c%stat%%let%.spl~
    LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = EVAL ~d5cs%stat%~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 0 duration = 12 STR_VAR resource = EVAL ~d5cs%stat%~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = EVAL ~d5c%stat%%let%~ END

 END

 COPY ~%MOD_FOLDER%/csp/d5cs%stat%.bam~ ~override~

 CREATE EFF ~d5cs%stat%~
	WRITE_LONG 0x10 67
	WRITE_LONG 0x14 1
	WRITE_LONG 0x28 12
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~d5cs%stat%~ #8
	WRITE_ASCII 0x70 ~shskull~ #8

 COPY ~%MOD_FOLDER%/csp/d5_dlg.cre~ ~override/d5cs%stat%.cre~
  WRITE_EVALUATED_ASCII 0x248 ~d5cs%stat%~ #8

END

ACTION_FOR_EACH let IN ~a~ ~b~ ~c~ ~d~ ~e~ ~f~ ~g~ BEGIN

  COPY_EXISTING ~d5c115%let%.spl~ ~override~
    SAY NAME1 @12165
    SAY UNIDENTIFIED_DESC @12115
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp1b~ END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp2b~ END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp3b~ END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp4b~ END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp5b~ END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp6b~ END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp7b~ END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp8b~ END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cxp9b~ END

  COPY_EXISTING ~d5c124%let%.spl~ ~override~
    SAY NAME1 @12174
    SAY UNIDENTIFIED_DESC @12124

  COPY_EXISTING ~d5c127%let%.spl~ ~override~
    SAY NAME1 @12177
    SAY UNIDENTIFIED_DESC @12127

  COPY_EXISTING ~d5c110%let%.spl~ ~override~
    SAY NAME1 @12160
    SAY UNIDENTIFIED_DESC @12110
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5ci206~ END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5ci000~ END

END


//import dlg feat table______________________________________________________________
//
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5csdlg.2da~) BEGIN
  COPY ~%MOD_FOLDER%/csp/d5csdlg.2da~ ~override~
END
//__________________________________________________________________________________

<<<<<<<< d5/d5cs115.d
BEGIN ~D5CS115~

IF ~Global("D5CS115","GLOBAL",1)~ THEN BEGIN d5cs115
 SAY @12001
 IF ~GlobalGT("D5CS115A","GLOBAL",0) OR(2) Global("D5CSP1","LOCALS",0) Global("D5CSP1","LOCALS",2)~ THEN REPLY @12011 GOTO d5cs115_1		//	leadership
 IF ~GlobalGT("D5CS115B","GLOBAL",0) OR(2) Global("D5CSP2","LOCALS",0) Global("D5CSP2","LOCALS",2)~ THEN REPLY @12013 GOTO d5cs115_2		//	grappling
 IF ~GlobalGT("D5CS115C","GLOBAL",0) OR(2) Global("D5CSP3","LOCALS",0) Global("D5CSP3","LOCALS",2)~ THEN REPLY @12015 GOTO d5cs115_3		//	precise strike
 IF ~GlobalGT("D5CS115D","GLOBAL",0) OR(2) Global("D5CSP4","LOCALS",0) Global("D5CSP4","LOCALS",2)~ THEN REPLY @12017 GOTO d5cs115_4		//	parry slashing
 IF ~GlobalGT("D5CS115E","GLOBAL",0) OR(2) Global("D5CSP5","LOCALS",0) Global("D5CSP5","LOCALS",2)~ THEN REPLY @12019 GOTO d5cs115_5		//	parry piercing
 IF ~GlobalGT("D5CS115F","GLOBAL",0) OR(2) Global("D5CSP6","LOCALS",0) Global("D5CSP6","LOCALS",2)~ THEN REPLY @12021 GOTO d5cs115_6		//	parry blunt
 IF ~GlobalGT("D5CS115G","GLOBAL",0) OR(2) Global("D5CSP7","LOCALS",0) Global("D5CSP7","LOCALS",2)~ THEN REPLY @12023 GOTO d5cs115_7		//	missile snaring
 IF ~GlobalGT("D5CS115H","GLOBAL",0) OR(2) Global("D5CSP8","LOCALS",0) Global("D5CSP8","LOCALS",2)~ THEN REPLY @12025 GOTO d5cs115_8		//	fighting dirty
 IF ~GlobalGT("D5CS115I","GLOBAL",0) OR(2) Global("D5CSP9","LOCALS",0) Global("D5CSP9","LOCALS",2)~ THEN REPLY @12027 GOTO d5cs115_9		//	spell evasion
END

IF ~~ THEN BEGIN d5cs115_1 											// leadership
 SAY @12012
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSP1","LOCALS",1)~ DO ~ApplySpellRES("D5CXP1L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs115 
END
IF ~~ THEN BEGIN d5cs115_2											// grappling
 SAY @12014
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSP2","LOCALS",1)~ DO ~ApplySpellRES("D5CXP2L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs115 
END
IF ~~ THEN BEGIN d5cs115_3 											// precise strike
 SAY @12016
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSP3","LOCALS",1)~ DO ~ApplySpellRES("D5CXP3L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs115 
END
IF ~~ THEN BEGIN d5cs115_4 											// parry slashing
 SAY @12018
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSP4","LOCALS",1)~ DO ~ApplySpellRES("D5CXP4L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs115 
END
IF ~~ THEN BEGIN d5cs115_5 											// parry piercing
 SAY @12020
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSP5","LOCALS",1)~ DO ~ApplySpellRES("D5CXP5L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs115 
END
IF ~~ THEN BEGIN d5cs115_6 											// parry blunt
 SAY @12022
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSP6","LOCALS",1)~ DO ~ApplySpellRES("D5CXP6L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs115 
END
IF ~~ THEN BEGIN d5cs115_7 											// missile snaring
 SAY @12024
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSP7","LOCALS",1)~ DO ~ApplySpellRES("D5CXP7L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs115 
END
IF ~~ THEN BEGIN d5cs115_8 											// fighting dirty
 SAY @12026
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSP8","LOCALS",1)~ DO ~ApplySpellRES("D5CXP8L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs115 
END
IF ~~ THEN BEGIN d5cs115_9 											// spell evasion
 SAY @12028
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSP9","LOCALS",1)~ DO ~ApplySpellRES("D5CXP9L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs115 
END
>>>>>>>>

COPY ~d5/d5cs115.d~ ~weidu_external/%MOD_FOLDER%/compile/d5cs115.d~

COMPILE ~weidu_external/%MOD_FOLDER%/compile/d5cs115.d~


<<<<<<<< d5/d5cs115.baf

>>>>>>>>
COPY ~d5/d5cs115.baf~ ~weidu_external/%MOD_FOLDER%/compile/d5cs115.baf~

APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5cs115.baf~
~
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),BERSERKER)
THEN
	RESPONSE #100
	SetGlobal("D5CS115D","GLOBAL",0)
	Continue()
END
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),BERSERKER)
THEN
	RESPONSE #100
	SetGlobal("D5CS115E","GLOBAL",0)
	Continue()
END
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),BERSERKER)
THEN
	RESPONSE #100
	SetGlobal("D5CS115F","GLOBAL",0)
	Continue()
END

IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),SWASHBUCKLER)
THEN
	RESPONSE #100
	SetGlobal("D5CS115A","GLOBAL",1)
	Continue()
END
~

ACTION_IF (VARIABLE_IS_SET %ik_battlerager_code%) BEGIN
  APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5cs115.baf~
~
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),IK_BATTLERAGER)
THEN
	RESPONSE #100
	SetGlobal("D5CS115D","GLOBAL",0)
	Continue()
END
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),IK_BATTLERAGER)
THEN
	RESPONSE #100
	SetGlobal("D5CS115E","GLOBAL",0)
	Continue()
END
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),IK_BATTLERAGER)
THEN
	RESPONSE #100
	SetGlobal("D5CS115F","GLOBAL",0)
	Continue()
END
~
END

ACTION_IF (VARIABLE_IS_SET %c0tbm_code%) BEGIN
  APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5cs115.baf~
~
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),c0tbm)
THEN
	RESPONSE #100
	SetGlobal("D5CS115D","GLOBAL",0)
	Continue()
END
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),c0tbm)
THEN
	RESPONSE #100
	SetGlobal("D5CS115E","GLOBAL",0)
	Continue()
END
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),c0tbm)
THEN
	RESPONSE #100
	SetGlobal("D5CS115F","GLOBAL",0)
	Continue()
END
~
END

ACTION_IF (VARIABLE_IS_SET %d2kensaizerker_code%) BEGIN
  APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5cs115.baf~
~
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),D2KENSAIZERKER)
THEN
	RESPONSE #100
	SetGlobal("D5CS115D","GLOBAL",0)
	Continue()
END
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),D2KENSAIZERKER)
THEN
	RESPONSE #100
	SetGlobal("D5CS115E","GLOBAL",0)
	Continue()
END
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),D2KENSAIZERKER)
THEN
	RESPONSE #100
	SetGlobal("D5CS115F","GLOBAL",0)
	Continue()
END
~
END

APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5cs115.baf~
~
IF
	NumberOfTimesTalkedTo(0)
THEN
	RESPONSE #100
	SetGlobal("D5CS115","GLOBAL",1)
	SetNumTimesTalkedTo(1)
	ActionOverride(LastSummonerOf(Myself),StartDialogOverride("D5CS115",Myself))
END

IF
	True()
THEN
	RESPONSE #100
	SetGlobal("D5CS115","GLOBAL",0)
	SetGlobal("D5CS115A","GLOBAL",0)
	SetGlobal("D5CS115B","GLOBAL",0)
	SetGlobal("D5CS115C","GLOBAL",0)
	SetGlobal("D5CS115D","GLOBAL",0)
	SetGlobal("D5CS115E","GLOBAL",0)
	SetGlobal("D5CS115F","GLOBAL",0)
	SetGlobal("D5CS115G","GLOBAL",0)
	SetGlobal("D5CS115H","GLOBAL",0)
	SetGlobal("D5CS115I","GLOBAL",0)
	SetNumTimesTalkedTo(0)
	ApplySpellRES("D5CS000",LastSummonerOf(Myself))
	DestroySelf() 
END
~

COMPILE ~weidu_external/%MOD_FOLDER%/compile/d5cs115.baf~


<<<<<<<< d5/d5115tmp.baf

>>>>>>>>
COPY ~d5/d5115tmp.baf~ ~weidu_external/%MOD_FOLDER%/compile/d5115tmp.baf~

COPY_EXISTING ~d5csdlg.2da~ ~override~
  COUNT_2DA_COLS cols
  COUNT_2DA_ROWS cols rows
  FOR (row = 0; row < rows; ++row) BEGIN
    FOR (col = 1; col < cols; ++col) BEGIN
      READ_2DA_ENTRY 0 col cols class_name
      READ_2DA_ENTRY row 1 cols stat
      READ_2DA_ENTRY row col cols val
//      PATCH_PRINT ~%class_name% - %stat% - %val%~
      PATCH_IF (~%stat%~ STRING_CONTAINS_REGEXP ~115~) = 0 BEGIN
        PATCH_IF (~%val%~ STRING_EQUAL_CASE ~1~) BEGIN
          INNER_ACTION BEGIN
            APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5115tmp.baf~ 
~
IF
	NumberOfTimesTalkedTo(0)
	Class(LastSummonerOf(Myself),%class_name%)
THEN
	RESPONSE #100
	SetGlobal("D5CS%stat%","GLOBAL",1)
	Continue()
END
~
          END
        END
      END
    END
  END
BUT_ONLY

EXTEND_TOP ~d5cs115.bcs~ ~weidu_external/%MOD_FOLDER%/compile/d5115tmp.baf~

//__________________________________________________________________________________

<<<<<<<< d5/d5cs124.d
BEGIN ~D5CS124~

IF ~Global("D5CS124","GLOBAL",1)~ THEN BEGIN d5cs124
 SAY @12001
 IF ~GlobalGT("D5CS124A","GLOBAL",0) OR(2) Global("D5CSF1","LOCALS",0) Global("D5CSF1","LOCALS",2)~ THEN REPLY @12031 GOTO d5cs124_1		//	health conditioning
 IF ~GlobalGT("D5CS124B","GLOBAL",0) OR(2) Global("D5CSF2","LOCALS",0) Global("D5CSF2","LOCALS",2)~ THEN REPLY @12033 GOTO d5cs124_2		//	toughness
 IF ~GlobalGT("D5CS124C","GLOBAL",0) OR(2) Global("D5CSF3","LOCALS",0) Global("D5CSF3","LOCALS",2)~ THEN REPLY @12035 GOTO d5cs124_3		//	resistance
 IF ~GlobalGT("D5CS124D","GLOBAL",0) OR(2) Global("D5CSF4","LOCALS",0) Global("D5CSF4","LOCALS",2)~ THEN REPLY @12037 GOTO d5cs124_4		//	quickstride
 IF ~GlobalGT("D5CS124E","GLOBAL",0) OR(2) Global("D5CSF5","LOCALS",0) Global("D5CSF5","LOCALS",2)~ THEN REPLY @12039 GOTO d5cs124_5		//	fortitude
 IF ~GlobalGT("D5CS124F","GLOBAL",0) OR(2) Global("D5CSF6","LOCALS",0) Global("D5CSF6","LOCALS",2)~ THEN REPLY @12041 GOTO d5cs124_6		//	determination
 IF ~GlobalGT("D5CS124G","GLOBAL",0) OR(2) Global("D5CSF7","LOCALS",0) Global("D5CSF7","LOCALS",2)~ THEN REPLY @12043 GOTO d5cs124_7		//	strength training
 IF ~GlobalGT("D5CS124H","GLOBAL",0) OR(2) Global("D5CSF8","LOCALS",0) Global("D5CSF8","LOCALS",2)~ THEN REPLY @12045 GOTO d5cs124_8		//	agility training
END

IF ~~ THEN BEGIN d5cs124_1 											// health conditioning
 SAY @12032
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSF1","LOCALS",1)~ DO ~ApplySpellRES("D5CSF1L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs124 
END
IF ~~ THEN BEGIN d5cs124_2											// toughness
 SAY @12034
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSF2","LOCALS",1)~ DO ~ApplySpellRES("D5CSF2L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs124 
END
IF ~~ THEN BEGIN d5cs124_3 											// resistance
 SAY @12036
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSF3","LOCALS",1)~ DO ~ApplySpellRES("D5CSF3L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs124 
END
IF ~~ THEN BEGIN d5cs124_4 											// quickstride
 SAY @12038
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSF4","LOCALS",1)~ DO ~ApplySpellRES("D5CSF4L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs124 
END
IF ~~ THEN BEGIN d5cs124_5 											// fortitude
 SAY @12040
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSF5","LOCALS",1)~ DO ~ApplySpellRES("D5CSF5L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs124 
END
IF ~~ THEN BEGIN d5cs124_6 											// determination
 SAY @12042
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSF6","LOCALS",1)~ DO ~ApplySpellRES("D5CSF6L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs124 
END
IF ~~ THEN BEGIN d5cs124_7 											// strength training
 SAY @12044
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSF7","LOCALS",1)~ DO ~ApplySpellRES("D5CSF7L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs124 
END
IF ~~ THEN BEGIN d5cs124_8 											// agility training
 SAY @12046
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSF8","LOCALS",1)~ DO ~ApplySpellRES("D5CSF8L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs124 
END
>>>>>>>>

COPY ~d5/d5cs124.d~ ~weidu_external/%MOD_FOLDER%/compile/d5cs124.d~

COMPILE ~weidu_external/%MOD_FOLDER%/compile/d5cs124.d~


<<<<<<<< d5/d5cs124.baf

>>>>>>>>
COPY ~d5/d5cs124.baf~ ~weidu_external/%MOD_FOLDER%/compile/d5cs124.baf~

APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5cs124.baf~
~
IF
	NumberOfTimesTalkedTo(0)
THEN
	RESPONSE #100
	SetGlobal("D5CS124","GLOBAL",1)
	SetNumTimesTalkedTo(1)
	ActionOverride(LastSummonerOf(Myself),StartDialogOverride("D5CS124",Myself))
END

IF
	True()
THEN
	RESPONSE #100
	SetGlobal("D5CS124","GLOBAL",0)
	SetGlobal("D5CS124A","GLOBAL",0)
	SetGlobal("D5CS124B","GLOBAL",0)
	SetGlobal("D5CS124C","GLOBAL",0)
	SetGlobal("D5CS124D","GLOBAL",0)
	SetGlobal("D5CS124E","GLOBAL",0)
	SetGlobal("D5CS124F","GLOBAL",0)
	SetGlobal("D5CS124G","GLOBAL",0)
	SetGlobal("D5CS124H","GLOBAL",0)
	SetGlobal("D5CS124I","GLOBAL",0)
	SetNumTimesTalkedTo(0)
	ApplySpellRES("D5CS000",LastSummonerOf(Myself))
	DestroySelf() 
END
~

COMPILE ~weidu_external/%MOD_FOLDER%/compile/d5cs124.baf~


<<<<<<<< d5/d5124tmp.baf

>>>>>>>>
COPY ~d5/d5124tmp.baf~ ~weidu_external/%MOD_FOLDER%/compile/d5124tmp.baf~

COPY_EXISTING ~d5csdlg.2da~ ~override~
  COUNT_2DA_COLS cols
  COUNT_2DA_ROWS cols rows
  FOR (row = 0; row < rows; ++row) BEGIN
    FOR (col = 1; col < cols; ++col) BEGIN
      READ_2DA_ENTRY 0 col cols class_name
      READ_2DA_ENTRY row 1 cols stat
      READ_2DA_ENTRY row col cols val
//      PATCH_PRINT ~%class_name% - %stat% - %val%~
      PATCH_IF (~%stat%~ STRING_CONTAINS_REGEXP ~124~) = 0 BEGIN
        PATCH_IF (~%val%~ STRING_EQUAL_CASE ~1~) BEGIN
          INNER_ACTION BEGIN
            APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5124tmp.baf~ 
~
IF
	NumberOfTimesTalkedTo(0)
	Class(LastSummonerOf(Myself),%class_name%)
THEN
	RESPONSE #100
	SetGlobal("D5CS%stat%","GLOBAL",1)
	Continue()
END
~
          END
        END
      END
    END
  END
BUT_ONLY

EXTEND_TOP ~d5cs124.bcs~ ~weidu_external/%MOD_FOLDER%/compile/d5124tmp.baf~

//__________________________________________________________________________________

<<<<<<<< d5/d5cs127.d
BEGIN ~D5CS127~

IF ~Global("D5CS127","GLOBAL",1)~ THEN BEGIN d5cs127
 SAY @12001
 IF ~GlobalGT("D5CS127A","GLOBAL",0) OR(2) Global("D5CSM1","LOCALS",0) Global("D5CSM1","LOCALS",2)~ THEN REPLY @12051 GOTO d5cs127_1		//	lore bonus
 IF ~GlobalGT("D5CS127B","GLOBAL",0) OR(2) Global("D5CSM2","LOCALS",0) Global("D5CSM2","LOCALS",2)~ THEN REPLY @12053 GOTO d5cs127_2		//	tracking
 IF ~GlobalGT("D5CS127C","GLOBAL",0) OR(2) Global("D5CSM3","LOCALS",0) Global("D5CSM3","LOCALS",2)~ THEN REPLY @12055 GOTO d5cs127_3		//	flaming weapon
 IF ~GlobalGT("D5CS127D","GLOBAL",0) OR(2) Global("D5CSM4","LOCALS",0) Global("D5CSM4","LOCALS",2)~ THEN REPLY @12057 GOTO d5cs127_4		//	grease jar/smoke bomb
 IF ~GlobalGT("D5CS127E","GLOBAL",0) OR(2) Global("D5CSM5","LOCALS",0) Global("D5CSM5","LOCALS",2)~ THEN REPLY @12059 GOTO d5cs127_5		//	escape artist
 IF ~GlobalGT("D5CS127F","GLOBAL",0) OR(2) Global("D5CSM6","LOCALS",0) Global("D5CSM6","LOCALS",2)~ THEN REPLY @12061 GOTO d5cs127_6		//	slippery mind
 IF ~GlobalGT("D5CS127G","GLOBAL",0) OR(2) Global("D5CSM7","LOCALS",0) Global("D5CSM7","LOCALS",2)~ THEN REPLY @12063 GOTO d5cs127_7		//	luck bonus
END

IF ~~ THEN BEGIN d5cs127_1 											// lore bonus
 SAY @12052
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSM1","LOCALS",1)~ DO ~ApplySpellRES("D5CSM1L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs127 
END
IF ~~ THEN BEGIN d5cs127_2											// tracking
 SAY @12054
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSM2","LOCALS",1)~ DO ~ApplySpellRES("D5CSM2L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs127 
END
IF ~~ THEN BEGIN d5cs127_3 											// flaming weapon
 SAY @12056
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSM3","LOCALS",1)~ DO ~ApplySpellRES("D5CSM3L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs127 
END
IF ~~ THEN BEGIN d5cs127_4 											// grease jar/smoke bomb
 SAY @12058
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSM4","LOCALS",1)~ DO ~ApplySpellRES("D5CSM4L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs127 
END
IF ~~ THEN BEGIN d5cs127_5 											// escape artist
 SAY @12060
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSM5","LOCALS",1)~ DO ~ApplySpellRES("D5C5MFL",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs127 
END
IF ~~ THEN BEGIN d5cs127_6 											// slippery mind
 SAY @12062
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSM6","LOCALS",1)~ DO ~ApplySpellRES("D5CSM6L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs127 
END
IF ~~ THEN BEGIN d5cs127_7 											// luck bonus
 SAY @12064
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSM7","LOCALS",1)~ DO ~ApplySpellRES("D5CSM7L",Myself)~ EXIT
 IF ~~ THEN REPLY @12003 GOTO d5cs127 
END
>>>>>>>>

COPY ~d5/d5cs127.d~ ~weidu_external/%MOD_FOLDER%/compile/d5cs127.d~
  PATCH_IF (FILE_EXISTS_IN_GAME ~d5__psionics.d5~) BEGIN
    REPLACE_TEXTUALLY 
~~~~~GOTO d5cs127_7.+$~~~~~
~~~~~GOTO d5cs127_7     // luck bonus
 IF ~GlobalGT("D5CS127H","GLOBAL",0) OR(2) Global("D5CSM8","LOCALS",0) Global("D5CSM8","LOCALS",2)~ THEN REPLY @12065 GOTO d5cs127_8     // wild talent %WNL%~~~~~
  END

ACTION_IF (FILE_EXISTS_IN_GAME ~d5__psionics.d5~) BEGIN
  APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5cs127.d~
~~~~~
IF ~~ THEN BEGIN d5cs127_8 											// wild talent
%WNL% SAY @12066
%WNL% IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSM8","LOCALS",1)~ DO ~ApplySpellRES("D5CSM8L",Myself)~ EXIT 
%WNL% IF ~~ THEN REPLY @12003 GOTO d5cs127
%WNL%END
~~~~~
END

COMPILE ~weidu_external/%MOD_FOLDER%/compile/d5cs127.d~


<<<<<<<< d5/d5cs127.baf

>>>>>>>>
COPY ~d5/d5cs127.baf~ ~weidu_external/%MOD_FOLDER%/compile/d5cs127.baf~

APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5cs127.baf~
~
IF
	NumberOfTimesTalkedTo(0)
THEN
	RESPONSE #100
	SetGlobal("D5CS127","GLOBAL",1)
	SetNumTimesTalkedTo(1)
	ActionOverride(LastSummonerOf(Myself),StartDialogOverride("D5CS127",Myself))
END

IF
	True()
THEN
	RESPONSE #100
	SetGlobal("D5CS127","GLOBAL",0)
	SetGlobal("D5CS127A","GLOBAL",0)
	SetGlobal("D5CS127B","GLOBAL",0)
	SetGlobal("D5CS127C","GLOBAL",0)
	SetGlobal("D5CS127D","GLOBAL",0)
	SetGlobal("D5CS127E","GLOBAL",0)
	SetGlobal("D5CS127F","GLOBAL",0)
	SetGlobal("D5CS127G","GLOBAL",0)
	SetGlobal("D5CS127H","GLOBAL",0)
	SetGlobal("D5CS127I","GLOBAL",0)
	SetNumTimesTalkedTo(0)
	ApplySpellRES("D5CS000",LastSummonerOf(Myself))
	DestroySelf() 
END
~

COMPILE ~weidu_external/%MOD_FOLDER%/compile/d5cs127.baf~


<<<<<<<< d5/d5127tmp.baf

>>>>>>>>
COPY ~d5/d5127tmp.baf~ ~weidu_external/%MOD_FOLDER%/compile/d5127tmp.baf~

COPY_EXISTING ~d5csdlg.2da~ ~override~
  COUNT_2DA_COLS cols
  COUNT_2DA_ROWS cols rows
  FOR (row = 0; row < rows; ++row) BEGIN
    FOR (col = 1; col < cols; ++col) BEGIN
      READ_2DA_ENTRY 0 col cols class_name
      READ_2DA_ENTRY row 1 cols stat
      READ_2DA_ENTRY row col cols val
//      PATCH_PRINT ~%class_name% - %stat% - %val%~
      PATCH_IF (~%stat%~ STRING_CONTAINS_REGEXP ~127~) = 0 BEGIN
        PATCH_IF (~%val%~ STRING_EQUAL_CASE ~1~) BEGIN
          INNER_ACTION BEGIN
            APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5127tmp.baf~ 
~
IF
	NumberOfTimesTalkedTo(0)
	Class(LastSummonerOf(Myself),%class_name%)
THEN
	RESPONSE #100
	SetGlobal("D5CS%stat%","GLOBAL",1)
	Continue()
END
~
          END
        END
      END
    END
  END
BUT_ONLY

EXTEND_TOP ~d5cs127.bcs~ ~weidu_external/%MOD_FOLDER%/compile/d5127tmp.baf~

//__________________________________________________________________________________

<<<<<<<< d5/d5cs110.d
BEGIN ~D5CS110~

IF ~Global("D5CS110","GLOBAL",1)~ THEN BEGIN d5cs110
 SAY @12001
 IF ~GlobalGT("D5CS110A","GLOBAL",0) OR(2) Global("D5CSI1","LOCALS",0) Global("D5CSI1","LOCALS",2)~ THEN REPLY @12071 GOTO d5cs110_1		//	UMD
 IF ~GlobalGT("D5CS110B","GLOBAL",0) OR(2) Global("D5CSI2","LOCALS",0) Global("D5CSI2","LOCALS",2)~ THEN REPLY @12073 GOTO d5cs110_2		//	Color Spray
 IF ~GlobalGT("D5CS110C","GLOBAL",0) OR(2) Global("D5CSI3","LOCALS",0) Global("D5CSI3","LOCALS",2)~ THEN REPLY @12075 GOTO d5cs110_3		//	Reflected Image
 IF ~GlobalGT("D5CS110D","GLOBAL",0) OR(2) Global("D5CSI4","LOCALS",0) Global("D5CSI4","LOCALS",2)~ THEN REPLY @12077 GOTO d5cs110_4		//	Blur
 IF ~GlobalGT("D5CS110E","GLOBAL",0) OR(2) Global("D5CSI5","LOCALS",0) Global("D5CSI5","LOCALS",2)~ THEN REPLY @12079 GOTO d5cs110_5		//	Knock
 IF ~GlobalGT("D5CS110F","GLOBAL",0) OR(2) Global("D5CSI6","LOCALS",0) Global("D5CSI6","LOCALS",2)~ THEN REPLY @12081 GOTO d5cs110_6		//	Luck
 IF ~GlobalGT("D5CS110G","GLOBAL",0) OR(2) Global("D5CSI7","LOCALS",0) Global("D5CSI7","LOCALS",2)~ THEN REPLY @12083 GOTO d5cs110_7		//	Glitterdust
 IF ~GlobalGT("D5CS110H","GLOBAL",0) OR(2) Global("D5CSI8","LOCALS",0) Global("D5CSI8","LOCALS",2)~ THEN REPLY @12085 GOTO d5cs110_8		//	Sanctuary
 IF ~GlobalGT("D5CS110I","GLOBAL",0) OR(2) Global("D5CSI9","LOCALS",0) Global("D5CSI9","LOCALS",2)~ THEN REPLY @12087 GOTO d5cs110_9		//	Shadowstep
END

IF ~~ THEN BEGIN d5cs110_1 											// UMD
 SAY @12072
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSI1","LOCALS",1)~ DO ~ApplySpellRES("D5CSI1L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs110 
END
IF ~~ THEN BEGIN d5cs110_2											// Color Spray
 SAY @12074
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSI2","LOCALS",1)~ DO ~ApplySpellRES("D5CSI2L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs110 
END
IF ~~ THEN BEGIN d5cs110_3 											// Reflected Image
 SAY @12076
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSI3","LOCALS",1)~ DO ~ApplySpellRES("D5CSI3L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs110 
END
IF ~~ THEN BEGIN d5cs110_4 											// Blur
 SAY @12078
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSI4","LOCALS",1)~ DO ~ApplySpellRES("D5CSI4L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs110 
END
IF ~~ THEN BEGIN d5cs110_5 											// Knock
 SAY @12080
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSI5","LOCALS",1)~ DO ~ApplySpellRES("D5CSI5L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs110 
END
IF ~~ THEN BEGIN d5cs110_6 											// Luck
 SAY @12082
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSI6","LOCALS",1)~ DO ~ApplySpellRES("D5CSI6L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs110 
END
IF ~~ THEN BEGIN d5cs110_7 											// Glitterdust
 SAY @12084
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSI7","LOCALS",1)~ DO ~ApplySpellRES("D5CSI7L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs110 
END
IF ~~ THEN BEGIN d5cs110_8 											// Sanctuary
 SAY @12086
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSI8","LOCALS",1)~ DO ~ApplySpellRES("D5CSI8L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs110 
END
IF ~~ THEN BEGIN d5cs110_9 											// Shadowstep
 SAY @12088
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSI9","LOCALS",1)~ DO ~ApplySpellRES("D5CSI9L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs110 
END
>>>>>>>>

COPY ~d5/d5cs110.d~ ~weidu_external/%MOD_FOLDER%/compile/d5cs110.d~

COMPILE ~weidu_external/%MOD_FOLDER%/compile/d5cs110.d~


<<<<<<<< d5/d5cs110.baf

>>>>>>>>
COPY ~d5/d5cs110.baf~ ~weidu_external/%MOD_FOLDER%/compile/d5cs110.baf~

APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5cs110.baf~
~IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),STALKER)
THEN
	RESPONSE #100
	SetGlobal("D5CS110A","GLOBAL",0)
	Continue()
END
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),SHADOWDANCER)
THEN
	RESPONSE #100
	SetGlobal("D5CS110B","GLOBAL",0)
	Continue()
END
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),SHADOWDANCER)
THEN
	RESPONSE #100
	SetGlobal("D5CS110G","GLOBAL",0)
	Continue()
END
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),SHADOWDANCER)
THEN
	RESPONSE #100
	SetGlobal("D5CS110I","GLOBAL",0)
	Continue()
END
~

ACTION_IF (VARIABLE_IS_SET %d5_shadowdancer_code%) BEGIN
  APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5cs110.baf~
~
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),D5SHADD)
THEN
	RESPONSE #100
	SetGlobal("D5CS110B","GLOBAL",0)
	Continue()
END
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),D5SHADD)
THEN
	RESPONSE #100
	SetGlobal("D5CS110G","GLOBAL",0)
	Continue()
END
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),D5SHADD)
THEN
	RESPONSE #100
	SetGlobal("D5CS110I","GLOBAL",0)
	Continue()
END
~
END

APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5cs110.baf~
~
IF
	NumberOfTimesTalkedTo(0)
THEN
	RESPONSE #100
	SetGlobal("D5CS110","GLOBAL",1)
	SetNumTimesTalkedTo(1)
	ActionOverride(LastSummonerOf(Myself),StartDialogOverride("D5CS110",Myself))
END

IF
	True()
THEN
	RESPONSE #100
	SetGlobal("D5CS110","GLOBAL",0)
	SetGlobal("D5CS110A","GLOBAL",0)
	SetGlobal("D5CS110B","GLOBAL",0)
	SetGlobal("D5CS110C","GLOBAL",0)
	SetGlobal("D5CS110D","GLOBAL",0)
	SetGlobal("D5CS110E","GLOBAL",0)
	SetGlobal("D5CS110F","GLOBAL",0)
	SetGlobal("D5CS110G","GLOBAL",0)
	SetGlobal("D5CS110H","GLOBAL",0)
	SetGlobal("D5CS110I","GLOBAL",0)
	SetNumTimesTalkedTo(0)
	ApplySpellRES("D5CS000",LastSummonerOf(Myself))
	DestroySelf() 
END
~

COMPILE ~weidu_external/%MOD_FOLDER%/compile/d5cs110.baf~


<<<<<<<< d5/d5110tmp.baf

>>>>>>>>
COPY ~d5/d5110tmp.baf~ ~weidu_external/%MOD_FOLDER%/compile/d5110tmp.baf~

COPY_EXISTING ~d5csdlg.2da~ ~override~
  COUNT_2DA_COLS cols
  COUNT_2DA_ROWS cols rows
  FOR (row = 0; row < rows; ++row) BEGIN
    FOR (col = 1; col < cols; ++col) BEGIN
      READ_2DA_ENTRY 0 col cols class_name
      READ_2DA_ENTRY row 1 cols stat
      READ_2DA_ENTRY row col cols val
//      PATCH_PRINT ~%class_name% - %stat% - %val%~
      PATCH_IF (~%stat%~ STRING_CONTAINS_REGEXP ~110~) = 0 BEGIN
        PATCH_IF (~%val%~ STRING_EQUAL_CASE ~1~) BEGIN
          INNER_ACTION BEGIN
            APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5110tmp.baf~ 
~
IF
	NumberOfTimesTalkedTo(0)
	Class(LastSummonerOf(Myself),%class_name%)
THEN
	RESPONSE #100
	SetGlobal("D5CS%stat%","GLOBAL",1)
	Continue()
END
~
          END
        END
      END
    END
  END
BUT_ONLY

EXTEND_TOP ~d5cs110.bcs~ ~weidu_external/%MOD_FOLDER%/compile/d5110tmp.baf~

//__________________________________________________________________________________




//__________________________________________________________________________________
//
//								MODIFY GAME TEXT
//__________________________________________________________________________________


//update proficiency strings_________________________________________________________
//
COPY_EXISTING ~weapprof.2da~ ~override~
  COUNT_2DA_COLS cols
  COUNT_2DA_ROWS cols rows
  FOR (row = 7; row < rows; ++row) BEGIN
    READ_2DA_ENTRY row 1 cols stat
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~89~) BEGIN
      SET_2DA_ENTRY row 2 cols %staff_weapon_name%
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12089)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~90~) BEGIN
      SET_2DA_ENTRY row 2 cols RESOLVE_STR_REF (@12140)
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12090)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~91~) BEGIN
//      SET_2DA_ENTRY row 2 cols 25002
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12091)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~92~) BEGIN
//      SET_2DA_ENTRY row 2 cols 25003
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12092)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~93~) BEGIN
//      SET_2DA_ENTRY row 2 cols 25004
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12093)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~94~) BEGIN
//      SET_2DA_ENTRY row 2 cols 25005
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12094)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~95~) BEGIN
      SET_2DA_ENTRY row 2 cols RESOLVE_STR_REF (@12145)
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12095)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~96~) BEGIN
      SET_2DA_ENTRY row 2 cols RESOLVE_STR_REF (@12146)
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12096)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~97~) BEGIN
//      SET_2DA_ENTRY row 2 cols 25008
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12097)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~98~) BEGIN
      SET_2DA_ENTRY row 2 cols RESOLVE_STR_REF (@12148)
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12098)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~99~) BEGIN
      SET_2DA_ENTRY row 2 cols RESOLVE_STR_REF (@12149)
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12099)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~100~) BEGIN
//      SET_2DA_ENTRY row 2 cols 25012
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12100)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~101~) BEGIN
      SET_2DA_ENTRY row 2 cols %sling_weapon_name%
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12101)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~102~) BEGIN
      SET_2DA_ENTRY row 2 cols RESOLVE_STR_REF (@12152)
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12102)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~103~) BEGIN
//      SET_2DA_ENTRY row 2 cols // no change here
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12103)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~104~) BEGIN
      SET_2DA_ENTRY row 2 cols RESOLVE_STR_REF (@12154)
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12104)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~105~) BEGIN
      SET_2DA_ENTRY row 2 cols RESOLVE_STR_REF (@12155)
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12105)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~106~) BEGIN
      SET_2DA_ENTRY row 2 cols RESOLVE_STR_REF (@12156)
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12106)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~107~) BEGIN
      SET_2DA_ENTRY row 2 cols RESOLVE_STR_REF (@12157)
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12107)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~108~) BEGIN
      SET_2DA_ENTRY row 2 cols RESOLVE_STR_REF (@12158)
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12108)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~109~) BEGIN
      SET_2DA_ENTRY row 2 cols RESOLVE_STR_REF (@12159)
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12109)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~115~) BEGIN
      SET_2DA_ENTRY row 2 cols RESOLVE_STR_REF (@12165)
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12115)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~124~) BEGIN
      SET_2DA_ENTRY row 2 cols RESOLVE_STR_REF (@12174)
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12124)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~127~) BEGIN
      SET_2DA_ENTRY row 2 cols RESOLVE_STR_REF (@12177)
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12127)
    END
    PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~110~) BEGIN
      SET_2DA_ENTRY row 2 cols RESOLVE_STR_REF (@12160)
      SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (@12110)
    END
  END
BUT_ONLY
//__________________________________________________________________________________


//update class strings______________________________________________________________
//
OUTER_SPRINT berserker_profs_desc @12221
OUTER_SPRINT archer_profs_desc @12222
OUTER_SPRINT stalker_profs_desc @12223
OUTER_SPRINT assassin_profs_desc @12224
OUTER_SPRINT swashbuckler_profs_desc @12225
OUTER_SPRINT shadowdancer_profs_desc @12226

ACTION_FOR_EACH text_file IN ~clastext~ ~sodcltxt~ ~bgclatxt~ BEGIN
  COPY_EXISTING ~%text_file%.2da~ ~override~
    COUNT_2DA_COLS cols
    COUNT_2DA_ROWS cols rows
/* don't need these we are overwriting them
    READ_2DA_ENTRY 0 4 cols fighter_desc
    READ_2DA_ENTRY 5 4 cols ranger_desc
    READ_2DA_ENTRY 13 4 cols paladin_desc
    READ_2DA_ENTRY 22 4 cols cleric_desc
    READ_2DA_ENTRY 28 4 cols druid_desc
    READ_2DA_ENTRY 32 4 cols mage_desc
    READ_2DA_ENTRY 42 4 cols thief_desc
    READ_2DA_ENTRY 47 4 cols bard_desc
    READ_2DA_ENTRY 51 4 cols sorcerer_desc
    READ_2DA_ENTRY 53 4 cols monk_desc
    READ_2DA_ENTRY 57 4 cols shaman_desc
*/
    FOR (row = 1; row < rows; ++row) BEGIN
      READ_2DA_ENTRY row 0 cols kit_name
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~BERSERKER~) BEGIN
        READ_2DA_ENTRY row 4 cols berserker_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~BARBARIAN~) BEGIN
        READ_2DA_ENTRY row 4 cols babarian_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5RBARB~) BEGIN
        READ_2DA_ENTRY row 4 cols d5rbarb_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~ARCHER~) BEGIN
        READ_2DA_ENTRY row 4 cols archer_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5MARKS~) BEGIN
        READ_2DA_ENTRY row 4 cols d5marks_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5SLING~) BEGIN
        READ_2DA_ENTRY row 4 cols d5sling_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5SNIPE~) BEGIN
        READ_2DA_ENTRY row 4 cols d5snipe_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5EARCH~) BEGIN
        READ_2DA_ENTRY row 4 cols d5earch_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~NMRNBSLN~) BEGIN
        READ_2DA_ENTRY row 4 cols nmrnbsln_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~SWASHBUCKLER~) BEGIN
        READ_2DA_ENTRY row 4 cols swashbuckler_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5CORSA~) BEGIN
        READ_2DA_ENTRY row 4 cols d5corsa_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~ASSASSIN~) BEGIN
        READ_2DA_ENTRY row 4 cols assassin_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~SHADOWDANCER~) BEGIN
        READ_2DA_ENTRY row 4 cols shadowdancer_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5SHADD~) BEGIN
        READ_2DA_ENTRY row 4 cols d5shadd_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~IK_BATTLERAGER~) BEGIN
        READ_2DA_ENTRY row 4 cols ik_battlerager_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~c0tbm~) BEGIN
        READ_2DA_ENTRY row 4 cols c0tbm_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~UB_SH~) BEGIN
        READ_2DA_ENTRY row 4 cols ub_sh_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~A7_MARKSMAN~) BEGIN
        READ_2DA_ENTRY row 4 cols a7_marksman_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~A7_BOWKNIGHT~) BEGIN
        READ_2DA_ENTRY row 4 cols a7_bowknight_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~A7_SHARPSHOOTER~) BEGIN
        READ_2DA_ENTRY row 4 cols a7_sharpshooter_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~CDArcSyl~) BEGIN
        READ_2DA_ENTRY row 4 cols cdarcsyl_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~c0aa~) BEGIN
        READ_2DA_ENTRY row 4 cols c0aa_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~C0ADVENT~) BEGIN
        READ_2DA_ENTRY row 4 cols c0advent_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~USAF00~) BEGIN
        READ_2DA_ENTRY row 4 cols usaf00_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~USAP00~) BEGIN
        READ_2DA_ENTRY row 4 cols usap00_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~USAT00~) BEGIN
        READ_2DA_ENTRY row 4 cols usat00_desc
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D2WARHOUND~) BEGIN
        READ_2DA_ENTRY row 4 cols d2warhound_desc
      END
    END
  IF_EXISTS BUT_ONLY

  ACTION_IF (VARIABLE_IS_SET %berserker_desc%) BEGIN
    ACTION_GET_STRREF %berserker_desc% berserker_description
    OUTER_SPRINT new_berserker_desc ~%berserker_description%~^~%berserker_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %barbarian_desc%) BEGIN
    ACTION_GET_STRREF %barbarian_desc% barbarian_description
    OUTER_SPRINT new_barbarian_desc ~%barbarian_description%~^~%barbarian_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %d5rbarb_desc%) BEGIN
    ACTION_GET_STRREF %d5rbarb_desc% d5rbarb_description
    OUTER_SPRINT new_d5rbarb_desc ~%bd5rbarb_description%~^~%barbarian_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %archer_desc%) BEGIN
    ACTION_GET_STRREF %archer_desc% archer_description
    OUTER_SPRINT new_archer_desc ~%archer_description%~^~%archer_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %d5marks_desc%) BEGIN
    ACTION_GET_STRREF %d5marks_desc% d5marks_description
    OUTER_SPRINT new_d5marks_desc ~%d5marks_description%~^~%archer_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %d5sling_desc%) BEGIN
    ACTION_GET_STRREF %d5sling_desc% d5sling_description
    OUTER_SPRINT new_d5sling_desc ~%d5sling_description%~^~%archer_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %d5snipe_desc%) BEGIN
    ACTION_GET_STRREF %d5snipe_desc% d5snipe_description
    OUTER_SPRINT new_d5snipe_desc ~%d5snipe_description%~^~%archer_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %d5earch_desc%) BEGIN
    ACTION_GET_STRREF %d5earch_desc% d5earch_description
    OUTER_SPRINT new_d5earch_desc ~%d5earch_description%~^~%archer_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %nmrnbsln_desc%) BEGIN
    ACTION_GET_STRREF %nmrnbsln_desc% nmrnbsln_description
    OUTER_SPRINT new_nmrnbsln_desc ~%nmrnbsln_description%~^~%archer_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %stalker_desc%) BEGIN
    ACTION_GET_STRREF %stalker_desc% stalker_description
    OUTER_SPRINT new_stalker_desc ~%stalker_description%~^~%stalker_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %assassin_desc%) BEGIN
    ACTION_GET_STRREF %assassin_desc% assassin_description
    OUTER_SPRINT new_assassin_desc ~%assassin_description%~^~%assassin_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %swashbuckler_desc%) BEGIN
    ACTION_GET_STRREF %swashbuckler_desc% swashbuckler_description
    OUTER_SPRINT new_swashbuckler_desc ~%swashbuckler_description%~^~%swashbuckler_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %d5corsa_desc%) BEGIN
    ACTION_GET_STRREF %d5corsa_desc% d5corsa_description
    OUTER_SPRINT new_d5corsa_desc ~%d5corsa_description%~^~%swashbuckler_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %shadowdancer_desc%) BEGIN
    ACTION_GET_STRREF %shadowdancer_desc% shadowdancer_description
    OUTER_SPRINT new_shadowdancer_desc ~%shadowdancer_description%~^~%shadowdancer_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %d5shadd_desc%) BEGIN
    ACTION_GET_STRREF %d5shadd_desc% d5shadd_description
    OUTER_SPRINT new_d5shadd_desc ~%d5shadd_description%~^~%shadowdancer_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %_desc%) BEGIN
    ACTION_GET_STRREF %ik_battlerager_desc% ik_battlerager_description
    OUTER_SPRINT new_ik_battlerager_desc ~%ik_battlerager_description%~^~%berserker_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %c0tbm_desc%) BEGIN
    ACTION_GET_STRREF %c0tbm_desc% c0tbm_description
    OUTER_SPRINT new_c0tbm_desc ~%c0tbm_description%~^~%berserker_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %ub_sh_desc%) BEGIN
    ACTION_GET_STRREF %ub_sh_desc% ub_sh_description
    OUTER_SPRINT new_ub_sh_desc ~%ub_sh_description%~^~%archer_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %a7_marksman_desc%) BEGIN
    ACTION_GET_STRREF %a7_marksman_desc% a7_marksman_description
    OUTER_SPRINT new_a7_marksman_desc ~%a7_marksman_description%~^~%archer_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %a7_bowknight_desc%) BEGIN
    ACTION_GET_STRREF %a7_bowknight_desc% a7_bowknight_description
    OUTER_SPRINT new_a7_bowknight_desc ~%a7_bowknight_description%~^~%archer_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %a7_sharpshooter_desc%) BEGIN
    ACTION_GET_STRREF %a7_sharpshooter_desc% a7_sharpshooter_description
    OUTER_SPRINT new_a7_sharpshooter_desc ~%a7_sharpshooter_description%~^~%archer_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %cdarcsyl_desc%) BEGIN
    ACTION_GET_STRREF %cdarcsyl_desc% cdarcsyl_description
    OUTER_SPRINT new_cdarcsyl_desc ~%cdarcsyl_description%~^~%archer_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %c0aa_desc%) BEGIN
    ACTION_GET_STRREF %c0aa_desc% c0aa_description
    OUTER_SPRINT new_c0aa_desc ~%c0aa_description%~^~%archer_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %c0advent_desc%) BEGIN
    ACTION_GET_STRREF %c0advent_desc% c0advent_description
    OUTER_SPRINT new_c0advent_desc ~%c0advent_description%~^~%archer_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %usaf00_desc%) BEGIN
    ACTION_GET_STRREF %usaf00_desc% usaf00_description
    OUTER_SPRINT new_usaf00_desc ~%usaf00_description%~^~%archer_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %usap00_desc%) BEGIN
    ACTION_GET_STRREF %usap00_desc% usap00_description
    OUTER_SPRINT new_usap00_desc ~%usap00_description%~^~%archer_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %usat00_desc%) BEGIN
    ACTION_GET_STRREF %usat00_desc% usat00_description
    OUTER_SPRINT new_usat00_desc ~%usat00_description%~^~%archer_profs_desc%~
  END
  ACTION_IF (VARIABLE_IS_SET %d2warhound_desc%) BEGIN
    ACTION_GET_STRREF %d2warhound_desc% d2warhound_description
    OUTER_SPRINT new_d2warhound_desc ~%d2warhound_description%~^~%archer_profs_desc%~
  END

  COPY_EXISTING ~%text_file%.2da~ ~override~
    COUNT_2DA_COLS cols
    COUNT_2DA_ROWS cols rows
    FOR (row = 1; row < rows; ++row) BEGIN
      READ_2DA_ENTRY row 0 cols kit_name
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~FIGHTER~) BEGIN
        SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (@12201)
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~RANGER~) BEGIN
        SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (@12202)
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~PALADIN~) BEGIN
        SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (@12203)
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~CLERIC~) BEGIN
        SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (@12204)
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~DRUID~) BEGIN
        SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (@12205)
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~MAGE~) BEGIN
        SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (@12206)
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~THIEF~) BEGIN
        SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (@12207)
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~BARD~) BEGIN
        SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (@12208)
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~SORCERER~) BEGIN
        SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (@12209)
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~MONK~) BEGIN
        SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (@12210)
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~SHAMAN~) BEGIN
        SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (@12211)
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~BERSERKER~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %new_berserker_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%new_berserker_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~BARBARIAN~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %new_babarian_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%new_babarian_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5RBARB~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %new_d5rbarb_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%new_d5rbarb_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~ARCHER~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %new_archer_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%new_archer_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5MARKS~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %new_d5marks_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%new_d5marks_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5SLING~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %new_d5sling_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%new_d5sling_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5SNIPE~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %new_d5snipe_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%new_d5snipe_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5EARCH~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %new_d5earch_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%new_d5earch_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~NMRNBSLN~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %new_nmrnbsln_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%new_nmrnbsln_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~SWASHBUCKLER~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %new_swashbuckler_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%new_swashbuckler_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5CORSA~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %new_d5corsa_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%new_d5corsa_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~ASSASSIN~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %new_assassin_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%new_assassin_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~SHADOWDANCER~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %new_shadowdancer_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%new_shadowdancer_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5SHADD~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %new_d5shadd_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%new_d5shadd_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~IK_BATTLERAGER~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %ik_battlerager_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%ik_battlerager_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~c0tbm~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %c0tbm_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%c0tbm_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~UB_SH~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %ub_sh_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%ub_sh_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~A7_MARKSMAN~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %a7_marksman_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%a7_marksman_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~A7_BOWKNIGHT~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %a7_bowknight_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%a7_bowknight_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~A7_SHARPSHOOTER~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %a7_sharpshooter_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%a7_sharpshooter_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~CDArcSyl~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %cdarcsyl_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%cdarcsyl_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~c0aa~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %c0aa_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%c0aa_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~C0ADVENT~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %c0advent_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%c0advent_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~USAF00~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %usaf00_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%usaf00_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~USAP00~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %usap00_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%usap00_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~USAT00~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %usat00_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%usat00_desc%~)
        END
      END
      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D2WARHOUND~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %d2warhound_desc%) BEGIN
          SET_2DA_ENTRY row 4 cols RESOLVE_STR_REF (~%d2warhound_desc%~)
        END
      END
    END
  IF_EXISTS BUT_ONLY
END

OUTER_SPRINT halfling_profs_desc @12240

ACTION_FOR_EACH text_file IN ~racetext~ ~sodrace~ ~bgractxt~ BEGIN
  COPY_EXISTING ~%text_file%.2da~ ~override~
    COUNT_2DA_COLS cols
    COUNT_2DA_ROWS cols rows
    FOR (row = 1; row < rows; ++row) BEGIN
      READ_2DA_ENTRY row 0 cols race_name
      PATCH_IF (~%race_name%~ STRING_EQUAL_CASE ~HALFLING~) BEGIN
        READ_2DA_ENTRY row 3 cols halfling_desc
      END
    END
  IF_EXISTS BUT_ONLY

  ACTION_IF (VARIABLE_IS_SET %halfling_desc%) BEGIN
    ACTION_GET_STRREF %halfling_desc% halfling_description
    OUTER_SPRINT new_halfling_desc ~%halfling_description%~^~%halfling_profs_desc%~
  END

  COPY_EXISTING ~%text_file%.2da~ ~override~
    COUNT_2DA_COLS cols
    COUNT_2DA_ROWS cols rows
    FOR (row = 1; row < rows; ++row) BEGIN
      READ_2DA_ENTRY row 0 cols race_name
      PATCH_IF (~%race_name%~ STRING_EQUAL_CASE ~HALFLING~) BEGIN
        PATCH_IF (VARIABLE_IS_SET %new_halfling_desc%) BEGIN
          SET_2DA_ENTRY row 3 cols RESOLVE_STR_REF (~%new_halfling_desc%~)
        END
      END
    END
  IF_EXISTS BUT_ONLY
END

//__________________________________________________________________________________



//__________________________________________________________________________________
//
//								APPLY PROF EFFECTS
//__________________________________________________________________________________



COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs000.spl~
// attack speed
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 1 parameter2 = %prof_104_beq% timing = 1 STR_VAR resource = ~d5cs104a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 2 parameter2 = %prof_104_beq% timing = 1 STR_VAR resource = ~d5cs104b~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 3 parameter2 = %prof_104_beq% timing = 1 STR_VAR resource = ~d5cs104c~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_104_beq% timing = 1 STR_VAR resource = ~d5cs104d~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_104_beq% timing = 1 STR_VAR resource = ~d5cs104e~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 6 parameter2 = %prof_104_beq% timing = 1 STR_VAR resource = ~d5cs104g~ END
//  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 7 parameter2 = %prof_104_beq% timing = 1 STR_VAR resource = ~d5cs104g~ END
// dodge
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 1 parameter2 = %prof_105_beq% timing = 1 STR_VAR resource = ~d5cs105a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 2 parameter2 = %prof_105_beq% timing = 1 STR_VAR resource = ~d5cs105b~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 3 parameter2 = %prof_105_beq% timing = 1 STR_VAR resource = ~d5cs105c~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_105_beq% timing = 1 STR_VAR resource = ~d5cs105d~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_105_beq% timing = 1 STR_VAR resource = ~d5cs105e~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 6 parameter2 = %prof_105_beq% timing = 1 STR_VAR resource = ~d5cs105f~ END
//  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 7 parameter2 = %prof_105_beq% timing = 1 STR_VAR resource = ~d5cs105g~ END
// backstab bonus
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 1 parameter2 = %prof_106_beq% timing = 1 STR_VAR resource = ~d5cs106a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 2 parameter2 = %prof_106_beq% timing = 1 STR_VAR resource = ~d5cs106b~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 3 parameter2 = %prof_106_beq% timing = 1 STR_VAR resource = ~d5cs106c~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_106_beq% timing = 1 STR_VAR resource = ~d5cs106d~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_106_beq% timing = 1 STR_VAR resource = ~d5cs106e~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 6 parameter2 = %prof_106_beq% timing = 1 STR_VAR resource = ~d5cs106f~ END
//  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 7 parameter2 = %prof_106_beq% timing = 1 STR_VAR resource = ~d5cs106g~ END
// set snares
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 1 parameter2 = %prof_107_beq% timing = 1 STR_VAR resource = ~d5cs107a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 2 parameter2 = %prof_107_beq% timing = 1 STR_VAR resource = ~d5cs107b~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 3 parameter2 = %prof_107_beq% timing = 1 STR_VAR resource = ~d5cs107c~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_107_beq% timing = 1 STR_VAR resource = ~d5cs107d~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_107_beq% timing = 1 STR_VAR resource = ~d5cs107e~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 6 parameter2 = %prof_107_beq% timing = 1 STR_VAR resource = ~d5cs107f~ END
//  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 7 parameter2 = %prof_107_beq% timing = 1 STR_VAR resource = ~d5cs107g~ END
// missile thac0
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 1 parameter2 = %prof_108_beq% timing = 1 STR_VAR resource = ~d5cs108a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 2 parameter2 = %prof_108_beq% timing = 1 STR_VAR resource = ~d5cs108b~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 3 parameter2 = %prof_108_beq% timing = 1 STR_VAR resource = ~d5cs108c~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_108_beq% timing = 1 STR_VAR resource = ~d5cs108d~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_108_beq% timing = 1 STR_VAR resource = ~d5cs108e~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 6 parameter2 = %prof_108_beq% timing = 1 STR_VAR resource = ~d5cs108f~ END
//  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 7 parameter2 = %prof_108_beq% timing = 1 STR_VAR resource = ~d5cs108g~ END
// hurled thac0
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 1 parameter2 = %prof_109_beq% timing = 1 STR_VAR resource = ~d5cs109a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 2 parameter2 = %prof_109_beq% timing = 1 STR_VAR resource = ~d5cs109b~ END
//  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 3 parameter2 = %prof_109_beq% timing = 1 STR_VAR resource = ~d5cs109c~ END
//  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_109_beq% timing = 1 STR_VAR resource = ~d5cs109d~ END
//  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_109_beq% timing = 1 STR_VAR resource = ~d5cs109e~ END
//  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 6 parameter2 = %prof_109_beq% timing = 1 STR_VAR resource = ~d5cs109f~ END
//  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 7 parameter2 = %prof_109_beq% timing = 1 STR_VAR resource = ~d5cs109g~ END
// fighting postures
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 1 parameter2 = %prof_115_beq% timing = 1 STR_VAR resource = ~d5cs115a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 2 parameter2 = %prof_115_beq% timing = 1 STR_VAR resource = ~d5cs115a~ END	//	grant earlier ones too
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 2 parameter2 = %prof_115_beq% timing = 1 STR_VAR resource = ~d5cs115b~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 3 parameter2 = %prof_115_beq% timing = 1 STR_VAR resource = ~d5cs115c~ END	//	but no need when bit  equality
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_115_beq% timing = 1 STR_VAR resource = ~d5cs115a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_115_beq% timing = 1 STR_VAR resource = ~d5cs115b~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_115_beq% timing = 1 STR_VAR resource = ~d5cs115c~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_115_beq% timing = 1 STR_VAR resource = ~d5cs115d~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_115_beq% timing = 1 STR_VAR resource = ~d5cs115b~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_115_beq% timing = 1 STR_VAR resource = ~d5cs115c~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_115_beq% timing = 1 STR_VAR resource = ~d5cs115d~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_115_beq% timing = 1 STR_VAR resource = ~d5cs115e~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 6 parameter2 = %prof_115_beq% timing = 1 STR_VAR resource = ~d5cs115a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 6 parameter2 = %prof_115_beq% timing = 1 STR_VAR resource = ~d5cs115c~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 6 parameter2 = %prof_115_beq% timing = 1 STR_VAR resource = ~d5cs115f~ END
//  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 7 parameter2 = %prof_115_beq% timing = 1 STR_VAR resource = ~d5cs115g~ END
// physical feats
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 1 parameter2 = %prof_124_beq% timing = 1 STR_VAR resource = ~d5cs124a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 2 parameter2 = %prof_124_beq% timing = 1 STR_VAR resource = ~d5cs124a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 2 parameter2 = %prof_124_beq% timing = 1 STR_VAR resource = ~d5cs124b~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 3 parameter2 = %prof_124_beq% timing = 1 STR_VAR resource = ~d5cs124c~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_124_beq% timing = 1 STR_VAR resource = ~d5cs124a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_124_beq% timing = 1 STR_VAR resource = ~d5cs124b~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_124_beq% timing = 1 STR_VAR resource = ~d5cs124c~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_124_beq% timing = 1 STR_VAR resource = ~d5cs124d~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_124_beq% timing = 1 STR_VAR resource = ~d5cs124b~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_124_beq% timing = 1 STR_VAR resource = ~d5cs124c~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_124_beq% timing = 1 STR_VAR resource = ~d5cs124d~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_124_beq% timing = 1 STR_VAR resource = ~d5cs124e~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 6 parameter2 = %prof_124_beq% timing = 1 STR_VAR resource = ~d5cs124a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 6 parameter2 = %prof_124_beq% timing = 1 STR_VAR resource = ~d5cs124c~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 6 parameter2 = %prof_124_beq% timing = 1 STR_VAR resource = ~d5cs124f~ END
//  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 7 parameter2 = %prof_124_beq% timing = 1 STR_VAR resource = ~d5cs124g~ END
// rogue skills
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 1 parameter2 = %prof_127_beq% timing = 1 STR_VAR resource = ~d5cs127a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 2 parameter2 = %prof_127_beq% timing = 1 STR_VAR resource = ~d5cs127a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 2 parameter2 = %prof_127_beq% timing = 1 STR_VAR resource = ~d5cs127b~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 3 parameter2 = %prof_127_beq% timing = 1 STR_VAR resource = ~d5cs127c~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_127_beq% timing = 1 STR_VAR resource = ~d5cs127a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_127_beq% timing = 1 STR_VAR resource = ~d5cs127b~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_127_beq% timing = 1 STR_VAR resource = ~d5cs127c~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_127_beq% timing = 1 STR_VAR resource = ~d5cs127d~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_127_beq% timing = 1 STR_VAR resource = ~d5cs127b~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_127_beq% timing = 1 STR_VAR resource = ~d5cs127c~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_127_beq% timing = 1 STR_VAR resource = ~d5cs127d~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_127_beq% timing = 1 STR_VAR resource = ~d5cs127e~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 6 parameter2 = %prof_127_beq% timing = 1 STR_VAR resource = ~d5cs127a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 6 parameter2 = %prof_127_beq% timing = 1 STR_VAR resource = ~d5cs127c~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 6 parameter2 = %prof_127_beq% timing = 1 STR_VAR resource = ~d5cs127f~ END
//  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 7 parameter2 = %prof_127_beq% timing = 1 STR_VAR resource = ~d5cs127g~ END
// magical skills
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 1 parameter2 = %prof_110_beq% timing = 1 STR_VAR resource = ~d5cs110a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 2 parameter2 = %prof_110_beq% timing = 1 STR_VAR resource = ~d5cs110a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 2 parameter2 = %prof_110_beq% timing = 1 STR_VAR resource = ~d5cs110b~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 3 parameter2 = %prof_110_beq% timing = 1 STR_VAR resource = ~d5cs110c~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_110_beq% timing = 1 STR_VAR resource = ~d5cs110a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_110_beq% timing = 1 STR_VAR resource = ~d5cs110b~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_110_beq% timing = 1 STR_VAR resource = ~d5cs110c~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 4 parameter2 = %prof_110_beq% timing = 1 STR_VAR resource = ~d5cs110d~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_110_beq% timing = 1 STR_VAR resource = ~d5cs110b~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_110_beq% timing = 1 STR_VAR resource = ~d5cs110c~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_110_beq% timing = 1 STR_VAR resource = ~d5cs110d~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 5 parameter2 = %prof_110_beq% timing = 1 STR_VAR resource = ~d5cs110e~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 6 parameter2 = %prof_110_beq% timing = 1 STR_VAR resource = ~d5cs110a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 6 parameter2 = %prof_110_beq% timing = 1 STR_VAR resource = ~d5cs110c~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 6 parameter2 = %prof_110_beq% timing = 1 STR_VAR resource = ~d5cs110f~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 326 parameter1 = 7 parameter2 = %prof_110_beq% timing = 1 STR_VAR resource = ~d5cs110g~ END	//	7 bit equals (includes) everything else

/*
ideas for individual kits:

 - thieves: 
 /...no traps automatically. must buy them with pips. remove from CLABs

 - assassins: 
 /...delete backstab.2da entirely, 
 /...make new version with assassins only at x2
 /...assassins can get 6 pips, other thieves only 4
 /...apply subspell increasing backstab prof by 1 (and 206 vs. the subspell)

 - swashbucklers:
 /...remove AC bonuses (leave thac0 bonuses)
 /...swashies can get 6 pips in dodge, others only 2
 /...apply subspell increasing dodge prof by 1 (and 206 vs. the subspell)
 /...and MnG corsair

 - shadowdancer: 
 /...give shadowstep
 /...give bonus to casting points

 - rangers:
 /...give quickstride (f4l)
 /...need to remove if in clab from MnG
 /...give tracking (m2l)
 /...need to remove if in clab from MnG

 - barbarians:
 /...give quickstride (f4l)
 /...need to remove if in clab from MnG

 - monks:
 /...give quickstride (f4l) if QS already installed by MnG
 /...need to remove if in clab

 - archers:
 /...remove ranged thac0 bonuses from CLAB
 /...apply subspell increasing accuracy prof by 1 (and 206 vs. the subspell)

more fun ideas,  things to do with cs000:
 /- halflings: slings < 2, increase slings by 1
 /- halflings: set hurling to 2
*/

/*
most of this ^^ stuff only needs to be done once. 
so make a clone of cs000, cs001, and put at 1st level in CLABs
*/

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cs001.spl~
// ... (put that special stuff here)
//halflings...
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 5 parameter2 = 104 timing = 1 STR_VAR resource = ~d5cshal1~ END
//barbarians...
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 12 parameter2 = 105 timing = 1 STR_VAR resource = ~d5csbar1~ END
  PATCH_IF (VARIABLE_IS_SET %d5_rbarb_code%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %d5_rbarb_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csbar1~ END
  END
//monks
  PATCH_IF (MOD_IS_INSTALLED ~might_and_guile.tp2~ ~245~) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 20 parameter2 = 105 timing = 1 STR_VAR resource = ~d5csbar1~ END
  END
//rangers...
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 12 parameter2 = 105 timing = 1 STR_VAR resource = ~d5csran1~ END
//archers...
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 0x4007 parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csarc1~ END
  PATCH_IF (VARIABLE_IS_SET %d5_marksman_code%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %d5_marksman_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csarc1~ END
  END
  PATCH_IF (VARIABLE_IS_SET %d5_slinger_code%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %d5_slinger_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csarc1~ END
  END
  PATCH_IF (VARIABLE_IS_SET %d5_sniper_code%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %d5_sniper_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csarc1~ END
  END
  PATCH_IF (VARIABLE_IS_SET %ub_sh_code%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %ub_sh_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csarc1~ END
  END
  PATCH_IF (VARIABLE_IS_SET %a7_marksman_code%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %a7_marksman_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csarc1~ END
  END
  PATCH_IF (VARIABLE_IS_SET %a7_bowknight_code%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %a7_bowknight_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csarc1~ END
  END
  PATCH_IF (VARIABLE_IS_SET %a7_sharpshooter_code%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %a7_sharpshooter_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csarc1~ END
  END
  PATCH_IF (VARIABLE_IS_SET %cdarcsyl_code%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %cdarcsyl_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csarc1~ END
  END
  PATCH_IF (VARIABLE_IS_SET %c0aa_code%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %c0aa_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csarc1~ END
  END
  PATCH_IF (VARIABLE_IS_SET %c0advent_code%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %c0advent_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csarc1~ END
  END
  PATCH_IF (VARIABLE_IS_SET %usaf00_code%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %usaf00_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csarc1~ END
  END
  PATCH_IF (VARIABLE_IS_SET %usap00_code%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %usap00_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csarc1~ END
  END
  PATCH_IF (VARIABLE_IS_SET %usat00_code%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %usat00_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csarc1~ END
  END
  PATCH_IF (VARIABLE_IS_SET %d2warhound_code%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %d2warhound_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csarc1~ END
  END
  PATCH_IF (VARIABLE_IS_SET %elven_archer_code%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %elven_archer_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csarc1~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %elven_archer_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csear1~ END
  END
  PATCH_IF (VARIABLE_IS_SET %dr_bowslinger_code%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %dr_bowslinger_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csarc1~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %dr_bowslinger_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csear1~ END
  END
//swashy...
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 0x400c parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csswa1~ END
  PATCH_IF (VARIABLE_IS_SET %d5_corsair_code%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %d5_corsair_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csswa1~ END
  END
  PATCH_IF (VARIABLE_IS_SET %d5_swash_code%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %d5_corsair_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csswa1~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %d5_corsair_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csswa2~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %d5_corsair_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csswa3~ END
  END
//assassin...
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 0x400a parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csass1~ END
//shadowdancer...
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 0x4021 parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5csshd1~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 0x4021 parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5cix1a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 0x4021 parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5cix1a~ END
  PATCH_IF (VARIABLE_IS_SET %d5_shadowdancer_code%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %d5_shadowdancer_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5cssha1~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 0x4021 parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5cix1a~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 0x4021 parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5cix1a~ END
  END
//and then cast d5cs000...
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5cs000~ END


COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cshal1.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = 2 parameter2 = 109 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = 1 parameter2 = (101 + (0x10000 * 1)) timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cshal1~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csran1.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csf4l~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csm2l~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5csran1~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csarc1.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = 1 parameter2 = (105 + (0x10000 * 1)) timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5csarc1~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csear1.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = 1 parameter2 = (102 + (0x10000 * 1)) timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5csear1~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csbar1.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csf4l~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5csran1~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csswa1.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = 1 parameter2 = (105 + (0x10000 * 1)) timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5csswa1~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cswa2.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 318 target = 1 parameter1 = 2 parameter2 = %prof_113_beq% timing = 0 duration = 6 STR_VAR resource = ~d5cswa2~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = 1 parameter2 = (113 + (0x10000 * 1)) timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cshal1~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cswa3.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 318 target = 1 parameter1 = 2 parameter2 = %prof_114_beq% timing = 0 duration = 6 STR_VAR resource = ~d5cswa3~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = 1 parameter2 = (114 + (0x10000 * 1)) timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cshal1~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csass1.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = 1 parameter2 = (106 + (0x10000 * 1)) timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5csass1~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csshd1.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csi9l~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csix1z~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csix1z~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5cssha1~ END


//add stat bonus effect to every clab________________________________________________
//
// hmm... what about multiclasses? will they get bonuses applied twice? 
// ...could it  cause problems, even with op321? Not sure...
//
// no need for clabma01 because it is in kitlist.2da
ACTION_FOR_EACH trueclass IN ~clabba01~ ~clabdr01~ ~clabfi01~ ~clabma01~ ~clabmo01~ ~clabpa01~ ~clabpr01~ ~clabrn01~ ~clabsh01~ ~clabth01~ BEGIN
  ACTION_IF (FILE_EXISTS_IN_GAME ~%trueclass%.2da~) BEGIN
    COPY_EXISTING ~%trueclass%.2da~ ~override~
//        thief traps
    REPLACE_TEXTUALLY ~GA_SPCL412~ ~****      ~
    REPLACE_TEXTUALLY ~AP_D5CL412~ ~****      ~
    REPLACE_TEXTUALLY ~GA_SPCL414~ ~****      ~
    REPLACE_TEXTUALLY ~GA_SPCL151~ ~****      ~
    REPLACE_TEXTUALLY ~GA_SPCL922~ ~****      ~
    APPEND ~%trueclass%.2da~ ~SKILLS      AP_D5CS001  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5_CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  ~ UNLESS ~AP_D5CS000~
  END
END
COPY_EXISTING ~kitlist.2da~ ~override~
  COUNT_2DA_ROWS 9 "rows"
  FOR ( index = 2 ; index < rows ; index = index + 1 ) BEGIN
    READ_2DA_ENTRY %index% 5 9 modclab
    READ_2DA_ENTRY %index% 8 9 modclass
//    PATCH_IF (modclass = 1) OR (modclass = 2) OR (modclass = 3) OR (modclass = 4) OR (modclass = 5) OR (modclass = 6) OR (modclass = 11) OR (modclass = 12) OR (modclass = 19) OR (modclass = 20) OR (modclass = 21) BEGIN
      INNER_ACTION BEGIN
        ACTION_IF (FILE_EXISTS_IN_GAME ~%modclab%.2da~) BEGIN
          COPY_EXISTING ~%modclab%.2da~ ~override~
//        thief traps
          REPLACE_TEXTUALLY ~GA_SPCL412~ ~****      ~
          REPLACE_TEXTUALLY ~AP_D5CL412~ ~****      ~
          REPLACE_TEXTUALLY ~GA_SPCL414~ ~****      ~
//        swashy AC bonus
          REPLACE_TEXTUALLY ~AP_SPCL441~ ~****      ~
          REPLACE_TEXTUALLY ~AP_D5_ACBON~ ~****       ~
//        MnG shadowdancer
          REPLACE_TEXTUALLY ~GA_D5SHAD1~ ~****      ~
//        archer ranged bonus
          REPLACE_TEXTUALLY ~AP_SPCL122~ ~****      ~
          REPLACE_TEXTUALLY ~AP_D5MTHAC~ ~****      ~
          REPLACE_TEXTUALLY ~AP_C0AAIN2~ ~****      ~
          REPLACE_TEXTUALLY ~AP_C0ARC01~ ~****      ~
//        tracking
          REPLACE_TEXTUALLY ~GA_SPCL922~ ~****      ~
//        speed bonus/quickstride
          REPLACE_TEXTUALLY ~GA_SPCL151~ ~****      ~
/* why the checks?
          PATCH_IF (modclass = 1) OR (modclass = 12) BEGIN
            REPLACE_TEXTUALLY ~GA_SPCL151~ ~****      ~
          END
          PATCH_IF (modclass = 20) AND (MOD_IS_INSTALLED ~might_and_guile.tp2~ ~245~) BEGIN
            REPLACE_TEXTUALLY ~GA_SPCL151~ ~****      ~
          END          
*/
          APPEND ~%modclab%.2da~ ~SKILLS      AP_D5CS001  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5_CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  AP_D5CS000  ~ UNLESS ~AP_D5CS000~
        END
      END
//    END
  END
BUT_ONLY
//__________________________________________________________________________________



//__________________________________________________________________________________
//
//								HANDLE NPCS
//__________________________________________________________________________________


//proficiency dialogue_______________________________________________________________
//
INCLUDE ~%MOD_FOLDER%/lib/dialprof.tpa~

OUTER_SPRINT prof_script_name ~d5cspr~
OUTER_SET script_level_one = 1
OUTER_SET script_higher_levels = 1
OUTER_SPRINT class_dlgs ~all~

LAM PROF_DIALOGUE

//joinable NPCs______________________________________________________________________
//
// ***** joinable NPCs: zero out their existing  profs, and give them the dialprof ability
// just like NPC_EE
// wait that only knows 1st-level profs.2da values
// need to make an updated version that can calculate the amount for any given level
// use original version for level 1 profs, and make different innate & script for higher levels

LAM JOINABLE_NPC_ARRAYS

ACTION_PHP_EACH JOINABLE_NPC_ARRAY AS cre => dv BEGIN
// 	PRINT ~%cre% => %dv%~ 
	COPY_EXISTING ~%cre%~ ~override~
	  LPF FJ_CRE_EFF_V2 END
	BUT_ONLY
END

ACTION_PHP_EACH JOINABLE_NPC_ARRAY AS cre => dv BEGIN
	COPY_EXISTING ~%cre%~ ~override~
	  READ_LONG 0x2c4 eff_offset
	  READ_LONG 0x2c8 eff_number
	  WHILE (%eff_number% > 0) BEGIN
		SET eff_number = (%eff_number% - 1)
		READ_LONG (%eff_offset% + 0x08 + (0x108 * %eff_number%)) effect
		READ_SHORT (%eff_offset% + 0x18 + (0x108 * %eff_number%)) prof
		PATCH_IF (effect = 233) BEGIN
		  PATCH_IF (prof = 89) OR (prof = 90) OR (prof = 91) OR (prof = 92) OR (prof = 93) OR (prof = 94) OR (prof = 95) OR (prof = 96) OR (prof = 97) OR (prof = 98) OR (prof = 99) OR (prof = 100) OR (prof = 101) OR (prof = 102) OR (prof = 103) OR (prof = 104) OR (prof = 105) OR (prof = 106) OR (prof = 107) OR (prof = 111) OR (prof = 112) OR (prof = 113) OR (prof = 114) OR (prof = 115) BEGIN
		    WRITE_LONG (%eff_offset% + 0x88 + (0x108 * %eff_number%)) 1
		    WRITE_ASCII (%eff_offset% + 0x8c + (0x108 * %eff_number%)) ~D5PROFZ~ #8
		  END
		END
	  END
	BUT_ONLY
END

/* add this stuff directly to d5cpra.spl
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5prfch.spl~) BEGIN
  COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5prfch.spl~
    LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5profz~ END
//    LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 4 duration = 1 STR_VAR resource = ~d5profz~ END
    PATCH_FOR_EACH d5_prof_level IN ~p~ ~s~ ~m~ ~h~ BEGIN
      PATCH_FOR_EACH d5_prof_wep IN ~lswo~ ~sswo~ ~dagg~ ~scim~ ~2swo~ ~spea~ ~staf~ ~club~ ~flai~ ~hamm~ ~baxe~ ~bows~ ~slin~ ~xbow~ ~s2hw~ ~ssws~ ~ssns~ ~sdw~ BEGIN
        LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5%d5_prof_level%%d5_prof_wep%~ END
      END
    END
    PATCH_FOR_EACH d5_prof_level IN ~1~ ~2~ ~3~ ~4~ ~5~ BEGIN
      PATCH_FOR_EACH d5_prof_wep IN ~lswo~ ~sswo~ ~dagg~ ~scim~ ~2swo~ ~spea~ ~staf~ ~club~ ~flai~ ~hamm~ ~baxe~ ~bows~ ~slin~ ~xbow~ ~s2hw~ ~ssws~ ~ssns~ ~sdw~ BEGIN
        LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5%d5_prof_level%%d5_prof_wep%~ END
      END
    END
    PATCH_FOR_EACH d5_prof_level IN ~1~ ~2~ ~3~ ~4~ ~5~ ~6~ BEGIN
      PATCH_FOR_EACH d5_prof_wep IN ~89~ ~90~ ~91~ ~92~ ~93~ ~94~ ~95~ ~96~ ~97~ ~98~ ~99~ ~100~ ~101~ ~102~ ~103~ ~104~ ~105~ ~106~ ~107~ ~108~ ~109~ ~111~ ~112~ ~113~ ~114~ ~115~ ~124~ ~127~ ~110~ BEGIN
        LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5%d5_prof_level%P%d5_prof_wep%~ END
      END
    END
// should also remove any proficiency-related effects... e.g. from SoB CSP
    PATCH_FOR_EACH d5_csp_letr IN ~a~ ~b~ ~c~ ~d~ ~e~ ~f~ ~g~ ~h~ ~i~ BEGIN
      PATCH_FOR_EACH d5_csp_stat IN ~104~ ~105~ ~106~ ~107~ ~108~ ~109~ BEGIN
        LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5cs%d5_csp_stat%%d5_csp_letr%b~ END
      END
    END
    PATCH_FOR_EACH d5_csp_letr IN ~a~ ~b~ ~c~ ~d~ ~e~ ~f~ ~g~ ~h~ ~i~ BEGIN
      PATCH_FOR_EACH d5_csp_stat IN ~115~ ~124~ ~127~ ~110~ BEGIN
        LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 172 timing = 1 STR_VAR resource = EVAL ~d5c%d5_csp_stat%%d5_csp_letr%~ END
      END
    END
    LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 172 timing = 1 STR_VAR resource = EVAL ~d5c%d5_csp_stat%%d5_csp_letr%~ END

    LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = EVAL ~d5cx115~ END
    PATCH_FOR_EACH d5_csp_num IN ~1~ ~2~ ~3~ ~4~ ~5~ ~6~ ~7~ ~8~ ~9~ BEGIN
      PATCH_FOR_EACH d5_csp_dlg IN ~f~ ~m~ ~i~ BEGIN
        LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5cs%d5_csp_dlg%%d5_csp_num%~ END
      END
      LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = EVAL ~d5csi%d5_csp_num%i~ END
      LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5csi%d5_csp_num%b~ END
      LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5csi%d5_csp_num%g~ END
      LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = EVAL ~d5csp%d5_csp_num%~ END
      LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5csp%d5_csp_num%a~ END
      LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5cxp%d5_csp_num%b~ END
      LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5cxp%d5_csp_num%l~ END
    END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5cilts~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5ciltz~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5ciltf~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5cix1a~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5cix1z~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5cix-1~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5cistt~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5ci000~ END
END
*/

COPY_EXISTING ~d5cspra.spl~ ~override~
  SAY NAME1 @12198
  SAY UNIDENTIFIED_DESC @12198
//  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5prfch~ END
    PATCH_FOR_EACH d5_prof_level IN ~p~ ~s~ ~m~ ~h~ BEGIN
      PATCH_FOR_EACH d5_prof_wep IN ~lswo~ ~sswo~ ~dagg~ ~scim~ ~2swo~ ~spea~ ~staf~ ~club~ ~flai~ ~hamm~ ~baxe~ ~bows~ ~slin~ ~xbow~ ~s2hw~ ~ssws~ ~ssns~ ~sdw~ BEGIN
        LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5%d5_prof_level%%d5_prof_wep%~ END
      END
    END
    PATCH_FOR_EACH d5_prof_level IN ~1~ ~2~ ~3~ ~4~ ~5~ BEGIN
      PATCH_FOR_EACH d5_prof_wep IN ~lswo~ ~sswo~ ~dagg~ ~scim~ ~2swo~ ~spea~ ~staf~ ~club~ ~flai~ ~hamm~ ~baxe~ ~bows~ ~slin~ ~xbow~ ~s2hw~ ~ssws~ ~ssns~ ~sdw~ BEGIN
        LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5%d5_prof_level%%d5_prof_wep%~ END
      END
    END
    PATCH_FOR_EACH d5_prof_level IN ~1~ ~2~ ~3~ ~4~ ~5~ ~6~ BEGIN
      PATCH_FOR_EACH d5_prof_wep IN ~89~ ~90~ ~91~ ~92~ ~93~ ~94~ ~95~ ~96~ ~97~ ~98~ ~99~ ~100~ ~101~ ~102~ ~103~ ~104~ ~105~ ~106~ ~107~ ~108~ ~109~ ~111~ ~112~ ~113~ ~114~ ~115~ ~124~ ~127~ ~110~ BEGIN
        LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5%d5_prof_level%P%d5_prof_wep%~ END
      END
    END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5profz~ END
/* don't really need this stuff vv ... but it would harmonize this with NPC_EE's d5prfch.spl
    PATCH_FOR_EACH d5_csp_letr IN ~a~ ~b~ ~c~ ~d~ ~e~ ~f~ ~g~ ~h~ ~i~ BEGIN
      PATCH_FOR_EACH d5_csp_stat IN ~104~ ~105~ ~106~ ~107~ ~108~ ~109~ BEGIN
        LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5cs%d5_csp_stat%%d5_csp_letr%b~ END
      END
    END
    PATCH_FOR_EACH d5_csp_letr IN ~a~ ~b~ ~c~ ~d~ ~e~ ~f~ ~g~ ~h~ ~i~ BEGIN
      PATCH_FOR_EACH d5_csp_stat IN ~115~ ~124~ ~127~ ~110~ BEGIN
        LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 172 target = 1 timing = 1 STR_VAR resource = EVAL ~d5c%d5_csp_stat%%d5_csp_letr%~ END
      END
    END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = EVAL ~d5cx115~ END
    PATCH_FOR_EACH d5_csp_num IN ~1~ ~2~ ~3~ ~4~ ~5~ ~6~ ~7~ ~8~ ~9~ BEGIN
      PATCH_FOR_EACH d5_csp_dlg IN ~f~ ~m~ ~i~ BEGIN
        LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5cs%d5_csp_dlg%%d5_csp_num%~ END
      END
      LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 172 target = 1 timing = 1 STR_VAR resource = EVAL ~d5csi%d5_csp_num%i~ END
      LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5csi%d5_csp_num%b~ END
      LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5csi%d5_csp_num%g~ END
      LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 172 target = 1 timing = 1 STR_VAR resource = EVAL ~d5csp%d5_csp_num%~ END
      LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5csp%d5_csp_num%a~ END
      LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5cxp%d5_csp_num%b~ END
      LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5cxp%d5_csp_num%l~ END
    END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5cilts~ END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5ciltz~ END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5ciltf~ END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5cix1a~ END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5cix1z~ END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5cix-1~ END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5cistt~ END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = EVAL ~d5ci000~ END
*/
IF_EXISTS BUT_ONLY

/*
COPY_EXISTING ~d5cs000.spl~ ~override~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 6 STR_VAR resource = ~d5csprx~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csprx~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csprx.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = ~d5cspra~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5csprx~ END

ACTION_PHP_EACH JOINABLE_NPC_ARRAY AS cre => dv BEGIN
  COPY_EXISTING ~%cre%~ ~override~
    LPF ADD_CRE_EFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~d5cspra~ END
  BUT_ONLY
END
*/

COPY ~%MOD_FOLDER%/csp/d5cspra.itm~ ~override~
  SAY NAME1 @12198
  SAY NAME2 @12198
  SAY UNIDENTIFIED_DESC @12199
  SAY IDENTIFIED_DESC @12199
LAF ~ADD_ITEM_TOOLTIPS~ STR_VAR item = ~d5_ckit~ tooltips = ~@12198~ END

ACTION_PHP_EACH JOINABLE_NPC_ARRAY AS cre => dv BEGIN
  COPY_EXISTING ~%cre%~ ~override~
	PATCH_IF (SOURCE_SIZE > 0x2d3) BEGIN
	  ADD_CRE_ITEM ~d5cspra~ #1 #0 #0 ~IDENTIFIED~ ~INV~
	END
  BUT_ONLY
END

COPY_EXISTING ~d5cspr.bcs~ ~override~
  DECOMPILE_AND_PATCH BEGIN
    REPLACE_TEXTUALLY ~DestroySelf()~
~ActionOverride(LastSummonerOf(Myself),ApplySpellRES("D5CS000",myself))
    DestroySelf()~
  END
BUT_ONLY


//non-joinable NPCs__________________________________________________________________
//
// ***** non-joinable NPCs: check their class and level 
// ...and just give them some random non-weapon skills - passives only!
// check MnG for template

/*
passive feats:
dodge
backstab
// d5csp1 = leadership
// d5csp2 = grappling
// d5csp3 = precise strike
// d5csp4 = parry slashing
// d5csp5 = parry piercing
// d5csp6 = parry blunt
// d5csp7 = missile snaring
// d5csp8 = fighting dirty
// d5csp9 = spell evasion
// d5csf1 = health
// d5csf2 = toughness
// d5csf3 = resistance
// d5csf4 = quickstride (applied)
// d5csf5 = fortitude
// d5csf6 = determination
// d5csf7 = STR training
// d5csf8 = DEX training
// d5csm3 = flaming weapon (applied)
// d5csm5 = escape artist
// d5csm6 = slippery mind
// d5csm7 = luck

give enemies... 4 feats? 
warriors 1: luck		parryslash		parryblunt  	parrypierce		toughness
warriors 2: dodge		grappling		health			determination	...dodge?
warriors 3: precise 	dodge			resistance		STR				fortitude
warriors 4: dirty		missilesnare	quickstride		DEX				flaming weapon

rogues 1:  dodge		parryslash		parrypierce		parryblunt
rogues 2:  precise		dodge			health			backstab
rogues 3:  dirty		missilesnare	DEX				quickstride
rogues 4:  evasion		escapeartist	slipperymind	luck
*/

// ***** need to make a perm clone of flaming sword "d5csm3pm"
COPY_EXISTING ~d5csm3.spl~ ~override/d5csm3pm.spl~
  LPF ALTER_EFFECT INT_VAR silent = 1 timing = 1 END

ACTION_PHP_EACH NON_JOINABLE_NPC_ARRAY AS cre => dv BEGIN
//  PRINT ~%cre% => %dv%~ 
  COPY_EXISTING ~%cre%~ ~override~
	PATCH_IF (SOURCE_SIZE > 0x2d3) BEGIN
	  READ_BYTE 0x234 level
	  READ_BYTE 0x273 npc_class
	  PATCH_IF (npc_class = 4) OR (npc_class = 6) OR (npc_class = 12) OR (npc_class = 7) OR (npc_class = 8) OR (npc_class = 16) OR (npc_class = 17) OR (npc_class = 18) BEGIN
		SET random_num1 = RANDOM (1 5)
		PATCH_IF (%random_num1% = 1) BEGIN
		  LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csm7~ END
		END
		PATCH_IF (%random_num1% = 2) BEGIN
		  LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp4a~ END
		END
		PATCH_IF (%random_num1% = 3) BEGIN
		  LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp5a~ END
		END
		PATCH_IF (%random_num1% = 4) BEGIN
		  LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp6a~ END
		END
		PATCH_IF (%random_num1% = 5) BEGIN
		  LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csf2~ END
		END
		SET random_num2 = RANDOM (1 5)
		PATCH_IF (%random_num2% = 1) BEGIN
		  LPF ADD_CRE_EFFECT INT_VAR opcode = 0 target = 1 parameter1 = 1 parameter2 = 0 timing = 0 duration = 126144000 END
		END
		PATCH_IF (%random_num2% = 2) BEGIN
		  LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp2a~ END
		END
		PATCH_IF (%random_num2% = 3) BEGIN
		  LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csf1~ END
		END
		PATCH_IF (%random_num2% = 4) BEGIN
//		  LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csf6~ END
		  LPF ADD_CRE_EFFECT INT_VAR opcode = 328 target = 1 parameter2 = %stun_evasion_state% timing = 1 special = 1 END
		END
		PATCH_IF (%random_num2% = 5) BEGIN
		  LPF ADD_CRE_EFFECT INT_VAR opcode = 0 target = 1 parameter1 = 1 parameter2 = 0 timing = 0 duration = 126144000 END
		END
		PATCH_IF (level > 4) BEGIN
		  SET random_num3 = RANDOM (1 5)
		  PATCH_IF (%random_num3% = 1) BEGIN
		    LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp3a~ END
		  END
		  PATCH_IF (%random_num3% = 2) BEGIN
		    LPF ADD_CRE_EFFECT INT_VAR opcode = 0 target = 1 parameter1 = 1 parameter2 = 0 timing = 0 duration = 126144000 END
		  END
		  PATCH_IF (%random_num3% = 3) BEGIN
		    LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csf3~ END
		  END
		  PATCH_IF (%random_num3% = 4) BEGIN
		    LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csf7~ END
		  END
		  PATCH_IF (%random_num3% = 5) BEGIN
//		    LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csf5~ END
		    LPF ADD_CRE_EFFECT INT_VAR opcode = 328 target = 1 parameter2 = %poison_evasion_state% timing = 1 special = 1 END
		  END
		END
		PATCH_IF (level > 7) BEGIN
		  SET random_num4 = RANDOM (1 5)
		  PATCH_IF (%random_num4% = 1) BEGIN
		    LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp8a~ END
		  END
		  PATCH_IF (%random_num4% = 2) BEGIN
		    LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp7a~ END
		  END
		  PATCH_IF (%random_num4% = 3) BEGIN
		    LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5strid~ END
		  END
		  PATCH_IF (%random_num4% = 4) BEGIN
		    LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csf8~ END
		  END
		  PATCH_IF (%random_num4% = 5) BEGIN
		    LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csm3pm~ END
		  END
          PATCH_IF (level < 12) BEGIN
            LPF ADD_CRE_EFFECT INT_VAR target = 1 opcode = 1 parameter1 = 6 parameter2 = 0 timing = 9 END
          END
		END
	  END
      PATCH_IF (level > 11) BEGIN
        LPF ADD_CRE_EFFECT INT_VAR target = 1 opcode = 1 parameter1 = 1 parameter2 = 0 timing = 9 END
      END
	  PATCH_IF (npc_class = 4) OR (npc_class = 9) OR (npc_class = 10) OR (npc_class = 13) OR (npc_class = 15) BEGIN
		SET random_num1 = RANDOM (1 4)
		PATCH_IF (%random_num1% = 1) BEGIN
		  LPF ADD_CRE_EFFECT INT_VAR opcode = 0 target = 1 parameter1 = 1 parameter2 = 0 timing = 0 duration = 126144000 END
		END
		PATCH_IF (%random_num1% = 2) BEGIN
		  LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp4a~ END
		END
		PATCH_IF (%random_num1% = 3) BEGIN
		  LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp5a~ END
		END
		PATCH_IF (%random_num1% = 4) BEGIN
		  LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp6a~ END
		END
		SET random_num2 = RANDOM (1 4)
		PATCH_IF (%random_num2% = 1) BEGIN
		  LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp3a~ END
		END
		PATCH_IF (%random_num2% = 2) BEGIN
		  LPF ADD_CRE_EFFECT INT_VAR opcode = 0 target = 1 parameter1 = 1 parameter2 = 0 timing = 0 duration = 126144000 END
		END
		PATCH_IF (%random_num2% = 3) BEGIN
		  LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csf1~ END
		END
		PATCH_IF (%random_num2% = 4) BEGIN
	      LPF ADD_CRE_EFFECT INT_VAR target = 1 opcode = 263 parameter1 = 1 parameter2 = 0 timing = 9 END
		END
		PATCH_IF (level > 4) BEGIN
		  SET random_num3 = RANDOM (1 4)
		  PATCH_IF (%random_num3% = 1) BEGIN
		    LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp8a~ END
		  END
		  PATCH_IF (%random_num3% = 2) BEGIN
		    LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp7a~ END
		  END
		  PATCH_IF (%random_num3% = 3) BEGIN
		    LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csf8~ END
		  END
		  PATCH_IF (%random_num3% = 4) BEGIN
		    LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5strid~ END
		  END
		END
		PATCH_IF (level > 7) BEGIN
		  SET random_num4 = RANDOM (1 4)
		  PATCH_IF (%random_num4% = 1) BEGIN
		    LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp9a~ END
		  END
		  PATCH_IF (%random_num4% = 2) BEGIN
		    LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csm5~ END
		  END
		  PATCH_IF (%random_num4% = 3) BEGIN
//		    LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csm6~ END
		    LPF ADD_CRE_EFFECT INT_VAR opcode = 328 target = 1 parameter2 = %charm_evasion_state% timing = 1 special = 1 END
		  END
		  PATCH_IF (%random_num4% = 4) BEGIN
		    LPF ADD_CRE_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csm7~ END
		  END
		END
        PATCH_IF (level > 11) BEGIN
          LPF ADD_CRE_EFFECT INT_VAR target = 1 opcode = 1 parameter1 = 6 parameter2 = 0 timing = 9 END
        END
	  END
	END
  BUT_ONLY
END
//__________________________________________________________________________________



//__________________________________________________________________________________
//
//								OTHER MODS
//__________________________________________________________________________________


//MnG Bladesinger focus weapon_______________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5_blads.2da~) BEGIN

  COPY_EXISTING ~kit.ids~ ~override~
    COUNT_2DA_COLS cols
    READ_2DA_ENTRIES_NOW rows cols
    FOR (row = 1; row < rows; ++row) BEGIN
      READ_2DA_ENTRY_FORMER rows row 0 ~code~
      READ_2DA_ENTRY_FORMER rows row 1 ~kit~
      PATCH_IF (~%kit%~ STRING_EQUAL_CASE ~D5_BLADESINGER~) BEGIN
        SET nu_bladesinger_code = %code%
      END
    END  
  BUT_ONLY

  COPY_EXISTING ~d5_blads.2da~ ~override~
	REPLACE_TEXTUALLY ~GA_D5BSWPF~ ~AP_D5BSFO1~
	REPLACE_TEXTUALLY ~GA_D5FTPRX~ ~AP_D5BSFO1~
  BUT_ONLY

  OUTER_SPRINT prof_script_name ~d5bsfo~
  OUTER_SET script_level_one = 0
  OUTER_SET script_higher_levels = 0
  OUTER_SPRINT class_dlgs ~fi_ma~

  LAM PROF_DIALOGUE
  
  COPY_EXISTING ~d5bsfo1.spl~ ~override~
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = ~d5bsfo1~ END
  IF_EXISTS BUT_ONLY

  COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
    PATCH_FOR_EACH focus_effect IN ~BS89~ ~BS90~ ~BS91~ ~BS92~ ~BS93~ ~BS94~ ~BS95~ ~BS96~ ~BS97~ ~BS98~ ~BS99~ ~BS100~ ~BS101~ ~BS102~ ~BS115~ BEGIN
      LPF DELETE_EFFECT INT_VAR match_opcode = 177 match_paramater1 = %nu_bladesinger_code% match_parameter2 = 9 STR_VAR match_resource = EVAL ~d5%focus_effect%b~ END
    END
  BUT_ONLY

  COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
   PATCH_IF (SOURCE_SIZE > 0x71) BEGIN
	READ_BYTE 0x31 proficiency
	PATCH_IF (proficiency = 89) BEGIN
	  LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 177 target = 1 parameter1 = %nu_bladesinger_code% parameter2 = 9 timing = 2 STR_VAR resource = ~d5bs89b~ END
	END
	PATCH_IF (proficiency = 90) BEGIN
	  LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 177 target = 1 parameter1 = %nu_bladesinger_code% parameter2 = 9 timing = 2 STR_VAR resource = ~d5bs90b~ END
	END
	PATCH_IF (proficiency = 91) BEGIN
	  LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 177 target = 1 parameter1 = %nu_bladesinger_code% parameter2 = 9 timing = 2 STR_VAR resource = ~d5bs91b~ END
	END
	PATCH_IF (proficiency = 92) BEGIN
	  LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 177 target = 1 parameter1 = %nu_bladesinger_code% parameter2 = 9 timing = 2 STR_VAR resource = ~d5bs92b~ END
	END
	PATCH_IF (proficiency = 93) BEGIN
	  LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 177 target = 1 parameter1 = %nu_bladesinger_code% parameter2 = 9 timing = 2 STR_VAR resource = ~d5bs93b~ END
	END
	PATCH_IF (proficiency = 94) BEGIN
	  LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 177 target = 1 parameter1 = %nu_bladesinger_code% parameter2 = 9 timing = 2 STR_VAR resource = ~d5bs94b~ END
	END
	PATCH_IF (proficiency = 95) BEGIN
	  LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 177 target = 1 parameter1 = %nu_bladesinger_code% parameter2 = 9 timing = 2 STR_VAR resource = ~d5bs95b~ END
	END
	PATCH_IF (proficiency = 96) BEGIN
	  LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 177 target = 1 parameter1 = %nu_bladesinger_code% parameter2 = 9 timing = 2 STR_VAR resource = ~d5bs96b~ END
	END
	PATCH_IF (proficiency = 97) BEGIN
	  LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 177 target = 1 parameter1 = %nu_bladesinger_code% parameter2 = 9 timing = 2 STR_VAR resource = ~d5bs97b~ END
	END
	PATCH_IF (proficiency = 98) BEGIN
	  LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 177 target = 1 parameter1 = %nu_bladesinger_code% parameter2 = 9 timing = 2 STR_VAR resource = ~d5bs98b~ END
	END
	PATCH_IF (proficiency = 99) BEGIN
	  LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 177 target = 1 parameter1 = %nu_bladesinger_code% parameter2 = 9 timing = 2 STR_VAR resource = ~d5bs99b~ END
	END
	PATCH_IF (proficiency = 100) BEGIN
	  LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 177 target = 1 parameter1 = %nu_bladesinger_code% parameter2 = 9 timing = 2 STR_VAR resource = ~d5bs100b~ END
	END
	PATCH_IF (proficiency = 101) BEGIN
	  LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 177 target = 1 parameter1 = %nu_bladesinger_code% parameter2 = 9 timing = 2 STR_VAR resource = ~d5bs101b~ END
	END
	PATCH_IF (proficiency = 102) BEGIN
	  LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 177 target = 1 parameter1 = %nu_bladesinger_code% parameter2 = 9 timing = 2 STR_VAR resource = ~d5bs102b~ END
	END
   END
  BUT_ONLY

  ACTION_FOR_EACH class_dlg IN ~fi~ ~ma~ BEGIN
   COPY_EXISTING ~d5bsfo%class_dlg%.dlg~ ~override~
    DECOMPILE_AND_PATCH BEGIN
      REPLACE_TEXTUALLY ~ApplySpellRES("D52P~ ~ApplySpellRES("D52B~
      REPLACE_TEXTUALLY ~ApplySpellRES("D53P~ ~ApplySpellRES("D53B~
      REPLACE_TEXTUALLY ~ApplySpellRES("D54P~ ~ApplySpellRES("D54B~
      REPLACE_TEXTUALLY ~ApplySpellRES("D55P~ ~ApplySpellRES("D55B~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_101","LOCALS",[012345]~ ~GlobalGT("D5_PROF_101","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_102","LOCALS",[012345]~ ~GlobalGT("D5_PROF_102","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_103","LOCALS",[012345]~ ~GlobalGT("D5_PROF_103","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_104","LOCALS",[012345]~ ~GlobalGT("D5_PROF_104","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_105","LOCALS",[012345]~ ~GlobalGT("D5_PROF_105","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_106","LOCALS",[012345]~ ~GlobalGT("D5_PROF_106","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_107","LOCALS",[012345]~ ~GlobalGT("D5_PROF_107","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_108","LOCALS",[012345]~ ~GlobalGT("D5_PROF_108","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_109","LOCALS",[012345]~ ~GlobalGT("D5_PROF_109","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_111","LOCALS",[012345]~ ~GlobalGT("D5_PROF_111","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_112","LOCALS",[012345]~ ~GlobalGT("D5_PROF_112","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_113","LOCALS",[012345]~ ~GlobalGT("D5_PROF_113","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_114","LOCALS",[012345]~ ~GlobalGT("D5_PROF_114","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_115","LOCALS",[012345]~ ~GlobalGT("D5_PROF_115","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_124","LOCALS",[012345]~ ~GlobalGT("D5_PROF_124","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_127","LOCALS",[012345]~ ~GlobalGT("D5_PROF_127","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_110","LOCALS",[012345]~ ~GlobalGT("D5_PROF_110","LOCALS",99~
      REPLACE_TEXTUALLY ~CheckStatGT(myself,9,LEVEL)~ ~CheckStatGT(myself,8,LEVEL)~
      REPLACE_TEXTUALLY ~"LOCALS",2) Proficiency(Myself~ ~"LOCALS",1) Proficiency(Myself~
      REPLACE_TEXTUALLY ~"LOCALS",3) Proficiency(Myself~ ~"LOCALS",2) Proficiency(Myself~
      REPLACE_TEXTUALLY ~"LOCALS",4) Proficiency(Myself~ ~"LOCALS",3) Proficiency(Myself~
      REPLACE_TEXTUALLY ~"LOCALS",5) Proficiency(Myself~ ~"LOCALS",4) Proficiency(Myself~
    END
   IF_EXISTS BUT_ONLY
  END

END	//	end if bladesinger installed

//__________________________________________________________________________________


//FnP zealot weapon mastery_________________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5pazwpa.dlg~) BEGIN	//	paladin archetype zealot weapon mastery

  ACTION_IF FILE_EXISTS "override/d5pazwpa.dlg" BEGIN
    DELETE "override/d5pazwpa.dlg"
  END

  OUTER_SPRINT prof_script_name ~d5pazw~
  OUTER_SET script_level_one = 0
  OUTER_SET script_higher_levels = 0
  OUTER_SPRINT class_dlgs ~pa~

  LAM PROF_DIALOGUE

  COPY_EXISTING ~d5pazwpa.dlg~ ~override~
    DECOMPILE_AND_PATCH BEGIN
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_101","LOCALS",[012345]~ ~GlobalGT("D5_PROF_101","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_102","LOCALS",[012345]~ ~GlobalGT("D5_PROF_102","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_103","LOCALS",[012345]~ ~GlobalGT("D5_PROF_103","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_104","LOCALS",[012345]~ ~GlobalGT("D5_PROF_104","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_105","LOCALS",[012345]~ ~GlobalGT("D5_PROF_105","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_106","LOCALS",[012345]~ ~GlobalGT("D5_PROF_106","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_107","LOCALS",[012345]~ ~GlobalGT("D5_PROF_107","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_108","LOCALS",[012345]~ ~GlobalGT("D5_PROF_108","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_109","LOCALS",[012345]~ ~GlobalGT("D5_PROF_109","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_111","LOCALS",[012345]~ ~GlobalGT("D5_PROF_111","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_112","LOCALS",[012345]~ ~GlobalGT("D5_PROF_112","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_113","LOCALS",[012345]~ ~GlobalGT("D5_PROF_113","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_114","LOCALS",[012345]~ ~GlobalGT("D5_PROF_114","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_115","LOCALS",[012345]~ ~GlobalGT("D5_PROF_115","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_124","LOCALS",[012345]~ ~GlobalGT("D5_PROF_124","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_127","LOCALS",[012345]~ ~GlobalGT("D5_PROF_127","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_110","LOCALS",[012345]~ ~GlobalGT("D5_PROF_110","LOCALS",99~
      REPLACE_TEXTUALLY ~"LOCALS",2) Proficiency(Myself~ ~"LOCALS",1) Proficiency(Myself~
      REPLACE_TEXTUALLY ~"LOCALS",3) Proficiency(Myself~ ~"LOCALS",2) Proficiency(Myself~
      REPLACE_TEXTUALLY ~"LOCALS",4) Proficiency(Myself~ ~"LOCALS",3) Proficiency(Myself~
      REPLACE_TEXTUALLY ~"LOCALS",5) Proficiency(Myself~ ~"LOCALS",4) Proficiency(Myself~
    END
  IF_EXISTS BUT_ONLY

END	//	end if paladin archetypes installed

//__________________________________________________________________________________

/* this may not be necessary at all
//MnG samurai weapon mastery_________________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5kifofi.dlg~) BEGIN	//	paladin archetype zealot weapon mastery

/* no need to re-do it, just patch the .dlg
  ACTION_IF FILE_EXISTS "override/d5kifofi.dlg" BEGIN
    DELETE "override/d5kifofi.dlg"
  END

  OUTER_SPRINT prof_script_name ~d5kifo~
  OUTER_SET script_level_one = 0
  OUTER_SET script_higher_levels = 0
  OUTER_SPRINT class_dlgs ~fi~

  LAM PROF_DIALOGUE
*/

  COPY_EXISTING ~d5kifofi.dlg~ ~override~
    DECOMPILE_AND_PATCH BEGIN
/* this doesn't work, the numbers change when compiled
      REPLACE_TEXTUALLY ~GOTO d5kifofi_2~ ~GOTO d5kifofi_4~
      REPLACE_TEXTUALLY ~GOTO d5kifofi_3~ ~GOTO d5kifofi_4~
      REPLACE_TEXTUALLY ~GOTO d5kifofi_5~ ~GOTO d5kifofi_4~
*/
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_101","LOCALS",[012345]~ ~GlobalGT("D5_PROF_101","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_102","LOCALS",[012345]~ ~GlobalGT("D5_PROF_102","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_103","LOCALS",[012345]~ ~GlobalGT("D5_PROF_103","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_104","LOCALS",[012345]~ ~GlobalGT("D5_PROF_104","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_105","LOCALS",[012345]~ ~GlobalGT("D5_PROF_105","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_106","LOCALS",[012345]~ ~GlobalGT("D5_PROF_106","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_107","LOCALS",[012345]~ ~GlobalGT("D5_PROF_107","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_108","LOCALS",[012345]~ ~GlobalGT("D5_PROF_108","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_109","LOCALS",[012345]~ ~GlobalGT("D5_PROF_109","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_111","LOCALS",[012345]~ ~GlobalGT("D5_PROF_111","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_112","LOCALS",[012345]~ ~GlobalGT("D5_PROF_112","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_113","LOCALS",[012345]~ ~GlobalGT("D5_PROF_113","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_114","LOCALS",[012345]~ ~GlobalGT("D5_PROF_114","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_115","LOCALS",[012345]~ ~GlobalGT("D5_PROF_115","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_124","LOCALS",[012345]~ ~GlobalGT("D5_PROF_124","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_127","LOCALS",[012345]~ ~GlobalGT("D5_PROF_127","LOCALS",99~
      REPLACE_TEXTUALLY ~GlobalGT("D5_PROF_110","LOCALS",[012345]~ ~GlobalGT("D5_PROF_110","LOCALS",99~
    END
  IF_EXISTS BUT_ONLY

END	//	end if paladin archetypes installed

//__________________________________________________________________________________
*/


END // end function